# UML Диаграммы: Регистрация пользователя

## Функция 1: Регистрация пользователя

### 1. Use Case Diagram (Диаграмма вариантов использования)

![Use Case - Registration](../../img/img6.png)

**Актёры:**
- **Пациент** (Patient)
- **Администратор** (Administrator)
- **Email Service** (система)

**Варианты использования:**
1. **Регистрация в системе**
   - Первичный актёр: Пациент
   - Предусловия: Нет
   - Постусловия: Пациент зарегистрирован, письмо отправлено
   
2. **Подтверждение email**
   - Первичный актёр: Пациент
   - Предусловия: Регистрация завершена
   - Постусловия: Аккаунт активирован
   
3. **Управление ролями**
   - Первичный актёр: Администратор
   - Предусловия: Администратор аутентифицирован
   - Постусловия: Роли пользователя обновлены

**Связи:**
- `<<include>>`: Регистрация включает валидацию данных
- `<<extend>>`: Подтверждение email расширяет регистрацию

---

### 2. Activity Diagram (Диаграмма активностей)

**Описание процесса регистрации:**

```
[Начало]
    ↓
[Пациент открывает форму регистрации]
    ↓
[Ввод email и пароля]
    ↓
<Валидация email> ◇
    ├─ Невалидный → [Показать ошибку] → [Ввод email и пароля]
    └─ Валидный ↓
[Проверка уникальности email в БД]
    ↓
<Email существует?> ◇
    ├─ Да → [Показать "Email уже зарегистрирован"] → [Конец]
    └─ Нет ↓
[Хеширование пароля (BCrypt)]
    ↓
[Сохранение в PostgreSQL]
    ↓
[Генерация токена активации]
    ↓
[Отправка письма с токеном]
    ↓
[Показать "Проверьте email"]
    ↓
[Конец]
```

**Элементы:**
- **Начальная точка:** Круг с заливкой
- **Активности:** Прямоугольники со скруглёнными углами
- **Условия:** Ромб (decision node)
- **Конечная точка:** Круг с кругом внутри

---

### 3. Sequence Diagram (Диаграмма последовательности)

**Участники:**
- Patient (Пациент)
- WebUI (React)
- AuthController (Spring Boot)
- UserRepository (JPA)
- PostgreSQL (БД)
- EmailService (Spring Mail)

**Последовательность взаимодействия:**

```
Patient         WebUI         AuthController    UserRepository    PostgreSQL    EmailService
   |              |                  |                |              |               |
   |--POST /register---------------->|                |              |               |
   |   (email, password)              |                |              |               |
   |              |                   |                |              |               |
   |              |     validateEmail()|                |              |               |
   |              |<------------------|                |              |               |
   |              |        OK          |                |              |               |
   |              |                   |                |              |               |
   |              |                   |---checkExists(email)--------->|               |
   |              |                   |                |              |               |
   |              |                   |                |--SELECT----->|               |
   |              |                   |                |<--NULL-------|               |
   |              |                   |<---false-------|              |               |
   |              |                   |                |              |               |
   |              |                   |---hashPassword()|              |               |
   |              |                   |<---hash--------|              |               |
   |              |                   |                |              |               |
   |              |                   |---save(user)------------------>|               |
   |              |                   |                |--INSERT----->|               |
   |              |                   |                |<--OK---------|               |
   |              |                   |<---user--------|              |               |
   |              |                   |                |              |               |
   |              |                   |---sendActivationEmail(user)------------------>|
   |              |                   |                |              |  SMTP         |
   |              |                   |<---------------OK-------------|               |
   |              |                   |                |              |               |
   |              |<---200 OK---------|                |              |               |
   |              |   {message: "Check email"}         |              |               |
   |<-------------|                   |                |              |               |
```

**Ключевые сообщения:**
- Синхронные вызовы: сплошная линия со стрелкой
- Возвраты: пунктирная линия
- Активация: вертикальный прямоугольник на lifeline

---

### 4. Class Diagram (Диаграмма классов)

```
┌─────────────────────────────┐
│        User                 │
├─────────────────────────────┤
│ - id: Long                  │
│ - email: String             │
│ - passwordHash: String      │
│ - isActivated: Boolean      │
│ - activationToken: String   │
│ - createdAt: Timestamp      │
│ - role: Role                │
├─────────────────────────────┤
│ + getId(): Long             │
│ + getEmail(): String        │
│ + setEmail(email: String)   │
│ + isActivated(): Boolean    │
│ + activate(): void          │
└─────────────────────────────┘
           △
           │ uses
           │
┌─────────────────────────────┐         ┌─────────────────────────────┐
│   AuthController            │────────>│   AuthService               │
├─────────────────────────────┤         ├─────────────────────────────┤
│ - authService: AuthService  │         │ - userRepo: UserRepository  │
│                             │         │ - emailService: EmailService│
├─────────────────────────────┤         │ - passwordEncoder: BCrypt   │
│ + register(dto): Response   │         ├─────────────────────────────┤
│ + activate(token): Response │         │ + register(dto): User       │
│ + login(dto): Response      │         │ + validateEmail(email): bool│
└─────────────────────────────┘         │ + sendActivation(user): void│
                                        │ + activateUser(token): void │
                                        └─────────────────────────────┘
                                                   │
                                                   │ uses
                                                   ↓
                                        ┌─────────────────────────────┐
                                        │   UserRepository            │
                                        ├─────────────────────────────┤
                                        │ <<interface>>               │
                                        ├─────────────────────────────┤
                                        │ + findByEmail(email): User  │
                                        │ + existsByEmail(email): bool│
                                        │ + save(user): User          │
                                        │ + findByToken(token): User  │
                                        └─────────────────────────────┘

┌─────────────────────────────┐         ┌─────────────────────────────┐
│   EmailService              │────────>│   EmailTemplate             │
├─────────────────────────────┤         ├─────────────────────────────┤
│ - mailSender: JavaMailSender│         │ - subject: String           │
│ - templateEngine: Template  │         │ - body: String              │
├─────────────────────────────┤         │ - variables: Map            │
│ + sendActivation(user): void│         ├─────────────────────────────┤
│ + sendPasswordReset(): void │         │ + render(): String          │
└─────────────────────────────┘         └─────────────────────────────┘

┌─────────────────────────────┐
│   <<enumeration>>           │
│        Role                 │
├─────────────────────────────┤
│ PATIENT                     │
│ DOCTOR                      │
│ ADMIN                       │
└─────────────────────────────┘
```

**Связи:**
- **Ассоциация:** `AuthController` использует `AuthService`
- **Зависимость:** `AuthService` зависит от `UserRepository`
- **Реализация:** `UserRepositoryImpl` реализует `UserRepository`
- **Наследование:** `User` наследуется от `BaseEntity`

---

### 5. State Diagram (Диаграмма состояний)

**Объект:** User Account

```
                [Регистрация]
                      ↓
                ┌──────────┐
          ●────>│   New    │
                │(Новый)   │
                └──────────┘
                      │ sendActivationEmail()
                      ↓
                ┌──────────────────┐
                │  Pending         │
                │ (Ожидание email) │
                └──────────────────┘
                      │ activate(token)
                      ↓
                ┌──────────────┐
                │  Activated   │◄──────┐
                │ (Активирован)│       │
                └──────────────┘       │ reactivate()
                      │                │
                      │ after 30 days  │
                      │ no login       │
                      ↓                │
                ┌──────────────┐       │
                │  Dormant     │───────┘
                │ (Неактивный) │
                └──────────────┘
                      │ admin action
                      ↓
                ┌──────────────┐
                │  Blocked     │
                │ (Заблокирован)│
                └──────────────┘
                      │ admin action
                      ↓
                      ●
```

**Состояния:**
1. **New:** Пользователь создан, письмо не отправлено
2. **Pending:** Письмо отправлено, ожидание активации
3. **Activated:** Аккаунт активирован, может использовать систему
4. **Dormant:** Неактивен более 30 дней
5. **Blocked:** Заблокирован администратором

**Переходы:**
- `sendActivationEmail()`: New → Pending
- `activate(token)`: Pending → Activated
- `after 30 days no login`: Activated → Dormant
- `admin blocks`: * → Blocked

---

### 6. Component Diagram (Диаграмма компонентов)

```
┌─────────────────────────────────────────────────────────────┐
│                    Auth Module                              │
│                                                             │
│  ┌──────────────────┐           ┌──────────────────┐       │
│  │                  │           │                  │       │
│  │  AuthController  │──────────>│   AuthService    │       │
│  │                  │  <<uses>> │                  │       │
│  └──────────────────┘           └──────────────────┘       │
│          │                               │                 │
│          │ <<exposes>>                   │ <<uses>>        │
│          ↓                               ↓                 │
│  ┌──────────────────┐           ┌──────────────────┐       │
│  │   REST API       │           │  UserRepository  │       │
│  │  /api/register   │           │   (JPA)          │       │
│  │  /api/activate   │           └──────────────────┘       │
│  └──────────────────┘                    │                 │
│                                           │ <<uses>>        │
└───────────────────────────────────────────┼─────────────────┘
                                            ↓
                                   ┌──────────────────┐
                                   │   PostgreSQL     │
                                   │   (Database)     │
                                   └──────────────────┘

┌─────────────────────────────────────────────────────────────┐
│               Email Module                                  │
│                                                             │
│  ┌──────────────────┐           ┌──────────────────┐       │
│  │                  │           │                  │       │
│  │  EmailService    │──────────>│ EmailTemplate    │       │
│  │                  │  <<uses>> │   Engine         │       │
│  └──────────────────┘           └──────────────────┘       │
│          │                                                  │
│          │ <<uses>>                                         │
│          ↓                                                  │
│  ┌──────────────────┐                                       │
│  │  JavaMailSender  │                                       │
│  │   (Spring Mail)  │                                       │
│  └──────────────────┘                                       │
└─────────────────────────────────────────────────────────────┘
           │
           │ SMTP
           ↓
  ┌──────────────────┐
  │  Email Provider  │
  │  (SendGrid/SES)  │
  └──────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Security Module                                │
│                                                             │
│  ┌──────────────────┐           ┌──────────────────┐       │
│  │                  │           │                  │       │
│  │   Keycloak       │──────────>│   JWT Filter     │       │
│  │   (Identity)     │  issues   │                  │       │
│  └──────────────────┘           └──────────────────┘       │
│                                           │                 │
│                                           │ validates       │
│                                           ↓                 │
│                                  ┌──────────────────┐       │
│                                  │  SecurityContext │       │
│                                  │     (Spring)     │       │
│                                  └──────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

**Компоненты:**
- **Auth Module:** Управление пользователями
- **Email Module:** Отправка писем
- **Security Module:** Аутентификация и авторизация

**Интерфейсы:**
- REST API: `/api/register`, `/api/activate`
- SMTP: Протокол отправки email
- JDBC: Подключение к PostgreSQL

---

## Источники

- «UML Distilled» Martin Fowler
- [Spring Security Documentation](https://spring.io/projects/spring-security)
- «Design Patterns» Gang of Four

