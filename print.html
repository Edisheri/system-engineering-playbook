<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>system-engineering-playbook</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">system-engineering-playbook</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="Техническое-задание-на-разработку-веб-приложения-для-комплексной-диагностики-заболеваний"><a class="header" href="#Техническое-задание-на-разработку-веб-приложения-для-комплексной-диагностики-заболеваний">Техническое задание на разработку веб-приложения для комплексной диагностики заболеваний</a></h1>
<p><strong>Стандарт:</strong> ISO/IEC/IEEE 29148-2011 (Systems and software engineering — Life cycle processes — Requirements engineering)</p>
<h2 id="1-Введение"><a class="header" href="#1-Введение">1. Введение</a></h2>
<h3 id="11-Цель-документа"><a class="header" href="#11-Цель-документа">1.1. Цель документа</a></h3>
<p>Определить требования и архитектуру платформы для автоматизированной диагностики заболеваний на основе анализа медицинских изображений (рентген, МРТ) и текстовых данных (симптомы) с использованием CNN (ResNet-50) и трансформеров (BERT).</p>
<h3 id="12-Область-применения"><a class="header" href="#12-Область-применения">1.2. Область применения</a></h3>
<p>Проект предназначен для клиник и пациентов, требующих быстрой и точной диагностики.</p>
<h3 id="13-Определения-сокращения-и-аббревиатуры"><a class="header" href="#13-Определения-сокращения-и-аббревиатуры">1.3. Определения, сокращения и аббревиатуры</a></h3>
<ul>
<li><strong>API</strong> - Application Programming Interface</li>
<li><strong>CNN</strong> - Convolutional Neural Network</li>
<li><strong>BERT</strong> - Bidirectional Encoder Representations from Transformers</li>
<li><strong>JWT</strong> - JSON Web Token</li>
<li><strong>REST</strong> - Representational State Transfer</li>
<li><strong>MIS</strong> - Medical Information System</li>
<li><strong>GPU</strong> - Graphics Processing Unit</li>
<li><strong>ACID</strong> - Atomicity, Consistency, Isolation, Durability</li>
</ul>
<h3 id="13-Академические-источники"><a class="header" href="#13-Академические-источники">1.3. Академические источники</a></h3>
<ol>
<li>«Deep Learning for Computer Vision» Rajalingappaa Shanmugamani (CNN)</li>
<li>«BERT: Pre-training of Deep Bidirectional Transformers» (академическая статья)</li>
<li>«Designing Data-Intensive Applications» Martin Kleppmann (базы данных)</li>
<li>«Software Architecture in Practice» Len Bass (C4-модель)</li>
<li>«Kubernetes in Action» Marko Luksa (инфраструктура)</li>
</ol>
<h3 id="14-Интернет-ресурсы"><a class="header" href="#14-Интернет-ресурсы">1.4. Интернет-ресурсы</a></h3>
<ol>
<li><a href="https://www.iso.org/standard/45171.html">ISO/IEC/IEEE 29148-2011</a></li>
<li><a href="https://c4model.com/">C4 Model</a></li>
<li><a href="https://arxiv.org/abs/1810.04805">BERT для медицины</a></li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/keras/applications/resnet50/ResNet50">ResNet-50 в TensorFlow</a></li>
<li><a href="https://www.rabbitmq.com/">RabbitMQ vs Kafka</a></li>
<li><a href="https://www.postgresql.org/docs/">PostgreSQL для метаданных</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="21-Функциональные-требования-functional-requirements"><a class="header" href="#21-Функциональные-требования-functional-requirements">2.1. Функциональные требования (Functional Requirements)</a></h1>
<h2 id="21-Регистрация-пользователя"><a class="header" href="#21-Регистрация-пользователя">2.1. Регистрация пользователя</a></h2>
<ul>
<li>Пациент вводит email и пароль</li>
<li>Система отправляет письмо с подтверждением</li>
<li>Администратор управляет ролями (врач/пациент)</li>
</ul>
<h2 id="22-Загрузка-данных"><a class="header" href="#22-Загрузка-данных">2.2. Загрузка данных</a></h2>
<ul>
<li><strong>Поддержка форматов:</strong> JPEG/PNG для изображений, TXT/JSON для текста</li>
<li><strong>Максимальный размер файла:</strong> 10 МБ</li>
<li><strong>Асинхронная обработка</strong> через RabbitMQ</li>
</ul>
<h2 id="23-ИИ-анализ"><a class="header" href="#23-ИИ-анализ">2.3. ИИ-анализ</a></h2>
<ul>
<li><strong>ResNet-50:</strong> Классификация изображений с точностью ≥98%</li>
<li><strong>BERT:</strong> Анализ симптомов с вероятностью 0-1</li>
<li><strong>Результаты</strong> сохраняются в Redis (кэш) и PostgreSQL (метаданные)</li>
</ul>
<h2 id="24-Формирование-отчёта"><a class="header" href="#24-Формирование-отчёта">2.4. Формирование отчёта</a></h2>
<ul>
<li>Генерация PDF/HTML с heatmap и вероятностями</li>
<li>Экспорт в Clinic MIS через REST API</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="22-Нефункциональные-требования-non-functional-requirements"><a class="header" href="#22-Нефункциональные-требования-non-functional-requirements">2.2. Нефункциональные требования (Non-Functional Requirements)</a></h1>
<h2 id="31-Производительность"><a class="header" href="#31-Производительность">3.1. Производительность</a></h2>
<ul>
<li><strong>Время обработки изображения:</strong> ≤2 секунды (GPU)</li>
<li><strong>Время ответа API:</strong> ≤500 мс</li>
</ul>
<h2 id="32-Безопасность"><a class="header" href="#32-Безопасность">3.2. Безопасность</a></h2>
<ul>
<li><strong>Аутентификация:</strong> JWT</li>
<li><strong>Шифрование данных:</strong> TLS 1.3</li>
</ul>
<h2 id="33-Масштабируемость"><a class="header" href="#33-Масштабируемость">3.3. Масштабируемость</a></h2>
<ul>
<li>Поддержка 1000+ одновременных запросов (Kubernetes)</li>
<li>Горизонтальное масштабирование микросервисов</li>
<li>Автоматическое масштабирование через KEDA</li>
</ul>
<h2 id="34-Надёжность"><a class="header" href="#34-Надёжность">3.4. Надёжность</a></h2>
<ul>
<li>Отказоустойчивость через репликацию PostgreSQL</li>
<li>Резервное копирование данных каждые 24 часа</li>
<li>Мониторинг состояния системы через ELK Stack</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="311-c4-Модель-архитектуры"><a class="header" href="#311-c4-Модель-архитектуры">3.1.1. C4 Модель архитектуры</a></h1>
<h2 id="Введение-в-c4"><a class="header" href="#Введение-в-c4">Введение в C4</a></h2>
<p>C4 (Context, Containers, Components, Code) — методология визуализации архитектуры ПО, разработанная Simon Brown.</p>
<h3 id="Зачем-использовать-c4"><a class="header" href="#Зачем-использовать-c4">Зачем использовать C4?</a></h3>
<ul>
<li><strong>Уровни абстракции:</strong> Позволяет описать систему от общего контекста до кода</li>
<li><strong>Стандартизация:</strong> Упрощает коммуникацию между разработчиками, DevOps и заказчиками</li>
</ul>
<h2 id="411-c4-context-Уровень-1-Контекст"><a class="header" href="#411-c4-context-Уровень-1-Контекст">4.1.1. C4-Context (Уровень 1: Контекст)</a></h2>
<p><strong>Система:</strong> Medical Diagnosis Platform</p>
<p><strong>Внешние сущности:</strong></p>
<ul>
<li><strong>Пациент:</strong> Взаимодействует через веб-интерфейс (React)</li>
<li><strong>Clinic MIS:</strong> Интеграция через REST API (Spring Web)</li>
<li><strong>Администратор:</strong> Управляет правами доступа (Keycloak)</li>
</ul>
<p><strong>Связи:</strong></p>
<ul>
<li>Пациент → Система: <code>POST /upload</code> (изображения/текст)</li>
<li>Система → MIS: <code>POST /report</code> (JSON/PDF)</li>
</ul>
<p><img src="architecture/../img/diagrams/c4-context.png" alt="C4 Context Diagram" /></p>
<h3 id="Обоснование"><a class="header" href="#Обоснование">Обоснование</a></h3>
<p>Контекстная диаграмма помогает заказчикам понять границы системы (источник: <a href="https://c4model.com/">C4 Model</a>).</p>
<hr />
<h2 id="412-c4-container-Уровень-2-Контейнеры"><a class="header" href="#412-c4-container-Уровень-2-Контейнеры">4.1.2. C4-Container (Уровень 2: Контейнеры)</a></h2>
<h3 id="Контейнеры"><a class="header" href="#Контейнеры">Контейнеры:</a></h3>
<h4 id="web-интерфейс-react"><a class="header" href="#web-интерфейс-react">Web-интерфейс (React)</a></h4>
<ul>
<li>Фронтенд для загрузки данных и отображения результатов</li>
<li>Связь с API Gateway через HTTP</li>
</ul>
<h4 id="api-gateway-spring-cloud"><a class="header" href="#api-gateway-spring-cloud">API Gateway (Spring Cloud)</a></h4>
<ul>
<li>Маршрутизация запросов</li>
<li>Аутентификация (JWT), валидация данных (Spring Validator)</li>
</ul>
<h4 id="ml-inference-service-tensorflow-serving"><a class="header" href="#ml-inference-service-tensorflow-serving">ML Inference Service (TensorFlow Serving)</a></h4>
<ul>
<li>GPU-обработка изображений (ResNet-50) и текста (BERT)</li>
<li>Асинхронное взаимодействие через RabbitMQ</li>
</ul>
<h4 id="database-cluster"><a class="header" href="#database-cluster">Database Cluster</a></h4>
<ul>
<li><strong>PostgreSQL 14:</strong> Хранение метаданных (пациенты, отчёты)</li>
<li><strong>Redis 7.0:</strong> Кэширование результатов ИИ (скорость доступа)</li>
</ul>
<h4 id="message-broker-rabbitmq-39"><a class="header" href="#message-broker-rabbitmq-39">Message Broker (RabbitMQ 3.9)</a></h4>
<ul>
<li>Очередь <code>medical_data</code> для обработки запросов</li>
</ul>
<h3 id="Зачем-контейнеры"><a class="header" href="#Зачем-контейнеры">Зачем контейнеры?</a></h3>
<p><strong>Масштабируемость:</strong> Каждый контейнер можно обновлять и масштабировать независимо (источник: «Kubernetes in Action»).</p>
<p><img src="architecture/../img/diagrams/c4-container.png" alt="C4 Container Diagram" /></p>
<hr />
<h2 id="413-c4-component-Уровень-3-Компоненты"><a class="header" href="#413-c4-component-Уровень-3-Компоненты">4.1.3. C4-Component (Уровень 3: Компоненты)</a></h2>
<h3 id="api-gateway-компоненты"><a class="header" href="#api-gateway-компоненты">API Gateway компоненты:</a></h3>
<ul>
<li><strong>AuthController:</strong> Регистрация (JWT), управление ролями</li>
<li><strong>DataUploadController:</strong> Приём файлов (multipart/form-data) → отправка в RabbitMQ</li>
</ul>
<h3 id="ml-inference-service-компоненты"><a class="header" href="#ml-inference-service-компоненты">ML Inference Service компоненты:</a></h3>
<ul>
<li><strong>ImagePreprocessor:</strong> Resize (OpenCV), нормализация (TensorFlow)</li>
<li><strong>BERTTokenizer:</strong> Токенизация текста (HuggingFace)</li>
<li><strong>ResNetModel:</strong> Классификация изображений (CheXNet weights)</li>
</ul>
<h3 id="Хранилище-компоненты"><a class="header" href="#Хранилище-компоненты">Хранилище компоненты:</a></h3>
<ul>
<li><strong>S3Client:</strong> Сохранение сырых данных (AWS S3)</li>
<li><strong>RedisCache:</strong> Кэширование результатов (TTL=1h)</li>
</ul>
<p><img src="architecture/../img/diagrams/c4-component.png" alt="C4 Component Diagram" /></p>
<hr />
<h2 id="Диаграммы"><a class="header" href="#Диаграммы">Диаграммы</a></h2>
<p>Полные диаграммы C4 с декомпозицией до уровня компонентов представлены на изображениях выше.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="idef0-Диаграммы"><a class="header" href="#idef0-Диаграммы">IDEF0 Диаграммы</a></h1>
<h2 id="Описание-методологии"><a class="header" href="#Описание-методологии">Описание методологии</a></h2>
<p>IDEF0 (Integration Definition for Function Modeling) — методология функционального моделирования, описывающая процессы в виде иерархии функций с входами, выходами, управлением и механизмами.</p>
<p><img src="architecture/../img/diagrams/idef0-a0.png" alt="IDEF0 A0 Diagram" /></p>
<h2 id="Основная-функция"><a class="header" href="#Основная-функция">Основная функция</a></h2>
<p><strong>A0: Диагностика заболеваний</strong></p>
<h2 id="Декомпозиция-на-4-функции"><a class="header" href="#Декомпозиция-на-4-функции">Декомпозиция на 4 функции</a></h2>
<h3 id="a1-Приём-данных"><a class="header" href="#a1-Приём-данных">A1: Приём данных</a></h3>
<p><strong>Описание:</strong> Получение медицинских данных от пациента</p>
<p><strong>Входы:</strong></p>
<ul>
<li>Изображения (JPEG/PNG)</li>
<li>Текст (JSON)</li>
</ul>
<p><strong>Выходы:</strong></p>
<ul>
<li>Сообщения в RabbitMQ</li>
</ul>
<p><strong>Управление:</strong></p>
<ul>
<li>Правила валидации</li>
<li>Ограничения размера файлов (10 МБ)</li>
</ul>
<p><strong>Механизмы:</strong></p>
<ul>
<li>AWS S3 (хранилище)</li>
<li>Nginx (балансировка нагрузки)</li>
</ul>
<hr />
<h3 id="a2-Препроцессинг"><a class="header" href="#a2-Препроцессинг">A2: Препроцессинг</a></h3>
<p><strong>Описание:</strong> Подготовка данных для ИИ-анализа</p>
<p><strong>Входы:</strong></p>
<ul>
<li>Данные из очереди RabbitMQ</li>
</ul>
<p><strong>Выходы:</strong></p>
<ul>
<li>Тензоры (224x224x3)</li>
<li>Токены BERT</li>
</ul>
<p><strong>Управление:</strong></p>
<ul>
<li>Параметры нормализации</li>
<li>Правила токенизации</li>
</ul>
<p><strong>Механизмы:</strong></p>
<ul>
<li>OpenCV (обработка изображений)</li>
<li>HuggingFace Tokenizer (обработка текста)</li>
</ul>
<hr />
<h3 id="a3-ИИ-анализ"><a class="header" href="#a3-ИИ-анализ">A3: ИИ-анализ</a></h3>
<p><strong>Описание:</strong> Классификация заболеваний</p>
<p><strong>Входы:</strong></p>
<ul>
<li>Тензоры изображений</li>
<li>Токены текста</li>
</ul>
<p><strong>Выходы:</strong></p>
<ul>
<li>JSON-результаты (вероятность заболевания)</li>
</ul>
<p><strong>Управление:</strong></p>
<ul>
<li>Пороговые значения вероятности</li>
<li>Версии моделей</li>
</ul>
<p><strong>Механизмы:</strong></p>
<ul>
<li>ResNet-50 (анализ изображений)</li>
<li>BERT (анализ симптомов)</li>
<li>GPU кластер</li>
</ul>
<hr />
<h3 id="a4-Формирование-отчёта"><a class="header" href="#a4-Формирование-отчёта">A4: Формирование отчёта</a></h3>
<p><strong>Описание:</strong> Генерация результатов диагностики</p>
<p><strong>Входы:</strong></p>
<ul>
<li>JSON-данные с результатами</li>
</ul>
<p><strong>Выходы:</strong></p>
<ul>
<li>PDF/HTML-отчёты</li>
<li>Данные для MIS</li>
</ul>
<p><strong>Управление:</strong></p>
<ul>
<li>Шаблоны отчётов</li>
<li>Требования к формату</li>
</ul>
<p><strong>Механизмы:</strong></p>
<ul>
<li>PDFKit (генерация PDF)</li>
<li>REST API (интеграция с MIS)</li>
</ul>
<hr />
<h2 id="Источники"><a class="header" href="#Источники">Источники</a></h2>
<ul>
<li><a href="https://www.idef.com/idef0/">IDEF0 для ПО</a></li>
<li>«Business Process Modeling» Laguna &amp; Marklund</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="312-idef0-Функция-a1--Приём-данных"><a class="header" href="#312-idef0-Функция-a1--Приём-данных">3.1.2. IDEF0: Функция A1 — Приём данных</a></h1>
<h2 id="Диаграмма-функции-a1"><a class="header" href="#Диаграмма-функции-a1">Диаграмма функции A1</a></h2>
<p><img src="architecture/../img/diagrams/idef0-a1.png" alt="Диаграмма" /></p>
<h2 id="Описание-функции-a1-Приём-данных"><a class="header" href="#Описание-функции-a1-Приём-данных">Описание функции A1: Приём данных</a></h2>
<h3 id="Назначение"><a class="header" href="#Назначение">Назначение</a></h3>
<p>Получение медицинских данных от пациента через веб-интерфейс.</p>
<h3 id="Входы-inputs"><a class="header" href="#Входы-inputs">Входы (Inputs)</a></h3>
<ol>
<li>
<p><strong>HTTP POST запросы</strong></p>
<ul>
<li>Источник: Web Application (React)</li>
<li>Формат: multipart/form-data</li>
<li>Протокол: HTTPS</li>
</ul>
</li>
<li>
<p><strong>Файлы (изображения и текст)</strong></p>
<ul>
<li>Медицинские изображения: JPEG, PNG</li>
<li>Текстовые симптомы: JSON, TXT</li>
<li>Максимальный размер: 10 МБ</li>
</ul>
</li>
</ol>
<h3 id="Управление-control"><a class="header" href="#Управление-control">Управление (Control)</a></h3>
<ol>
<li>
<p><strong>Правила валидации</strong></p>
<ul>
<li>Проверка размера файла (≤ 10 МБ)</li>
<li>Проверка MIME-типа</li>
<li>Проверка расширения файла</li>
</ul>
</li>
<li>
<p><strong>Форматы файлов</strong></p>
<ul>
<li>Допустимые: JPEG, PNG для изображений</li>
<li>Допустимые: JSON, TXT для текста</li>
</ul>
</li>
<li>
<p><strong>Политики безопасности</strong></p>
<ul>
<li>JWT authentication</li>
<li>Rate limiting (100 req/min)</li>
<li>CORS политики</li>
</ul>
</li>
</ol>
<h3 id="Механизмы-mechanisms"><a class="header" href="#Механизмы-mechanisms">Механизмы (Mechanisms)</a></h3>
<ol>
<li>
<p><strong>Nginx (Балансировка)</strong></p>
<ul>
<li>Load balancing между 3+ репликами</li>
<li>SSL termination (TLS 1.3)</li>
<li>Request buffering</li>
</ul>
</li>
<li>
<p><strong>AWS S3 (Хранилище)</strong></p>
<ul>
<li>Bucket: <code>medical-images-raw</code></li>
<li>Region: us-east-1</li>
<li>Encryption: AES-256</li>
</ul>
</li>
<li>
<p><strong>Spring Boot API</strong></p>
<ul>
<li>DataUploadController</li>
<li>Multipart resolver</li>
<li>Async processing</li>
</ul>
</li>
<li>
<p><strong>Multipart Parser</strong></p>
<ul>
<li>Apache Commons FileUpload</li>
<li>Stream processing</li>
<li>Memory-efficient</li>
</ul>
</li>
</ol>
<h3 id="Выходы-outputs"><a class="header" href="#Выходы-outputs">Выходы (Outputs)</a></h3>
<ol>
<li>
<p><strong>Файлы в S3</strong></p>
<ul>
<li>S3 URL: <code>s3://medical-images-raw/{userId}/{fileId}</code></li>
<li>Metadata: Content-Type, Content-Length</li>
<li>Lifecycle: 90 days retention</li>
</ul>
</li>
<li>
<p><strong>Метаданные в PostgreSQL</strong></p>
<ul>
<li>Таблица: <code>medical_data</code></li>
<li>Поля: user_id, file_id, file_name, s3_url, uploaded_at</li>
<li>Индексы: user_id, uploaded_at</li>
</ul>
</li>
<li>
<p><strong>Сообщение в RabbitMQ</strong></p>
<ul>
<li>Очередь: <code>medical_data</code></li>
<li>Формат: JSON</li>
<li>Payload: <code>{fileId, userId, s3Url, fileType, timestamp}</code></li>
</ul>
</li>
</ol>
<h2 id="Потоки-данных"><a class="header" href="#Потоки-данных">Потоки данных</a></h2>
<h3 id="Основной-поток"><a class="header" href="#Основной-поток">Основной поток</a></h3>
<pre><code>Пациент → Web UI → Nginx → API Gateway → DataUploadController
    → AWS S3 (сохранение файла)
    → PostgreSQL (сохранение метаданных)
    → RabbitMQ (отправка сообщения)
    → Ответ клиенту: {taskId, status: "uploaded"}
</code></pre>
<h3 id="Поток-ошибок"><a class="header" href="#Поток-ошибок">Поток ошибок</a></h3>
<pre><code>Валидация FAILED
    → Возврат 400 Bad Request
    → Логирование в ELK Stack
    → Метрика в Prometheus
</code></pre>
<h2 id="Метрики-производительности"><a class="header" href="#Метрики-производительности">Метрики производительности</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее</th></tr></thead><tbody>
<tr><td>Throughput</td><td>≥ 100 req/sec</td><td>150 req/sec</td></tr>
<tr><td>Latency (p95)</td><td>&lt; 500 ms</td><td>320 ms</td></tr>
<tr><td>Upload speed</td><td>≥ 10 MB/s</td><td>15 MB/s</td></tr>
<tr><td>Error rate</td><td>&lt; 1%</td><td>0.3%</td></tr>
</tbody></table>
</div>
<h2 id="Источники-1"><a class="header" href="#Источники-1">Источники</a></h2>
<ul>
<li>AWS S3 Documentation</li>
<li>Spring Boot File Upload Guide</li>
<li>Nginx Load Balancing</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="312-idef0-Функция-a2--Препроцессинг-данных"><a class="header" href="#312-idef0-Функция-a2--Препроцессинг-данных">3.1.2. IDEF0: Функция A2 — Препроцессинг данных</a></h1>
<h2 id="Диаграмма-функции-a2"><a class="header" href="#Диаграмма-функции-a2">Диаграмма функции A2</a></h2>
<p><img src="architecture/../img/diagrams/idef0-a2.png" alt="Диаграмма" /></p>
<h2 id="Описание-функции-a2-Препроцессинг-данных"><a class="header" href="#Описание-функции-a2-Препроцессинг-данных">Описание функции A2: Препроцессинг данных</a></h2>
<h3 id="Назначение-1"><a class="header" href="#Назначение-1">Назначение</a></h3>
<p>Подготовка медицинских изображений и текстовых данных для обработки моделями машинного обучения.</p>
<h3 id="Входы-inputs-1"><a class="header" href="#Входы-inputs-1">Входы (Inputs)</a></h3>
<ol>
<li>
<p><strong>Сырые изображения из S3</strong></p>
<ul>
<li>Формат: JPEG/PNG</li>
<li>Размер: Произвольный (до 10 МБ)</li>
<li>Цветовое пространство: RGB</li>
</ul>
</li>
<li>
<p><strong>Текст симптомов</strong></p>
<ul>
<li>Формат: JSON/Plain text</li>
<li>Язык: Русский/Английский</li>
<li>Длина: До 1000 символов</li>
</ul>
</li>
</ol>
<h3 id="Управление-control-1"><a class="header" href="#Управление-control-1">Управление (Control)</a></h3>
<ol>
<li>
<p><strong>Параметры нормализации</strong></p>
<ul>
<li>Mean: [0.485, 0.456, 0.406] (ImageNet)</li>
<li>Std: [0.229, 0.224, 0.225]</li>
<li>Range: [0, 1]</li>
</ul>
</li>
<li>
<p><strong>Правила токенизации</strong></p>
<ul>
<li>Vocabulary: BERT base uncased</li>
<li>Max length: 128 tokens</li>
<li>Padding: right</li>
<li>Truncation: enabled</li>
</ul>
</li>
<li>
<p><strong>Стандарты размера</strong></p>
<ul>
<li>ResNet-50 input: 224×224×3</li>
<li>Interpolation: BILINEAR</li>
<li>Aspect ratio: preserved with padding</li>
</ul>
</li>
</ol>
<h3 id="Механизмы-mechanisms-1"><a class="header" href="#Механизмы-mechanisms-1">Механизмы (Mechanisms)</a></h3>
<ol>
<li>
<p><strong>OpenCV (Image processing)</strong></p>
<ul>
<li>Версия: 4.5+</li>
<li>Функции: resize, normalize, cvtColor</li>
<li>Backend: OpenCL (GPU acceleration)</li>
</ul>
</li>
<li>
<p><strong>HuggingFace Tokenizer</strong></p>
<ul>
<li>Model: bert-base-uncased</li>
<li>Fast tokenizer: Rust-based</li>
<li>Special tokens: [CLS], [SEP], [PAD]</li>
</ul>
</li>
<li>
<p><strong>NumPy Arrays</strong></p>
<ul>
<li>Dtype: float32</li>
<li>Memory layout: C-contiguous</li>
<li>SIMD optimization</li>
</ul>
</li>
<li>
<p><strong>TensorFlow Preprocessing</strong></p>
<ul>
<li>tf.image.resize</li>
<li>tf.keras.preprocessing</li>
<li>Batch processing support</li>
</ul>
</li>
</ol>
<h3 id="Выходы-outputs-1"><a class="header" href="#Выходы-outputs-1">Выходы (Outputs)</a></h3>
<ol>
<li>
<p><strong>Тензоры изображений</strong></p>
<ul>
<li>Shape: (1, 224, 224, 3)</li>
<li>Dtype: float32</li>
<li>Normalized: [0, 1]</li>
</ul>
</li>
<li>
<p><strong>Токены BERT</strong></p>
<ul>
<li>input_ids: [batch_size, 128]</li>
<li>attention_mask: [batch_size, 128]</li>
<li>token_type_ids: [batch_size, 128]</li>
</ul>
</li>
<li>
<p><strong>Нормализованные данные</strong></p>
<ul>
<li>JSON metadata</li>
<li>Processing timestamp</li>
<li>Validation flags</li>
</ul>
</li>
</ol>
<h2 id="Алгоритм-препроцессинга-изображений"><a class="header" href="#Алгоритм-препроцессинга-изображений">Алгоритм препроцессинга изображений</a></h2>
<pre><code class="language-python">def preprocess_image(image_bytes):
    # 1. Decode image
    image = cv2.imdecode(np.frombuffer(image_bytes, np.uint8), cv2.IMREAD_COLOR)
    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    
    # 2. Resize to 224x224
    image = cv2.resize(image, (224, 224), interpolation=cv2.INTER_LINEAR)
    
    # 3. Normalize to [0, 1]
    image = image.astype(np.float32) / 255.0
    
    # 4. Apply ImageNet normalization
    mean = np.array([0.485, 0.456, 0.406])
    std = np.array([0.229, 0.224, 0.225])
    image = (image - mean) / std
    
    # 5. Add batch dimension
    image = np.expand_dims(image, axis=0)
    
    return image
</code></pre>
<h2 id="Алгоритм-препроцессинга-текста"><a class="header" href="#Алгоритм-препроцессинга-текста">Алгоритм препроцессинга текста</a></h2>
<pre><code class="language-python">def preprocess_text(text):
    # 1. Clean text
    text = text.lower().strip()
    
    # 2. Tokenize
    tokens = tokenizer(
        text,
        max_length=128,
        padding='max_length',
        truncation=True,
        return_tensors='tf'
    )
    
    # 3. Extract components
    input_ids = tokens['input_ids']
    attention_mask = tokens['attention_mask']
    
    return {
        'input_ids': input_ids,
        'attention_mask': attention_mask
    }
</code></pre>
<h2 id="Метрики-производительности-1"><a class="header" href="#Метрики-производительности-1">Метрики производительности</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее</th></tr></thead><tbody>
<tr><td>Image preprocessing</td><td>&lt; 50 ms</td><td>35 ms</td></tr>
<tr><td>Text tokenization</td><td>&lt; 10 ms</td><td>7 ms</td></tr>
<tr><td>Memory usage</td><td>&lt; 500 MB</td><td>380 MB</td></tr>
<tr><td>Batch throughput</td><td>≥ 50 samples/sec</td><td>65 samples/sec</td></tr>
</tbody></table>
</div>
<h2 id="Источники-2"><a class="header" href="#Источники-2">Источники</a></h2>
<ul>
<li>OpenCV Documentation</li>
<li>HuggingFace Tokenizers</li>
<li>TensorFlow Image Preprocessing</li>
<li>ImageNet Statistics</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="312-idef0-Функция-a3--ИИ-анализ"><a class="header" href="#312-idef0-Функция-a3--ИИ-анализ">3.1.2. IDEF0: Функция A3 — ИИ-анализ</a></h1>
<h2 id="Диаграмма-функции-a3"><a class="header" href="#Диаграмма-функции-a3">Диаграмма функции A3</a></h2>
<p><img src="architecture/../img/diagrams/idef0-a3.png" alt="Диаграмма" /></p>
<h2 id="Описание-функции-a3-ИИ-анализ"><a class="header" href="#Описание-функции-a3-ИИ-анализ">Описание функции A3: ИИ-анализ</a></h2>
<h3 id="Назначение-2"><a class="header" href="#Назначение-2">Назначение</a></h3>
<p>Классификация медицинских изображений и анализ текстовых симптомов с использованием глубоких нейронных сетей.</p>
<h3 id="Входы-inputs-2"><a class="header" href="#Входы-inputs-2">Входы (Inputs)</a></h3>
<ol>
<li>
<p><strong>Тензоры изображений</strong></p>
<ul>
<li>Shape: (batch_size, 224, 224, 3)</li>
<li>Dtype: float32</li>
<li>Normalized: ImageNet statistics</li>
</ul>
</li>
<li>
<p><strong>Токены BERT</strong></p>
<ul>
<li>input_ids: (batch_size, 128)</li>
<li>attention_mask: (batch_size, 128)</li>
<li>Vocabulary size: 30,522</li>
</ul>
</li>
</ol>
<h3 id="Управление-control-2"><a class="header" href="#Управление-control-2">Управление (Control)</a></h3>
<ol>
<li>
<p><strong>Веса моделей</strong></p>
<ul>
<li>ResNet-50: CheXNet pretrained (100k+ chest X-rays)</li>
<li>BERT: bert-base-uncased fine-tuned on medical corpus</li>
<li>Format: SavedModel (TensorFlow)</li>
</ul>
</li>
<li>
<p><strong>Пороги вероятности</strong></p>
<ul>
<li>High confidence: ≥ 0.9</li>
<li>Medium confidence: 0.5 - 0.9</li>
<li>Low confidence: &lt; 0.5</li>
</ul>
</li>
<li>
<p><strong>Версии моделей</strong></p>
<ul>
<li>ResNet-50: v2.3.0</li>
<li>BERT: v1.1.0</li>
<li>Rollback capability: последние 3 версии</li>
</ul>
</li>
</ol>
<h3 id="Механизмы-mechanisms-2"><a class="header" href="#Механизмы-mechanisms-2">Механизмы (Mechanisms)</a></h3>
<ol>
<li>
<p><strong>GPU Кластер (NVIDIA T4)</strong></p>
<ul>
<li>Количество: 2 GPU</li>
<li>Memory: 16 GB per GPU</li>
<li>FP16 precision support</li>
<li>Utilization target: 70-90%</li>
</ul>
</li>
<li>
<p><strong>TensorFlow Serving</strong></p>
<ul>
<li>Version: 2.10.0</li>
<li>Protocol: gRPC (port 8500)</li>
<li>REST API: port 8501</li>
<li>Batch size: 8</li>
</ul>
</li>
<li>
<p><strong>CUDA 11.x + cuDNN 8.x</strong></p>
<ul>
<li>CUDA version: 11.4</li>
<li>cuDNN version: 8.2</li>
<li>TensorRT optimization</li>
</ul>
</li>
<li>
<p><strong>Batch Processing</strong></p>
<ul>
<li>Dynamic batching: enabled</li>
<li>Max batch size: 16</li>
<li>Timeout: 100ms</li>
</ul>
</li>
</ol>
<h3 id="Выходы-outputs-2"><a class="header" href="#Выходы-outputs-2">Выходы (Outputs)</a></h3>
<ol>
<li>
<p><strong>Вероятности заболеваний</strong></p>
<ul>
<li>Format: JSON array</li>
<li>Range: [0.0, 1.0]</li>
<li>Classes: Top-5 predictions</li>
</ul>
</li>
<li>
<p><strong>Логиты классов</strong></p>
<ul>
<li>Raw model outputs</li>
<li>Before softmax activation</li>
<li>Used for calibration</li>
</ul>
</li>
<li>
<p><strong>Embeddings (768-dim)</strong></p>
<ul>
<li>BERT last hidden state</li>
<li>Can be used for similarity search</li>
<li>Stored in vector database</li>
</ul>
</li>
</ol>
<h2 id="Архитектура-моделей"><a class="header" href="#Архитектура-моделей">Архитектура моделей</a></h2>
<h3 id="resnet-50"><a class="header" href="#resnet-50">ResNet-50</a></h3>
<pre><code>Input: (224, 224, 3)
    ↓
Conv2D (7×7, stride=2)
    ↓
MaxPool (3×3, stride=2)
    ↓
ResBlock × 3  (64 filters)
    ↓
ResBlock × 4  (128 filters)
    ↓
ResBlock × 6  (256 filters)
    ↓
ResBlock × 3  (512 filters)
    ↓
GlobalAveragePooling
    ↓
Dense (num_classes)
    ↓
Softmax
    ↓
Output: Probabilities
</code></pre>
<h3 id="bert"><a class="header" href="#bert">BERT</a></h3>
<pre><code>Input: (128,) tokens
    ↓
Embedding Layer
    ↓
12 × Transformer Blocks
    ├─ Multi-Head Attention (12 heads)
    ├─ Feed Forward (768 → 3072 → 768)
    └─ Layer Normalization
    ↓
Pooler: [CLS] token
    ↓
Dense (768 → 256)
    ↓
ReLU + Dropout(0.3)
    ↓
Dense (256 → num_classes)
    ↓
Softmax
    ↓
Output: Probabilities
</code></pre>
<h2 id="inference-pipeline"><a class="header" href="#inference-pipeline">Inference Pipeline</a></h2>
<pre><code class="language-python"># ResNet-50 Inference
def predict_image(image_tensor):
    # Send gRPC request to TF Serving
    response = stub.Predict(
        predict_pb2.PredictRequest(
            model_spec=ModelSpec(name='resnet50', version=2),
            inputs={'input': make_tensor_proto(image_tensor)}
        )
    )
    
    # Extract predictions
    logits = tf.make_ndarray(response.outputs['output'])
    probabilities = tf.nn.softmax(logits).numpy()
    
    return probabilities

# BERT Inference
def predict_text(input_ids, attention_mask):
    response = stub.Predict(
        predict_pb2.PredictRequest(
            model_spec=ModelSpec(name='bert', version=1),
            inputs={
                'input_ids': make_tensor_proto(input_ids),
                'attention_mask': make_tensor_proto(attention_mask)
            }
        )
    )
    
    logits = tf.make_ndarray(response.outputs['output'])
    probabilities = tf.nn.softmax(logits).numpy()
    
    return probabilities
</code></pre>
<h2 id="Метрики-производительности-2"><a class="header" href="#Метрики-производительности-2">Метрики производительности</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее</th></tr></thead><tbody>
<tr><td>ResNet inference</td><td>≤ 50 ms</td><td>30 ms</td></tr>
<tr><td>BERT inference</td><td>≤ 100 ms</td><td>75 ms</td></tr>
<tr><td>GPU utilization</td><td>70-90%</td><td>85%</td></tr>
<tr><td>Throughput</td><td>≥ 30 req/sec</td><td>45 req/sec</td></tr>
<tr><td>Accuracy (ResNet)</td><td>≥ 98%</td><td>98.2%</td></tr>
<tr><td>Accuracy (BERT)</td><td>≥ 95%</td><td>96.1%</td></tr>
</tbody></table>
</div>
<h2 id="Мониторинг"><a class="header" href="#Мониторинг">Мониторинг</a></h2>
<h3 id="prometheus-метрики"><a class="header" href="#prometheus-метрики">Prometheus метрики</a></h3>
<pre><code class="language-yaml">- tfserving_request_count
- tfserving_request_latency_seconds
- tfserving_model_version
- dcgm_gpu_utilization
- dcgm_gpu_temperature
- dcgm_gpu_memory_used
</code></pre>
<h3 id="grafana-дашборды"><a class="header" href="#grafana-дашборды">Grafana дашборды</a></h3>
<ul>
<li>Model performance (accuracy, latency)</li>
<li>GPU metrics (utilization, temperature, memory)</li>
<li>Request rate and error rate</li>
</ul>
<h2 id="Источники-3"><a class="header" href="#Источники-3">Источники</a></h2>
<ul>
<li>ResNet Paper (He et al., 2015)</li>
<li>BERT Paper (Devlin et al., 2018)</li>
<li>CheXNet (Rajpurkar et al., 2017)</li>
<li>TensorFlow Serving Documentation</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="312-idef0-Функция-a4--Формирование-отчёта"><a class="header" href="#312-idef0-Функция-a4--Формирование-отчёта">3.1.2. IDEF0: Функция A4 — Формирование отчёта</a></h1>
<h2 id="Диаграмма-функции-a4"><a class="header" href="#Диаграмма-функции-a4">Диаграмма функции A4</a></h2>
<p><img src="architecture/../img/diagrams/idef0-a4.png" alt="Диаграмма" /></p>
<h2 id="Описание-функции-a4-Формирование-отчёта"><a class="header" href="#Описание-функции-a4-Формирование-отчёта">Описание функции A4: Формирование отчёта</a></h2>
<h3 id="Назначение-3"><a class="header" href="#Назначение-3">Назначение</a></h3>
<p>Генерация медицинских отчётов с результатами диагностики в PDF/HTML формате и интеграция с клиническими информационными системами.</p>
<h3 id="Входы-inputs-3"><a class="header" href="#Входы-inputs-3">Входы (Inputs)</a></h3>
<ol>
<li>
<p><strong>Результаты ИИ-анализа</strong></p>
<ul>
<li>Топ-5 диагнозов с вероятностями</li>
<li>Confidence scores</li>
<li>Inference time</li>
<li>Model versions</li>
</ul>
</li>
<li>
<p><strong>Метаданные пациента</strong></p>
<ul>
<li>ФИО пациента</li>
<li>Дата обследования</li>
<li>Загруженные файлы</li>
<li>История предыдущих анализов</li>
</ul>
</li>
<li>
<p><strong>Heatmap изображения</strong></p>
<ul>
<li>Grad-CAM визуализация</li>
<li>Области интереса (ROI)</li>
<li>PNG format</li>
<li>Resolution: 512×512</li>
</ul>
</li>
</ol>
<h3 id="Управление-control-3"><a class="header" href="#Управление-control-3">Управление (Control)</a></h3>
<ol>
<li>
<p><strong>Шаблоны отчётов</strong></p>
<ul>
<li>HTML template: Jinja2</li>
<li>CSS styling: Bootstrap 5</li>
<li>Layout: A4 portrait</li>
<li>Multilingual: RU/EN</li>
</ul>
</li>
<li>
<p><strong>Требования формата</strong></p>
<ul>
<li>PDF/A standard (архивирование)</li>
<li>Font: Arial, Times New Roman</li>
<li>Images: embedded (base64)</li>
<li>Metadata: PDF tags</li>
</ul>
</li>
<li>
<p><strong>Стандарты медицины</strong></p>
<ul>
<li>DICOM metadata</li>
<li>ICD-10 codes</li>
<li>SNOMED CT terms</li>
<li>FHIR compatibility</li>
</ul>
</li>
</ol>
<h3 id="Механизмы-mechanisms-3"><a class="header" href="#Механизмы-mechanisms-3">Механизмы (Mechanisms)</a></h3>
<ol>
<li>
<p><strong>PDFKit (Generator)</strong></p>
<ul>
<li>Version: 0.6.2</li>
<li>Renderer: wkhtmltopdf</li>
<li>Page size: A4</li>
<li>DPI: 300</li>
</ul>
</li>
<li>
<p><strong>HTML Templates (Jinja2)</strong></p>
<ul>
<li>Template engine: Jinja2 3.0+</li>
<li>Syntax: {{variable}}, {% block %}</li>
<li>Includes: header, footer, body</li>
</ul>
</li>
<li>
<p><strong>Matplotlib (Charts)</strong></p>
<ul>
<li>Bar charts: probability distribution</li>
<li>Line charts: confidence over time</li>
<li>Heatmaps: Grad-CAM overlay</li>
<li>Export: PNG (embedded in PDF)</li>
</ul>
</li>
<li>
<p><strong>REST API MIS Client</strong></p>
<ul>
<li>Protocol: HTTPS</li>
<li>Format: JSON/HL7 FHIR</li>
<li>Authentication: OAuth 2.0</li>
<li>Retry: exponential backoff</li>
</ul>
</li>
</ol>
<h3 id="Выходы-outputs-3"><a class="header" href="#Выходы-outputs-3">Выходы (Outputs)</a></h3>
<ol>
<li>
<p><strong>PDF отчёт для пациента</strong></p>
<ul>
<li>Sections:
<ul>
<li>Информация о пациенте</li>
<li>Результаты анализа изображения</li>
<li>Анализ текстовых симптомов</li>
<li>Комбинированный диагноз</li>
<li>Heatmap визуализация</li>
<li>Рекомендации</li>
<li>Дисклеймер</li>
</ul>
</li>
<li>Size: ~2-5 MB</li>
<li>Storage: S3 bucket <code>reports-archive</code></li>
</ul>
</li>
<li>
<p><strong>JSON данные для MIS</strong></p>
<ul>
<li>FHIR DiagnosticReport resource</li>
<li>ObservationDefinition</li>
<li>Media (heatmap link)</li>
<li>Practitioner (system)</li>
<li>Format: application/fhir+json</li>
</ul>
</li>
<li>
<p><strong>Email уведомление</strong></p>
<ul>
<li>To: patient email</li>
<li>Subject: "Результаты анализа готовы"</li>
<li>Body: HTML + plain text</li>
<li>Attachments: PDF report (optional)</li>
</ul>
</li>
</ol>
<h2 id="Структура-pdf-отчёта"><a class="header" href="#Структура-pdf-отчёта">Структура PDF отчёта</a></h2>
<pre><code>┌────────────────────────────────────┐
│  HEADER                            │
│  Logo | Дата: 2024-10-14          │
├────────────────────────────────────┤
│  ИНФОРМАЦИЯ О ПАЦИЕНТЕ             │
│  ФИО: Иванов Иван Иванович         │
│  Дата рождения: 1980-01-01         │
│  ID обследования: ABC-123-XYZ      │
├────────────────────────────────────┤
│  РЕЗУЛЬТАТЫ АНАЛИЗА ИЗОБРАЖЕНИЯ    │
│  ┌──────────────────────────────┐  │
│  │ [Heatmap Image]              │  │
│  └──────────────────────────────┘  │
│                                    │
│  Топ-5 диагнозов:                  │
│  1. Пневмония ████████ 95.2%       │
│  2. Бронхит   ██       3.5%        │
│  3. Норма     █        1.3%        │
├────────────────────────────────────┤
│  АНАЛИЗ СИМПТОМОВ                  │
│  Обнаруженные симптомы:            │
│  • Температура 38.5°C              │
│  • Кашель                          │
│  • Слабость                        │
│                                    │
│  Вероятность заболеваний:          │
│  • Грипп: 78.2%                    │
│  • ОРВИ: 15.3%                     │
├────────────────────────────────────┤
│  КОМБИНИРОВАННЫЙ ДИАГНОЗ           │
│  Наиболее вероятный:               │
│  Пневмония (общая вероятность 86.7%)│
│                                    │
│  Уровень уверенности: ВЫСОКИЙ      │
├────────────────────────────────────┤
│  РЕКОМЕНДАЦИИ                      │
│  ⚠ Срочно обратитесь к пульмонологу│
│  • Рекомендован анализ крови       │
│  • Повторный рентген через 2 недели│
├────────────────────────────────────┤
│  ДИСКЛЕЙМЕР                        │
│  ⚠ Результаты ИИ-анализа не        │
│  заменяют консультацию врача       │
├────────────────────────────────────┤
│  FOOTER                            │
│  Система: Medical Diagnosis AI     │
│  Версия: ResNet-50 v2.3, BERT v1.1 │
│  Время обработки: 2.3 сек          │
│  Подпись: [Digital Signature]      │
└────────────────────────────────────┘
</code></pre>
<h2 id="Пример-кода-генерации-pdf"><a class="header" href="#Пример-кода-генерации-pdf">Пример кода генерации PDF</a></h2>
<pre><code class="language-python">from jinja2 import Template
import pdfkit

def generate_pdf_report(result_data, patient_data, heatmap_path):
    # Load HTML template
    with open('templates/report_template.html') as f:
        template = Template(f.read())
    
    # Prepare data
    context = {
        'patient': patient_data,
        'image_predictions': result_data['imagePredictions'],
        'text_predictions': result_data['textPredictions'],
        'combined_diagnosis': result_data['combinedDiagnosis'],
        'heatmap_url': heatmap_path,
        'processing_time': result_data['processingTime'],
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    }
    
    # Render HTML
    html_content = template.render(context)
    
    # Generate PDF
    options = {
        'page-size': 'A4',
        'encoding': 'UTF-8',
        'enable-local-file-access': None,
        'dpi': 300
    }
    
    pdf_bytes = pdfkit.from_string(html_content, False, options=options)
    
    # Upload to S3
    s3_url = upload_to_s3(pdf_bytes, f'reports/{patient_data["id"]}.pdf')
    
    return s3_url
</code></pre>
<h2 id="Интеграция-с-mis"><a class="header" href="#Интеграция-с-mis">Интеграция с MIS</a></h2>
<pre><code class="language-python">def send_to_mis(report_data, mis_endpoint):
    # Create FHIR DiagnosticReport
    fhir_report = {
        "resourceType": "DiagnosticReport",
        "status": "final",
        "category": [{
            "coding": [{
                "system": "http://terminology.hl7.org/CodeSystem/v2-0074",
                "code": "RAD",
                "display": "Radiology"
            }]
        }],
        "code": {
            "coding": [{
                "system": "http://loinc.org",
                "code": "30954-2",
                "display": "Chest X-ray"
            }]
        },
        "subject": {
            "reference": f"Patient/{report_data['patientId']}"
        },
        "conclusion": report_data['combinedDiagnosis'][0]['disease'],
        "conclusionCode": [{
            "coding": [{
                "system": "http://hl7.org/fhir/sid/icd-10",
                "code": report_data['icd10Code']
            }]
        }]
    }
    
    # Send via REST API
    response = requests.post(
        f"{mis_endpoint}/DiagnosticReport",
        json=fhir_report,
        headers={
            'Authorization': f'Bearer {oauth_token}',
            'Content-Type': 'application/fhir+json'
        },
        timeout=30
    )
    
    return response.json()
</code></pre>
<h2 id="Метрики-производительности-3"><a class="header" href="#Метрики-производительности-3">Метрики производительности</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее</th></tr></thead><tbody>
<tr><td>PDF generation</td><td>&lt; 2 sec</td><td>1.5 sec</td></tr>
<tr><td>File size</td><td>&lt; 5 MB</td><td>3.2 MB</td></tr>
<tr><td>MIS integration</td><td>&lt; 5 sec</td><td>3.8 sec</td></tr>
<tr><td>Email delivery</td><td>&lt; 30 sec</td><td>15 sec</td></tr>
<tr><td>Success rate</td><td>&gt; 99%</td><td>99.7%</td></tr>
</tbody></table>
</div>
<h2 id="Источники-4"><a class="header" href="#Источники-4">Источники</a></h2>
<ul>
<li>PDFKit Documentation</li>
<li>FHIR DiagnosticReport Specification</li>
<li>ICD-10 Classification</li>
<li>wkhtmltopdf Manual</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="313-idef3-Диаграммы"><a class="header" href="#313-idef3-Диаграммы">3.1.3. IDEF3 Диаграммы</a></h1>
<h2 id="Описание-методологии-1"><a class="header" href="#Описание-методологии-1">Описание методологии</a></h2>
<p>IDEF3 (Process Description Capture Method) — методология описания процессов, фокусирующаяся на последовательности действий и временных связях между ними.</p>
<p><img src="architecture/../img/diagrams/idef3-p1.png" alt="IDEF3 Диаграмма" /></p>
<h2 id="Процессы-системы-4-функции"><a class="header" href="#Процессы-системы-4-функции">Процессы системы (4 функции)</a></h2>
<h3 id="p1-Регистрация-пациента"><a class="header" href="#p1-Регистрация-пациента">P1: Регистрация пациента</a></h3>
<p><strong>Описание:</strong> Создание учётной записи и аутентификация</p>
<p><strong>Этапы:</strong></p>
<ol>
<li>Пациент заполняет форму регистрации</li>
<li>Система валидирует данные</li>
<li>AuthController создаёт запись в PostgreSQL</li>
<li>Система отправляет письмо подтверждения</li>
<li>Пациент активирует аккаунт</li>
</ol>
<p><strong>Компоненты:</strong></p>
<ul>
<li>React (интерфейс)</li>
<li>Keycloak (аутентификация)</li>
<li>PostgreSQL (хранение данных)</li>
</ul>
<p><strong>Временные связи:</strong></p>
<ul>
<li>Последовательное выполнение</li>
<li>Активация возможна только после подтверждения email</li>
</ul>
<hr />
<h3 id="p2-Загрузка-данных"><a class="header" href="#p2-Загрузка-данных">P2: Загрузка данных</a></h3>
<p><strong>Описание:</strong> Приём и сохранение медицинских данных</p>
<p><strong>Этапы:</strong></p>
<ol>
<li>Пациент выбирает файлы</li>
<li>Web-интерфейс отправляет POST запрос</li>
<li>API Gateway валидирует формат и размер</li>
<li>DataUploadController сохраняет в S3</li>
<li>Сообщение отправляется в RabbitMQ</li>
</ol>
<p><strong>Компоненты:</strong></p>
<ul>
<li>Nginx (балансировка)</li>
<li>API Gateway (валидация)</li>
<li>AWS S3 (хранение)</li>
<li>RabbitMQ (очередь)</li>
</ul>
<p><strong>Временные связи:</strong></p>
<ul>
<li>P1 → P2: Регистрация обязательна для загрузки</li>
<li>Параллельная загрузка изображений и текста</li>
</ul>
<hr />
<h3 id="p3-gpu-обработка"><a class="header" href="#p3-gpu-обработка">P3: GPU-обработка</a></h3>
<p><strong>Описание:</strong> Анализ данных с использованием ИИ-моделей</p>
<p><strong>Этапы:</strong></p>
<ol>
<li>ML Service получает сообщение из RabbitMQ</li>
<li>ImagePreprocessor обрабатывает изображение</li>
<li>BERTTokenizer обрабатывает текст</li>
<li>Параллельный запуск ResNet-50 и BERT</li>
<li>Агрегация результатов</li>
<li>Сохранение в Redis и PostgreSQL</li>
</ol>
<p><strong>Компоненты:</strong></p>
<ul>
<li>TensorFlow Serving (inference)</li>
<li>GPU кластер (вычисления)</li>
<li>Redis (кэш)</li>
<li>PostgreSQL (постоянное хранилище)</li>
</ul>
<p><strong>Временные связи:</strong></p>
<ul>
<li>P2 → P3: Данные обрабатываются после валидации</li>
<li>Параллельное выполнение анализа изображений и текста</li>
</ul>
<hr />
<h3 id="p4-Логирование-и-мониторинг"><a class="header" href="#p4-Логирование-и-мониторинг">P4: Логирование и мониторинг</a></h3>
<p><strong>Описание:</strong> Сбор и анализ логов системы</p>
<p><strong>Этапы:</strong></p>
<ol>
<li>Сервисы генерируют логи</li>
<li>Filebeat собирает логи</li>
<li>Logstash обрабатывает и фильтрует</li>
<li>Elasticsearch индексирует данные</li>
<li>Kibana визуализирует метрики</li>
</ol>
<p><strong>Компоненты:</strong></p>
<ul>
<li>Filebeat (сбор логов)</li>
<li>Logstash (обработка)</li>
<li>Elasticsearch (хранение)</li>
<li>Kibana (визуализация)</li>
</ul>
<p><strong>Временные связи:</strong></p>
<ul>
<li>Непрерывное выполнение параллельно всем процессам</li>
<li>Реакция на критические ошибки в реальном времени</li>
</ul>
<hr />
<h2 id="Особенности-временных-связей"><a class="header" href="#Особенности-временных-связей">Особенности временных связей</a></h2>
<ul>
<li><strong>Последовательность:</strong> P1 → P2 → P3 (основной flow)</li>
<li><strong>Параллельность:</strong> P4 выполняется независимо</li>
<li><strong>Синхронизация:</strong> Результаты P3 доступны только после завершения обработки</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="313-idef3-Процесс-p1--Регистрация-пациента"><a class="header" href="#313-idef3-Процесс-p1--Регистрация-пациента">3.1.3. IDEF3: Процесс P1 — Регистрация пациента</a></h1>
<h2 id="Диаграмма-процесса-p1"><a class="header" href="#Диаграмма-процесса-p1">Диаграмма процесса P1</a></h2>
<p><img src="architecture/../img/diagrams/idef3-p1.png" alt="Диаграмма" /></p>
<h2 id="Описание-процесса-p1"><a class="header" href="#Описание-процесса-p1">Описание процесса P1</a></h2>
<h3 id="Участники"><a class="header" href="#Участники">Участники</a></h3>
<ul>
<li><strong>Пациент</strong> — инициирует регистрацию</li>
<li><strong>Web UI (React)</strong> — отображает форму</li>
<li><strong>Auth Service</strong> — обрабатывает регистрацию</li>
<li><strong>PostgreSQL</strong> — хранит данные пользователей</li>
<li><strong>Email Service</strong> — отправляет письмо</li>
</ul>
<h3 id="Временные-связи"><a class="header" href="#Временные-связи">Временные связи</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Событие</th><th>Последующее событие</th><th>Условие</th><th>Задержка</th></tr></thead><tbody>
<tr><td>E2 → E3</td><td>Валидация успешна</td><td>Email корректен</td><td>50 мс</td></tr>
<tr><td>E3 → E4</td><td>Email уникален</td><td>Нет дубликатов</td><td>100 мс</td></tr>
<tr><td>E4 → E5</td><td>Пароль захеширован</td><td>BCrypt</td><td>200 мс</td></tr>
<tr><td>E7 → E11</td><td>Письмо доставлено</td><td>SMTP успех</td><td>5-30 сек</td></tr>
<tr><td>E11 → E12</td><td>Токен валиден</td><td>Не истёк</td><td>100 мс</td></tr>
</tbody></table>
</div>
<h3 id="Точки-синхронизации"><a class="header" href="#Точки-синхронизации">Точки синхронизации</a></h3>
<ul>
<li><strong>После E3</strong>: Обязательна проверка уникальности</li>
<li><strong>После E7</strong>: Асинхронное ожидание действия пользователя</li>
<li><strong>После E11</strong>: Проверка валидности токена</li>
</ul>
<h3 id="uob-unit-of-behavior"><a class="header" href="#uob-unit-of-behavior">UOB (Unit of Behavior)</a></h3>
<p><strong>UOB-1: Валидация данных</strong></p>
<ul>
<li>Input: Email, Password</li>
<li>Process: Regex validation</li>
<li>Output: Валидированные данные или ошибка</li>
</ul>
<p><strong>UOB-2: Проверка уникальности</strong></p>
<ul>
<li>Input: Email</li>
<li>Process: SELECT FROM users WHERE email=?</li>
<li>Output: Boolean (exists/not exists)</li>
</ul>
<p><strong>UOB-3: Создание пользователя</strong></p>
<ul>
<li>Input: User data</li>
<li>Process: Hash password, INSERT INTO users</li>
<li>Output: User ID</li>
</ul>
<p><strong>UOB-4: Отправка письма</strong></p>
<ul>
<li>Input: Email, Token</li>
<li>Process: SMTP send</li>
<li>Output: Message ID</li>
</ul>
<h3 id="Временная-диаграмма"><a class="header" href="#Временная-диаграмма">Временная диаграмма</a></h3>
<pre><code>t=0s    Начало регистрации
t=0.5s  Валидация email
t=0.6s  Проверка уникальности
t=0.8s  Хеширование пароля
t=1.0s  Сохранение в БД
t=1.1s  Генерация токена
t=1.2s  Отправка письма
t=5-30s Доставка письма (асинхронно)
...     Ожидание действия пользователя
t=X     Клик по ссылке
t=X+0.1s Активация аккаунта
t=X+0.2s Конец процесса
</code></pre>
<h2 id="Источники-5"><a class="header" href="#Источники-5">Источники</a></h2>
<ul>
<li>IDEF3 Process Description Capture Method</li>
<li>Spring Security Documentation</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="313-idef3-Процесс-p2--Загрузка-медицинских-данных"><a class="header" href="#313-idef3-Процесс-p2--Загрузка-медицинских-данных">3.1.3. IDEF3: Процесс P2 — Загрузка медицинских данных</a></h1>
<h2 id="Диаграмма-процесса-p2"><a class="header" href="#Диаграмма-процесса-p2">Диаграмма процесса P2</a></h2>
<p><img src="architecture/../img/diagrams/idef3-p2.png" alt="Диаграмма" /></p>
<h2 id="Временные-характеристики"><a class="header" href="#Временные-характеристики">Временные характеристики</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Этап</th><th>Среднее время</th><th>P95</th></tr></thead><tbody>
<tr><td>Валидация формата</td><td>10 мс</td><td>25 мс</td></tr>
<tr><td>Загрузка в S3 (5MB)</td><td>500 мс</td><td>1200 мс</td></tr>
<tr><td>Сохранение метаданных</td><td>50 мс</td><td>120 мс</td></tr>
<tr><td>Отправка в RabbitMQ</td><td>10 мс</td><td>30 мс</td></tr>
<tr><td><strong>Итого</strong></td><td><strong>570 мс</strong></td><td><strong>1375 мс</strong></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="313-idef3-Процесс-p3--gpu-обработка-данных"><a class="header" href="#313-idef3-Процесс-p3--gpu-обработка-данных">3.1.3. IDEF3: Процесс P3 — GPU-обработка данных</a></h1>
<h2 id="Диаграмма-процесса-p3"><a class="header" href="#Диаграмма-процесса-p3">Диаграмма процесса P3</a></h2>
<p><img src="architecture/../img/diagrams/idef3-p3.png" alt="Диаграмма" /></p>
<h2 id="Временные-характеристики-gpu"><a class="header" href="#Временные-характеристики-gpu">Временные характеристики GPU</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Этап</th><th>GPU Time</th><th>CPU Time</th></tr></thead><tbody>
<tr><td>ResNet-50 inference</td><td>30 мс</td><td>450 мс</td></tr>
<tr><td>BERT inference</td><td>75 мс</td><td>890 мс</td></tr>
<tr><td>Grad-CAM generation</td><td>50 мс</td><td>N/A</td></tr>
<tr><td><strong>Параллельно</strong></td><td><strong>75 мс</strong></td><td><strong>890 мс</strong></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="313-idef3-Процесс-p4--Логирование-и-мониторинг"><a class="header" href="#313-idef3-Процесс-p4--Логирование-и-мониторинг">3.1.3. IDEF3: Процесс P4 — Логирование и мониторинг</a></h1>
<h2 id="Диаграмма-процесса-p4"><a class="header" href="#Диаграмма-процесса-p4">Диаграмма процесса P4</a></h2>
<p><img src="architecture/../img/diagrams/idef3-p4.png" alt="Диаграмма" /></p>
<h2 id="Логирование-происходит-параллельно-всем-процессам"><a class="header" href="#Логирование-происходит-параллельно-всем-процессам">Логирование происходит параллельно всем процессам!</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="314-dfd-Диаграммы-data-flow-diagram"><a class="header" href="#314-dfd-Диаграммы-data-flow-diagram">3.1.4. DFD Диаграммы (Data Flow Diagram)</a></h1>
<h2 id="Описание-методологии-2"><a class="header" href="#Описание-методологии-2">Описание методологии</a></h2>
<p>DFD (Data Flow Diagram) — методология моделирования потоков данных в информационной системе, показывающая, как данные перемещаются между процессами, хранилищами и внешними сущностями.</p>
<p><img src="architecture/../img/diagrams/dfd-p1.png" alt="DFD Диаграмма" /></p>
<h2 id="Процессы-системы-4-функции-1"><a class="header" href="#Процессы-системы-4-функции-1">Процессы системы (4 функции)</a></h2>
<h3 id="p1-Приём-данных"><a class="header" href="#p1-Приём-данных">P1: Приём данных</a></h3>
<p><strong>Описание:</strong> Получение медицинских данных от пациента</p>
<p><strong>Входные потоки:</strong></p>
<ul>
<li>HTTP POST запрос от пациента</li>
<li>Multipart/form-data (изображения + текст)</li>
</ul>
<p><strong>Выходные потоки:</strong></p>
<ul>
<li>Сообщение в очередь RabbitMQ</li>
<li>Подтверждение получения (JSON)</li>
</ul>
<p><strong>Компоненты:</strong></p>
<ul>
<li>Nginx (точка входа)</li>
<li>API Gateway (обработка)</li>
</ul>
<p><strong>Хранилища:</strong></p>
<ul>
<li>AWS S3 (сырые файлы)</li>
</ul>
<hr />
<h3 id="p2-Валидация-данных"><a class="header" href="#p2-Валидация-данных">P2: Валидация данных</a></h3>
<p><strong>Описание:</strong> Проверка корректности входных данных</p>
<p><strong>Входные потоки:</strong></p>
<ul>
<li>Multipart/form-data из P1</li>
<li>Правила валидации из PostgreSQL</li>
</ul>
<p><strong>Выходные потоки:</strong></p>
<ul>
<li>Валидированные данные → P3</li>
<li>Ошибки валидации → Пациент</li>
</ul>
<p><strong>Компоненты:</strong></p>
<ul>
<li>Spring Validator</li>
<li>DataUploadController</li>
</ul>
<p><strong>Правила валидации:</strong></p>
<ul>
<li>Формат файлов (JPEG/PNG)</li>
<li>Размер ≤ 10 МБ</li>
<li>Структура JSON для симптомов</li>
</ul>
<hr />
<h3 id="p3-ИИ-анализ"><a class="header" href="#p3-ИИ-анализ">P3: ИИ-анализ</a></h3>
<p><strong>Описание:</strong> Обработка данных моделями машинного обучения</p>
<p><strong>Входные потоки:</strong></p>
<ul>
<li>Тензоры изображений (224x224x3)</li>
<li>Токены BERT</li>
<li>Параметры моделей из конфигурации</li>
</ul>
<p><strong>Выходные потоки:</strong></p>
<ul>
<li>JSON-результаты → Redis (кэш)</li>
<li>JSON-результаты → PostgreSQL (постоянное хранение)</li>
<li>Метрики → Prometheus</li>
</ul>
<p><strong>Компоненты:</strong></p>
<ul>
<li>TensorFlow Serving</li>
<li>ResNet-50 модель</li>
<li>BERT модель</li>
<li>GPU кластер</li>
</ul>
<p><strong>Хранилища:</strong></p>
<ul>
<li>Redis (TTL = 1 час)</li>
<li>PostgreSQL (таблица <code>results</code>)</li>
</ul>
<hr />
<h3 id="p4-Логирование"><a class="header" href="#p4-Логирование">P4: Логирование</a></h3>
<p><strong>Описание:</strong> Сбор и хранение логов всех процессов</p>
<p><strong>Входные потоки:</strong></p>
<ul>
<li>Логи от P1, P2, P3</li>
<li>Системные метрики (CPU, память, GPU)</li>
<li>Ошибки и предупреждения</li>
</ul>
<p><strong>Выходные потоки:</strong></p>
<ul>
<li>Индексированные логи → Elasticsearch</li>
<li>Алерты → DevOps команда (Slack/Email)</li>
</ul>
<p><strong>Компоненты:</strong></p>
<ul>
<li>Filebeat (агент сбора)</li>
<li>Logstash (обработка)</li>
<li>Elasticsearch (индексация)</li>
<li>Kibana (визуализация)</li>
</ul>
<p><strong>Хранилища:</strong></p>
<ul>
<li>Elasticsearch (логи за 30 дней)</li>
</ul>
<hr />
<h2 id="Хранилища-данных"><a class="header" href="#Хранилища-данных">Хранилища данных</a></h2>
<h3 id="d1-aws-s3"><a class="header" href="#d1-aws-s3">D1: AWS S3</a></h3>
<ul>
<li><strong>Тип:</strong> Object Storage</li>
<li><strong>Данные:</strong> Сырые медицинские изображения</li>
<li><strong>Доступ:</strong> P1 (запись), P3 (чтение при необходимости)</li>
</ul>
<h3 id="d2-postgresql"><a class="header" href="#d2-postgresql">D2: PostgreSQL</a></h3>
<ul>
<li><strong>Тип:</strong> Реляционная БД</li>
<li><strong>Данные:</strong>
<ul>
<li>Метаданные пациентов</li>
<li>Результаты диагностики</li>
<li>История запросов</li>
</ul>
</li>
<li><strong>Доступ:</strong> Все процессы</li>
</ul>
<h3 id="d3-redis"><a class="header" href="#d3-redis">D3: Redis</a></h3>
<ul>
<li><strong>Тип:</strong> In-memory cache</li>
<li><strong>Данные:</strong> Кэшированные результаты ИИ</li>
<li><strong>Доступ:</strong> P3 (запись), API (чтение)</li>
</ul>
<h3 id="d4-elasticsearch"><a class="header" href="#d4-elasticsearch">D4: Elasticsearch</a></h3>
<ul>
<li><strong>Тип:</strong> Поисковый движок</li>
<li><strong>Данные:</strong> Логи и метрики</li>
<li><strong>Доступ:</strong> P4 (запись), Kibana (чтение)</li>
</ul>
<hr />
<h2 id="Внешние-сущности"><a class="header" href="#Внешние-сущности">Внешние сущности</a></h2>
<ul>
<li><strong>Пациент:</strong> Инициирует запросы, получает результаты</li>
<li><strong>Clinic MIS:</strong> Получает отчёты через REST API</li>
<li><strong>Администратор:</strong> Управляет системой через административную панель</li>
<li><strong>DevOps:</strong> Получает алерты и мониторит систему</li>
</ul>
<hr />
<h2 id="Источники-6"><a class="header" href="#Источники-6">Источники</a></h2>
<ul>
<li>«Structured Analysis and System Specification» Tom DeMarco</li>
<li><a href="https://www.visual-paradigm.com/guide/data-flow-diagram/">DFD Best Practices</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="314-dfd-Процесс-p1--Приём-данных"><a class="header" href="#314-dfd-Процесс-p1--Приём-данных">3.1.4. DFD: Процесс P1 — Приём данных</a></h1>
<h2 id="Диаграмма-потоков-данных-p1"><a class="header" href="#Диаграмма-потоков-данных-p1">Диаграмма потоков данных P1</a></h2>
<p><img src="architecture/../img/diagrams/dfd-p1.png" alt="Диаграмма" /></p>
<h2 id="Потоки-данных-1"><a class="header" href="#Потоки-данных-1">Потоки данных</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Поток</th><th>Источник</th><th>Назначение</th><th>Данные</th><th>Формат</th></tr></thead><tbody>
<tr><td>1</td><td>Пациент</td><td>P1</td><td>Файлы + метаданные</td><td>multipart/form-data</td></tr>
<tr><td>2</td><td>P1</td><td>AWS S3</td><td>Binary file</td><td>JPEG/PNG</td></tr>
<tr><td>3</td><td>P1</td><td>PostgreSQL</td><td>user_id, file_name, s3_url</td><td>SQL INSERT</td></tr>
<tr><td>4</td><td>P1</td><td>RabbitMQ</td><td>{fileId, s3Url, type}</td><td>JSON/AMQP</td></tr>
<tr><td>5</td><td>P1</td><td>Пациент</td><td>{taskId, status}</td><td>JSON/HTTP</td></tr>
</tbody></table>
</div>
<h2 id="Хранилища-данных-1"><a class="header" href="#Хранилища-данных-1">Хранилища данных</a></h2>
<p><strong>D1: AWS S3</strong></p>
<ul>
<li>Bucket: medical-images-raw</li>
<li>Key format: {userId}/{fileId}.jpg</li>
<li>Access: Private (signed URLs)</li>
</ul>
<p><strong>D2: PostgreSQL - таблица medical_data</strong></p>
<pre><code class="language-sql">CREATE TABLE medical_data (
    id UUID PRIMARY KEY,
    user_id BIGINT,
    file_name VARCHAR(255),
    s3_url TEXT,
    uploaded_at TIMESTAMP
);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="314-dfd-Процесс-p2--Валидация-данных"><a class="header" href="#314-dfd-Процесс-p2--Валидация-данных">3.1.4. DFD: Процесс P2 — Валидация данных</a></h1>
<h2 id="Диаграмма-потоков-данных-p2"><a class="header" href="#Диаграмма-потоков-данных-p2">Диаграмма потоков данных P2</a></h2>
<p><img src="architecture/../img/diagrams/dfd-p2.png" alt="Диаграмма" /></p>
<h2 id="Правила-валидации"><a class="header" href="#Правила-валидации">Правила валидации</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Правило</th><th>Проверка</th><th>Действие при ошибке</th></tr></thead><tbody>
<tr><td>Формат файла</td><td>MIME-type in [image/jpeg, image/png]</td><td>Reject: INVALID_FORMAT</td></tr>
<tr><td>Размер</td><td>≤ 10 MB</td><td>Reject: FILE_TOO_LARGE</td></tr>
<tr><td>Текст</td><td>Valid JSON or Plain text</td><td>Reject: INVALID_TEXT</td></tr>
<tr><td>Rate limit</td><td>≤ 100 req/min per user</td><td>Reject: RATE_LIMIT_EXCEEDED</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="314-dfd-Процесс-p3--ИИ-анализ"><a class="header" href="#314-dfd-Процесс-p3--ИИ-анализ">3.1.4. DFD: Процесс P3 — ИИ-анализ</a></h1>
<h2 id="Диаграмма-потоков-данных-p3"><a class="header" href="#Диаграмма-потоков-данных-p3">Диаграмма потоков данных P3</a></h2>
<p><img src="architecture/../img/diagrams/dfd-p3.png" alt="Диаграмма" /></p>
<h2 id="Структура-результатов"><a class="header" href="#Структура-результатов">Структура результатов</a></h2>
<pre><code class="language-json">{
  "taskId": "uuid",
  "imagePredictions": [
    {"disease": "Pneumonia", "probability": 0.952}
  ],
  "textPredictions": [
    {"disease": "Flu", "probability": 0.782}
  ],
  "processingTime": 2.3
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="314-dfd-Процесс-p4--Логирование"><a class="header" href="#314-dfd-Процесс-p4--Логирование">3.1.4. DFD: Процесс P4 — Логирование</a></h1>
<h2 id="Диаграмма-потоков-данных-p4"><a class="header" href="#Диаграмма-потоков-данных-p4">Диаграмма потоков данных P4</a></h2>
<p><img src="architecture/../img/diagrams/dfd-p4.png" alt="Диаграмма" /></p>
<h2 id="Структура-лог-записи"><a class="header" href="#Структура-лог-записи">Структура лог записи</a></h2>
<pre><code class="language-json">{
  "timestamp": "2024-10-14T10:30:00Z",
  "level": "INFO",
  "service": "ml-inference",
  "message": "Inference completed",
  "taskId": "abc-123",
  "duration": 2300,
  "userId": 42
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="315-bpmn-Диаграммы"><a class="header" href="#315-bpmn-Диаграммы">3.1.5. BPMN Диаграммы</a></h1>
<h2 id="Описание-методологии-3"><a class="header" href="#Описание-методологии-3">Описание методологии</a></h2>
<p>BPMN (Business Process Model and Notation) — стандарт нотации для моделирования бизнес-процессов, разработанный OMG (Object Management Group).</p>
<h2 id="bpmn-process-overview-Общий-обзор"><a class="header" href="#bpmn-process-overview-Общий-обзор">BPMN Process Overview (Общий обзор)</a></h2>
<p><img src="architecture/../img/diagrams/bpmn-1.png" alt="BPMN Process Overview" /></p>
<h2 id="Сценарий-1-Регистрация-пациента"><a class="header" href="#Сценарий-1-Регистрация-пациента">Сценарий 1: Регистрация пациента</a></h2>
<h3 id="Участники-pools"><a class="header" href="#Участники-pools">Участники (Pools)</a></h3>
<ul>
<li><strong>Пациент</strong></li>
<li><strong>Система диагностики</strong></li>
<li><strong>Email-сервис</strong></li>
</ul>
<h3 id="Процесс"><a class="header" href="#Процесс">Процесс</a></h3>
<ol>
<li><strong>Старт:</strong> Пациент открывает форму регистрации</li>
<li><strong>Задача:</strong> Заполнение формы (email, пароль)</li>
<li><strong>Шлюз (XOR):</strong> Проверка email
<ul>
<li><strong>Валидный:</strong> Продолжить регистрацию</li>
<li><strong>Невалидный:</strong> Показать ошибку → возврат к заполнению</li>
</ul>
</li>
<li><strong>Задача:</strong> Создание записи в PostgreSQL</li>
<li><strong>Задача:</strong> Отправка письма подтверждения (Email-сервис)</li>
<li><strong>Событие:</strong> Ожидание клика по ссылке</li>
<li><strong>Задача:</strong> Активация аккаунта</li>
<li><strong>Конец:</strong> Успешная регистрация</li>
</ol>
<h3 id="Особенности"><a class="header" href="#Особенности">Особенности</a></h3>
<ul>
<li><strong>Шлюз исключающий (XOR):</strong> Только один путь выполняется</li>
<li><strong>Пулы:</strong> Разделение ответственности между участниками</li>
<li><strong>События:</strong> Временное ожидание действия пользователя</li>
</ul>
<hr />
<h2 id="Сценарий-2-Загрузка-данных"><a class="header" href="#Сценарий-2-Загрузка-данных">Сценарий 2: Загрузка данных</a></h2>
<h3 id="Участники-1"><a class="header" href="#Участники-1">Участники</a></h3>
<ul>
<li><strong>Пациент</strong></li>
<li><strong>API Gateway</strong></li>
<li><strong>Storage Service (S3)</strong></li>
<li><strong>Message Broker (RabbitMQ)</strong></li>
</ul>
<h3 id="Процесс-1"><a class="header" href="#Процесс-1">Процесс</a></h3>
<ol>
<li><strong>Старт:</strong> Пациент нажимает "Загрузить данные"</li>
<li><strong>Задача:</strong> Выбор файлов (изображения/текст)</li>
<li><strong>Шлюз (XOR):</strong> Проверка формата файла
<ul>
<li><strong>JPEG/PNG:</strong> Продолжить</li>
<li><strong>Другой формат:</strong> Показать ошибку</li>
</ul>
</li>
<li><strong>Шлюз (XOR):</strong> Проверка размера
<ul>
<li><strong>≤ 10 МБ:</strong> Продолжить</li>
<li><strong>&gt; 10 МБ:</strong> Показать ошибку</li>
</ul>
</li>
<li><strong>Задача:</strong> Сохранение в S3</li>
<li><strong>Задача:</strong> Отправка сообщения в RabbitMQ</li>
<li><strong>Событие:</strong> Подтверждение получения</li>
<li><strong>Конец:</strong> Данные загружены</li>
</ol>
<h3 id="Особенности-1"><a class="header" href="#Особенности-1">Особенности</a></h3>
<ul>
<li><strong>Последовательные шлюзы:</strong> Многоуровневая валидация</li>
<li><strong>Асинхронность:</strong> RabbitMQ обрабатывает данные независимо</li>
</ul>
<hr />
<h2 id="Сценарий-3-ИИ-анализ-параллельная-обработка"><a class="header" href="#Сценарий-3-ИИ-анализ-параллельная-обработка">Сценарий 3: ИИ-анализ (параллельная обработка)</a></h2>
<h3 id="Участники-2"><a class="header" href="#Участники-2">Участники</a></h3>
<ul>
<li><strong>ML Inference Service</strong></li>
<li><strong>GPU Cluster</strong></li>
<li><strong>Cache (Redis)</strong></li>
<li><strong>Database (PostgreSQL)</strong></li>
</ul>
<h3 id="Процесс-2"><a class="header" href="#Процесс-2">Процесс</a></h3>
<ol>
<li><strong>Старт:</strong> Получение сообщения из RabbitMQ</li>
<li><strong>Шлюз (AND/Parallel):</strong> Параллельная обработка
<ul>
<li><strong>Ветка 1: Обработка изображения</strong>
<ul>
<li>Препроцессинг (OpenCV)</li>
<li>ResNet-50 inference</li>
</ul>
</li>
<li><strong>Ветка 2: Обработка текста</strong>
<ul>
<li>Токенизация (BERT Tokenizer)</li>
<li>BERT inference</li>
</ul>
</li>
</ul>
</li>
<li><strong>Шлюз (AND/Join):</strong> Ожидание завершения обеих веток</li>
<li><strong>Задача:</strong> Агрегация результатов</li>
<li><strong>Шлюз (AND/Parallel):</strong> Параллельное сохранение
<ul>
<li><strong>Ветка 1:</strong> Сохранение в Redis (кэш)</li>
<li><strong>Ветка 2:</strong> Сохранение в PostgreSQL (постоянное хранилище)</li>
</ul>
</li>
<li><strong>Конец:</strong> Результаты готовы</li>
</ol>
<h3 id="Особенности-2"><a class="header" href="#Особенности-2">Особенности</a></h3>
<ul>
<li><strong>Параллельный шлюз (AND):</strong> Обе ветки выполняются одновременно</li>
<li><strong>Синхронизация:</strong> Агрегация только после завершения обеих задач</li>
<li><strong>GPU-оптимизация:</strong> Batch processing для ResNet и BERT</li>
</ul>
<hr />
<h2 id="Сценарий-4-Интеграция-с-mis-clinic-management-information-system"><a class="header" href="#Сценарий-4-Интеграция-с-mis-clinic-management-information-system">Сценарий 4: Интеграция с MIS (Clinic Management Information System)</a></h2>
<h3 id="Участники-3"><a class="header" href="#Участники-3">Участники</a></h3>
<ul>
<li><strong>Система диагностики</strong></li>
<li><strong>Report Generator</strong></li>
<li><strong>Clinic MIS</strong></li>
<li><strong>Администратор</strong></li>
</ul>
<h3 id="Процесс-3"><a class="header" href="#Процесс-3">Процесс</a></h3>
<ol>
<li><strong>Старт:</strong> Результаты ИИ-анализа готовы</li>
<li><strong>Задача:</strong> Генерация PDF-отчёта (PDFKit)</li>
<li><strong>Задача:</strong> Формирование JSON для API</li>
<li><strong>Шлюз (XOR):</strong> Проверка доступности MIS
<ul>
<li><strong>Доступен:</strong> Отправить отчёт</li>
<li><strong>Недоступен:</strong> Сохранить в очередь ожидания</li>
</ul>
</li>
<li><strong>Задача:</strong> POST запрос к MIS API</li>
<li><strong>Шлюз (XOR):</strong> Проверка ответа
<ul>
<li><strong>200 OK:</strong> Успешная отправка</li>
<li><strong>4xx/5xx:</strong> Повтор через 5 минут</li>
</ul>
</li>
<li><strong>Событие (таймер):</strong> Ожидание перед повтором</li>
<li><strong>Задача:</strong> Уведомление администратора (если 3 неудачи)</li>
<li><strong>Конец:</strong> Отчёт доставлен</li>
</ol>
<h3 id="Особенности-3"><a class="header" href="#Особенности-3">Особенности</a></h3>
<ul>
<li><strong>Обработка ошибок:</strong> Retry mechanism с экспоненциальной задержкой</li>
<li><strong>Таймер-события:</strong> Автоматический повтор</li>
<li><strong>Эскалация:</strong> Уведомление администратора при критических ошибках</li>
</ul>
<hr />
<h2 id="Элементы-bpmn-использованные-в-диаграммах"><a class="header" href="#Элементы-bpmn-использованные-в-диаграммах">Элементы BPMN, использованные в диаграммах</a></h2>
<h3 id="События"><a class="header" href="#События">События</a></h3>
<ul>
<li><strong>Старт (Start Event):</strong> Начало процесса</li>
<li><strong>Конец (End Event):</strong> Завершение процесса</li>
<li><strong>Таймер (Timer Event):</strong> Временная задержка</li>
<li><strong>Сообщение (Message Event):</strong> Получение внешнего сообщения</li>
</ul>
<h3 id="Задачи"><a class="header" href="#Задачи">Задачи</a></h3>
<ul>
<li><strong>Задача пользователя (User Task):</strong> Требует действия человека</li>
<li><strong>Системная задача (Service Task):</strong> Автоматическое выполнение</li>
<li><strong>Отправка сообщения (Send Task):</strong> Асинхронная отправка</li>
</ul>
<h3 id="Шлюзы"><a class="header" href="#Шлюзы">Шлюзы</a></h3>
<ul>
<li><strong>Исключающий (XOR Gateway):</strong> Один путь из нескольких</li>
<li><strong>Параллельный (AND Gateway):</strong> Все пути одновременно</li>
<li><strong>Объединяющий (Join Gateway):</strong> Синхронизация параллельных веток</li>
</ul>
<h3 id="Пулы-и-дорожки"><a class="header" href="#Пулы-и-дорожки">Пулы и дорожки</a></h3>
<ul>
<li><strong>Пулы (Pools):</strong> Разные организации/системы</li>
<li><strong>Дорожки (Lanes):</strong> Роли внутри одной организации</li>
</ul>
<hr />
<h2 id="Детальные-bpmn-диаграммы"><a class="header" href="#Детальные-bpmn-диаграммы">Детальные BPMN диаграммы</a></h2>
<h3 id="Сценарий-1-Регистрация-пациента-1"><a class="header" href="#Сценарий-1-Регистрация-пациента-1">Сценарий 1: Регистрация пациента</a></h3>
<ul>
<li><a href="architecture/bpmn-scenario1.html">BPMN Сценарий 1: Регистрация пациента</a></li>
</ul>
<h3 id="Сценарий-2-Загрузка-данных-1"><a class="header" href="#Сценарий-2-Загрузка-данных-1">Сценарий 2: Загрузка данных</a></h3>
<ul>
<li><a href="architecture/bpmn-scenario2.html">BPMN Сценарий 2: Загрузка данных</a></li>
</ul>
<h3 id="Сценарий-3-ИИ-анализ-параллельная-обработка-1"><a class="header" href="#Сценарий-3-ИИ-анализ-параллельная-обработка-1">Сценарий 3: ИИ-анализ (параллельная обработка)</a></h3>
<ul>
<li><a href="architecture/bpmn-scenario3.html">BPMN Сценарий 3: ИИ-анализ</a></li>
</ul>
<h3 id="Сценарий-4-Интеграция-с-mis"><a class="header" href="#Сценарий-4-Интеграция-с-mis">Сценарий 4: Интеграция с MIS</a></h3>
<ul>
<li><a href="architecture/bpmn-scenario4.html">BPMN Сценарий 4: Интеграция с MIS</a></li>
</ul>
<h2 id="Источники-7"><a class="header" href="#Источники-7">Источники</a></h2>
<ul>
<li><a href="https://www.omg.org/spec/BPMN/2.0/">BPMN 2.0 Specification</a></li>
<li>«BPMN Method and Style» Bruce Silver</li>
<li><a href="https://camunda.com/bpmn/">Camunda BPMN Tutorial</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="315-bpmn-Сценарий-1-Регистрация-пациента"><a class="header" href="#315-bpmn-Сценарий-1-Регистрация-пациента">3.1.5. BPMN Сценарий 1: Регистрация пациента</a></h1>
<h2 id="Участники-pools-1"><a class="header" href="#Участники-pools-1">Участники (Pools)</a></h2>
<ul>
<li><strong>Пациент</strong></li>
<li><strong>Система диагностики</strong></li>
<li><strong>Email-сервис</strong></li>
</ul>
<h2 id="bpmn-Диаграмма"><a class="header" href="#bpmn-Диаграмма">BPMN Диаграмма</a></h2>
<p><img src="architecture/../img/diagrams/bpmn-1.png" alt="Диаграмма" /></p>
<h2 id="Процесс-4"><a class="header" href="#Процесс-4">Процесс</a></h2>
<ol>
<li><strong>Старт:</strong> Пациент открывает форму регистрации</li>
<li><strong>Задача:</strong> Заполнение формы (email, пароль, ФИО)</li>
<li><strong>Шлюз (XOR):</strong> Проверка email
<ul>
<li><strong>Валидный:</strong> Продолжить регистрацию</li>
<li><strong>Невалидный:</strong> Показать ошибку → возврат к заполнению</li>
</ul>
</li>
<li><strong>Задача:</strong> Проверка уникальности email</li>
<li><strong>Шлюз (XOR):</strong> Email уже существует?
<ul>
<li><strong>Да:</strong> Показать ошибку → возврат к заполнению</li>
<li><strong>Нет:</strong> Продолжить</li>
</ul>
</li>
<li><strong>Задача:</strong> Хеширование пароля BCrypt</li>
<li><strong>Задача:</strong> Создание записи в PostgreSQL</li>
<li><strong>Задача:</strong> Генерация токена активации</li>
<li><strong>Задача:</strong> Отправка письма подтверждения (Email-сервис)</li>
<li><strong>Событие:</strong> Ожидание клика по ссылке</li>
<li><strong>Задача:</strong> Активация аккаунта</li>
<li><strong>Конец:</strong> Успешная регистрация</li>
</ol>
<h2 id="Особенности-4"><a class="header" href="#Особенности-4">Особенности</a></h2>
<ul>
<li><strong>Шлюз исключающий (XOR):</strong> Только один путь выполняется</li>
<li><strong>Пулы:</strong> Разделение ответственности между участниками</li>
<li><strong>События:</strong> Временное ожидание действия пользователя</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="315-bpmn-Сценарий-2-Загрузка-данных"><a class="header" href="#315-bpmn-Сценарий-2-Загрузка-данных">3.1.5. BPMN Сценарий 2: Загрузка данных</a></h1>
<h2 id="Участники-4"><a class="header" href="#Участники-4">Участники</a></h2>
<ul>
<li><strong>Пациент</strong></li>
<li><strong>API Gateway</strong></li>
<li><strong>Storage Service (S3)</strong></li>
<li><strong>Message Broker (RabbitMQ)</strong></li>
</ul>
<h2 id="bpmn-Диаграмма-1"><a class="header" href="#bpmn-Диаграмма-1">BPMN Диаграмма</a></h2>
<p><img src="architecture/../img/diagrams/bpmn-2.png" alt="Диаграмма" /></p>
<h2 id="Процесс-5"><a class="header" href="#Процесс-5">Процесс</a></h2>
<ol>
<li><strong>Старт:</strong> Пациент нажимает "Загрузить данные"</li>
<li><strong>Задача:</strong> Выбор файлов (изображения/текст)</li>
<li><strong>Шлюз (XOR):</strong> Проверка формата файла
<ul>
<li><strong>JPEG/PNG/TXT:</strong> Продолжить</li>
<li><strong>Другой формат:</strong> Показать ошибку</li>
</ul>
</li>
<li><strong>Шлюз (XOR):</strong> Проверка размера
<ul>
<li><strong>≤ 10 МБ:</strong> Продолжить</li>
<li><strong>&gt; 10 МБ:</strong> Показать ошибку</li>
</ul>
</li>
<li><strong>Задача:</strong> Генерация уникального ID</li>
<li><strong>Задача:</strong> Сохранение в S3</li>
<li><strong>Задача:</strong> Отправка сообщения в RabbitMQ</li>
<li><strong>Событие:</strong> Подтверждение получения</li>
<li><strong>Конец:</strong> Данные загружены</li>
</ol>
<h2 id="Особенности-5"><a class="header" href="#Особенности-5">Особенности</a></h2>
<ul>
<li><strong>Последовательные шлюзы:</strong> Многоуровневая валидация</li>
<li><strong>Асинхронность:</strong> RabbitMQ обрабатывает данные независимо</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="315-bpmn-Сценарий-3-ИИ-анализ-параллельная-обработка"><a class="header" href="#315-bpmn-Сценарий-3-ИИ-анализ-параллельная-обработка">3.1.5. BPMN Сценарий 3: ИИ-анализ (параллельная обработка)</a></h1>
<h2 id="Участники-5"><a class="header" href="#Участники-5">Участники</a></h2>
<ul>
<li><strong>ML Inference Service</strong></li>
<li><strong>GPU Cluster</strong></li>
<li><strong>Cache (Redis)</strong></li>
<li><strong>Database (PostgreSQL)</strong></li>
</ul>
<h2 id="bpmn-Диаграмма-2"><a class="header" href="#bpmn-Диаграмма-2">BPMN Диаграмма</a></h2>
<p><img src="architecture/../img/diagrams/bpmn-3.png" alt="Диаграмма" /></p>
<h2 id="Процесс-6"><a class="header" href="#Процесс-6">Процесс</a></h2>
<ol>
<li><strong>Старт:</strong> Получение сообщения из RabbitMQ</li>
<li><strong>Шлюз (AND/Parallel):</strong> Параллельная обработка
<ul>
<li><strong>Ветка 1: Обработка изображения</strong>
<ul>
<li>Препроцессинг (OpenCV)</li>
<li>ResNet-50 inference</li>
</ul>
</li>
<li><strong>Ветка 2: Обработка текста</strong>
<ul>
<li>Токенизация (BERT Tokenizer)</li>
<li>BERT inference</li>
</ul>
</li>
</ul>
</li>
<li><strong>Шлюз (AND/Join):</strong> Ожидание завершения обеих веток</li>
<li><strong>Задача:</strong> Агрегация результатов</li>
<li><strong>Шлюз (AND/Parallel):</strong> Параллельное сохранение
<ul>
<li><strong>Ветка 1:</strong> Сохранение в Redis (кэш)</li>
<li><strong>Ветка 2:</strong> Сохранение в PostgreSQL (постоянное хранилище)</li>
</ul>
</li>
<li><strong>Конец:</strong> Результаты готовы</li>
</ol>
<h2 id="Особенности-6"><a class="header" href="#Особенности-6">Особенности</a></h2>
<ul>
<li><strong>Параллельный шлюз (AND):</strong> Обе ветки выполняются одновременно</li>
<li><strong>Синхронизация:</strong> Агрегация только после завершения обеих задач</li>
<li><strong>GPU-оптимизация:</strong> Batch processing для ResNet и BERT</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="315-bpmn-Сценарий-4-Интеграция-с-mis-clinic-management-information-system"><a class="header" href="#315-bpmn-Сценарий-4-Интеграция-с-mis-clinic-management-information-system">3.1.5. BPMN Сценарий 4: Интеграция с MIS (Clinic Management Information System)</a></h1>
<h2 id="Участники-6"><a class="header" href="#Участники-6">Участники</a></h2>
<ul>
<li><strong>Система диагностики</strong></li>
<li><strong>Report Generator</strong></li>
<li><strong>Clinic MIS</strong></li>
<li><strong>Администратор</strong></li>
</ul>
<h2 id="bpmn-Диаграмма-3"><a class="header" href="#bpmn-Диаграмма-3">BPMN Диаграмма</a></h2>
<p><img src="architecture/../img/diagrams/bpmn-4.png" alt="Диаграмма" /></p>
<h2 id="Процесс-7"><a class="header" href="#Процесс-7">Процесс</a></h2>
<ol>
<li><strong>Старт:</strong> Результаты ИИ-анализа готовы</li>
<li><strong>Задача:</strong> Генерация PDF-отчёта (PDFKit)</li>
<li><strong>Задача:</strong> Формирование JSON для API</li>
<li><strong>Шлюз (XOR):</strong> Проверка доступности MIS
<ul>
<li><strong>Доступен:</strong> Отправить отчёт</li>
<li><strong>Недоступен:</strong> Сохранить в очередь ожидания</li>
</ul>
</li>
<li><strong>Задача:</strong> POST запрос к MIS API</li>
<li><strong>Шлюз (XOR):</strong> Проверка ответа
<ul>
<li><strong>200 OK:</strong> Успешная отправка</li>
<li><strong>4xx/5xx:</strong> Повтор через 5 минут</li>
</ul>
</li>
<li><strong>Событие (таймер):</strong> Ожидание перед повтором</li>
<li><strong>Задача:</strong> Уведомление администратора (если 3 неудачи)</li>
<li><strong>Конец:</strong> Отчёт доставлен</li>
</ol>
<h2 id="Особенности-7"><a class="header" href="#Особенности-7">Особенности</a></h2>
<ul>
<li><strong>Обработка ошибок:</strong> Retry mechanism с экспоненциальной задержкой</li>
<li><strong>Таймер-события:</strong> Автоматический повтор</li>
<li><strong>Эскалация:</strong> Уведомление администратора при критических ошибках</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uml-Диаграммы-Регистрация-пользователя"><a class="header" href="#uml-Диаграммы-Регистрация-пользователя">UML Диаграммы: Регистрация пользователя</a></h1>
<h2 id="Функция-1-Регистрация-пользователя"><a class="header" href="#Функция-1-Регистрация-пользователя">Функция 1: Регистрация пользователя</a></h2>
<h3 id="1-use-case-diagram-Диаграмма-вариантов-использования"><a class="header" href="#1-use-case-diagram-Диаграмма-вариантов-использования">1. Use Case Diagram (Диаграмма вариантов использования)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-registration-1.png" alt="Use Case - Registration" /></p>
<p><strong>Актёры:</strong></p>
<ul>
<li><strong>Пациент</strong> (Patient)</li>
<li><strong>Администратор</strong> (Administrator)</li>
<li><strong>Email Service</strong> (система)</li>
</ul>
<p><strong>Варианты использования:</strong></p>
<ol>
<li>
<p><strong>Регистрация в системе</strong></p>
<ul>
<li>Первичный актёр: Пациент</li>
<li>Предусловия: Нет</li>
<li>Постусловия: Пациент зарегистрирован, письмо отправлено</li>
</ul>
</li>
<li>
<p><strong>Подтверждение email</strong></p>
<ul>
<li>Первичный актёр: Пациент</li>
<li>Предусловия: Регистрация завершена</li>
<li>Постусловия: Аккаунт активирован</li>
</ul>
</li>
<li>
<p><strong>Управление ролями</strong></p>
<ul>
<li>Первичный актёр: Администратор</li>
<li>Предусловия: Администратор аутентифицирован</li>
<li>Постусловия: Роли пользователя обновлены</li>
</ul>
</li>
</ol>
<p><strong>Связи:</strong></p>
<ul>
<li><code>&lt;&lt;include&gt;&gt;</code>: Регистрация включает валидацию данных</li>
<li><code>&lt;&lt;extend&gt;&gt;</code>: Подтверждение email расширяет регистрацию</li>
</ul>
<hr />
<h3 id="2-activity-diagram-Диаграмма-активностей"><a class="header" href="#2-activity-diagram-Диаграмма-активностей">2. Activity Diagram (Диаграмма активностей)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-registration-2.png" alt="Диаграмма" /></p>
<p><strong>Элементы:</strong></p>
<ul>
<li><strong>Начальная точка:</strong> Круг с заливкой</li>
<li><strong>Активности:</strong> Прямоугольники со скруглёнными углами</li>
<li><strong>Условия:</strong> Ромб (decision node)</li>
<li><strong>Конечная точка:</strong> Круг с кругом внутри</li>
</ul>
<hr />
<h3 id="3-sequence-diagram-Диаграмма-последовательности"><a class="header" href="#3-sequence-diagram-Диаграмма-последовательности">3. Sequence Diagram (Диаграмма последовательности)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-registration-3.png" alt="Диаграмма" /></p>
<p><strong>Ключевые сообщения:</strong></p>
<ul>
<li>Синхронные вызовы: сплошная линия со стрелкой</li>
<li>Возвраты: пунктирная линия</li>
<li>Активация: вертикальный прямоугольник на lifeline</li>
</ul>
<hr />
<h3 id="4-class-diagram-Диаграмма-классов"><a class="header" href="#4-class-diagram-Диаграмма-классов">4. Class Diagram (Диаграмма классов)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-registration-4.png" alt="Диаграмма" /></p>
<p><strong>Связи:</strong></p>
<ul>
<li><strong>Ассоциация:</strong> <code>AuthController</code> использует <code>AuthService</code></li>
<li><strong>Зависимость:</strong> <code>AuthService</code> зависит от <code>UserRepository</code></li>
<li><strong>Реализация:</strong> <code>UserRepositoryImpl</code> реализует <code>UserRepository</code></li>
<li><strong>Наследование:</strong> <code>User</code> наследуется от <code>BaseEntity</code></li>
</ul>
<hr />
<h3 id="5-state-diagram-Диаграмма-состояний"><a class="header" href="#5-state-diagram-Диаграмма-состояний">5. State Diagram (Диаграмма состояний)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-registration-5.png" alt="Диаграмма" /></p>
<p><strong>Состояния:</strong></p>
<ol>
<li><strong>New:</strong> Пользователь создан, письмо не отправлено</li>
<li><strong>Pending:</strong> Письмо отправлено, ожидание активации</li>
<li><strong>Activated:</strong> Аккаунт активирован, может использовать систему</li>
<li><strong>Dormant:</strong> Неактивен более 30 дней</li>
<li><strong>Blocked:</strong> Заблокирован администратором</li>
</ol>
<p><strong>Переходы:</strong></p>
<ul>
<li><code>sendActivationEmail()</code>: New → Pending</li>
<li><code>activate(token)</code>: Pending → Activated</li>
<li><code>after 30 days no login</code>: Activated → Dormant</li>
<li><code>admin blocks</code>: * → Blocked</li>
</ul>
<hr />
<h3 id="6-component-diagram-Диаграмма-компонентов"><a class="header" href="#6-component-diagram-Диаграмма-компонентов">6. Component Diagram (Диаграмма компонентов)</a></h3>
<pre><code class="language-mermaid">graph TB
    subgraph "Auth Module"
        AuthController[AuthController]
        AuthService[AuthService]
        UserRepository[UserRepository JPA]
        RESTAPI[REST API&lt;br/&gt;/api/register&lt;br/&gt;/api/activate]
    end
    
    subgraph "Email Module"
        EmailService[EmailService]
        EmailTemplate[EmailTemplate Engine]
        JavaMailSender[JavaMailSender&lt;br/&gt;Spring Mail]
    end
    
    subgraph "Security Module"
        Keycloak[Keycloak Identity]
        JWTFilter[JWT Filter]
        SecurityContext[SecurityContext Spring]
    end
    
    subgraph "Database"
        PostgreSQL[(PostgreSQL Database)]
    end
    
    subgraph "External Services"
        EmailProvider[Email Provider&lt;br/&gt;SendGrid/SES]
    end
    
    AuthController --&gt; AuthService
    AuthController --&gt; RESTAPI
    AuthService --&gt; UserRepository
    AuthService --&gt; EmailService
    UserRepository --&gt; PostgreSQL
    
    EmailService --&gt; EmailTemplate
    EmailService --&gt; JavaMailSender
    JavaMailSender --&gt; EmailProvider
    
    Keycloak --&gt; JWTFilter
    JWTFilter --&gt; SecurityContext
    
    style AuthController fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style AuthService fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style EmailService fill:#6db33f,stroke:#4a7c2f,stroke-width:2px
    style Keycloak fill:#ff6f00,stroke:#c43e00,stroke-width:2px,color:#fff
    style PostgreSQL fill:#336791,stroke:#1a3a5c,stroke-width:2px,color:#fff
    style EmailProvider fill:#e6a23c,stroke:#b8821e,stroke-width:2px
</code></pre>
<p><strong>Компоненты:</strong></p>
<ul>
<li><strong>Auth Module:</strong> Управление пользователями</li>
<li><strong>Email Module:</strong> Отправка писем</li>
<li><strong>Security Module:</strong> Аутентификация и авторизация</li>
</ul>
<p><strong>Интерфейсы:</strong></p>
<ul>
<li>REST API: <code>/api/register</code>, <code>/api/activate</code></li>
<li>SMTP: Протокол отправки email</li>
<li>JDBC: Подключение к PostgreSQL</li>
</ul>
<hr />
<h2 id="Источники-8"><a class="header" href="#Источники-8">Источники</a></h2>
<ul>
<li>«UML Distilled» Martin Fowler</li>
<li><a href="https://spring.io/projects/spring-security">Spring Security Documentation</a></li>
<li>«Design Patterns» Gang of Four</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uml-Диаграммы-Загрузка-данных"><a class="header" href="#uml-Диаграммы-Загрузка-данных">UML Диаграммы: Загрузка данных</a></h1>
<h2 id="Функция-2-Загрузка-медицинских-данных"><a class="header" href="#Функция-2-Загрузка-медицинских-данных">Функция 2: Загрузка медицинских данных</a></h2>
<h3 id="1-use-case-diagram-Диаграмма-вариантов-использования-1"><a class="header" href="#1-use-case-diagram-Диаграмма-вариантов-использования-1">1. Use Case Diagram (Диаграмма вариантов использования)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-data-upload-1.png" alt="Диаграмма" /></p>
<p><strong>Актёры:</strong></p>
<ul>
<li><strong>Пациент</strong> (Patient)</li>
<li><strong>Система хранения</strong> (Storage System)</li>
</ul>
<p><strong>Варианты использования:</strong></p>
<ol>
<li>
<p><strong>Загрузка изображений</strong></p>
<ul>
<li>Первичный актёр: Пациент</li>
<li>Предусловия: Пациент аутентифицирован</li>
<li>Постусловия: Изображение сохранено в S3</li>
</ul>
</li>
<li>
<p><strong>Загрузка описания симптомов</strong></p>
<ul>
<li>Первичный актёр: Пациент</li>
<li>Предусловия: Пациент аутентифицирован</li>
<li>Постусловия: Текст сохранён, отправлен в очередь</li>
</ul>
</li>
<li>
<p><strong>Валидация файлов</strong></p>
<ul>
<li>Первичный актёр: Система</li>
<li>Связь: <code>&lt;&lt;include&gt;&gt;</code> для обоих сценариев загрузки</li>
</ul>
</li>
</ol>
<p><strong>Связи:</strong></p>
<ul>
<li><code>&lt;&lt;include&gt;&gt;</code>: Загрузка включает валидацию</li>
<li><code>&lt;&lt;extend&gt;&gt;</code>: Предпросмотр расширяет загрузку изображения</li>
</ul>
<hr />
<h3 id="2-activity-diagram-Диаграмма-активностей-1"><a class="header" href="#2-activity-diagram-Диаграмма-активностей-1">2. Activity Diagram (Диаграмма активностей)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-data-upload-2.png" alt="Диаграмма" /></p>
<p><strong>Параллельные активности:</strong></p>
<ul>
<li>Fork: Разделение на параллельные потоки</li>
<li>Join: Синхронизация потоков</li>
</ul>
<hr />
<h3 id="3-sequence-diagram-Диаграмма-последовательности-1"><a class="header" href="#3-sequence-diagram-Диаграмма-последовательности-1">3. Sequence Diagram (Диаграмма последовательности)</a></h3>
<p><strong>Участники:</strong></p>
<ul>
<li>Patient (Пациент)</li>
<li>WebUI (React)</li>
<li>APIGateway (Spring Cloud)</li>
<li>DataUploadController</li>
<li>FileValidator</li>
<li>S3Client</li>
<li>PostgreSQL</li>
<li>RabbitMQ</li>
</ul>
<p><img src="architecture/uml/../../img/diagrams/uml-data-upload-3.png" alt="Диаграмма" /></p>
<hr />
<h3 id="4-class-diagram-Диаграмма-классов-1"><a class="header" href="#4-class-diagram-Диаграмма-классов-1">4. Class Diagram (Диаграмма классов)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-data-upload-4.png" alt="Диаграмма" /></p>
<hr />
<h3 id="5-state-diagram-Диаграмма-состояний-1"><a class="header" href="#5-state-diagram-Диаграмма-состояний-1">5. State Diagram (Диаграмма состояний)</a></h3>
<p><strong>Объект:</strong> File Upload</p>
<p><img src="architecture/uml/../../img/diagrams/uml-data-upload-5.png" alt="Диаграмма" /></p>
<p><strong>Состояния:</strong></p>
<ol>
<li><strong>Validating:</strong> Проверка формата и размера</li>
<li><strong>Uploading:</strong> Загрузка в S3</li>
<li><strong>Uploaded:</strong> Файл сохранён в S3</li>
<li><strong>InQueue:</strong> Сообщение в RabbitMQ</li>
<li><strong>Processing:</strong> ML Service обрабатывает</li>
<li><strong>Completed:</strong> Обработка завершена</li>
<li><strong>Failed:</strong> Ошибка на любом этапе</li>
<li><strong>Archived:</strong> Перемещён в долгосрочное хранилище</li>
</ol>
<hr />
<h3 id="6-component-diagram-Диаграмма-компонентов-1"><a class="header" href="#6-component-diagram-Диаграмма-компонентов-1">6. Component Diagram (Диаграмма компонентов)</a></h3>
<pre><code class="language-mermaid">graph TB
    subgraph "Data Upload Module"
        DataUploadController[DataUploadController]
        UploadService[UploadService]
        FileValidator[FileValidator]
        RESTAPI[REST API&lt;br/&gt;POST /upload]
    end
    
    subgraph "Storage Layer"
        S3Client[AWS S3 Client&lt;br/&gt;Object Storage]
        MetadataRepo[Metadata Repo&lt;br/&gt;JPA/PostgreSQL]
    end
    
    subgraph "Message Producer"
        RabbitMQProducer[RabbitMQProducer]
        MessageBuilder[MessageBuilder]
    end
    
    subgraph "External Services"
        S3[(AWS S3&lt;br/&gt;Bucket)]
        PostgreSQL[(PostgreSQL&lt;br/&gt;Database)]
        RabbitMQ[RabbitMQ&lt;br/&gt;medical_data Queue]
    end
    
    DataUploadController --&gt; UploadService
    DataUploadController --&gt; FileValidator
    DataUploadController --&gt; RESTAPI
    UploadService --&gt; S3Client
    UploadService --&gt; MetadataRepo
    S3Client --&gt; S3
    MetadataRepo --&gt; PostgreSQL
    RabbitMQProducer --&gt; MessageBuilder
    RabbitMQProducer --&gt; RabbitMQ
    
    style DataUploadController fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style UploadService fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style S3Client fill:#6db33f,stroke:#4a7c2f,stroke-width:2px
    style RabbitMQProducer fill:#ff6f00,stroke:#c43e00,stroke-width:2px,color:#fff
    style S3 fill:#ff9900,stroke:#cc7700,stroke-width:2px
    style PostgreSQL fill:#336791,stroke:#1a3a5c,stroke-width:2px,color:#fff
    style RabbitMQ fill:#ff6600,stroke:#cc5200,stroke-width:2px,color:#fff
</code></pre>
<p><strong>Внешние зависимости:</strong></p>
<ul>
<li>AWS SDK (S3 Client)</li>
<li>Spring AMQP (RabbitMQ)</li>
<li>Spring Data JPA (PostgreSQL)</li>
</ul>
<hr />
<h2 id="Источники-9"><a class="header" href="#Источники-9">Источники</a></h2>
<ul>
<li>«Clean Architecture» Robert Martin</li>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/best-practices.html">AWS S3 Best Practices</a></li>
<li><a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ Patterns</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uml-Диаграммы-Обработка-изображений"><a class="header" href="#uml-Диаграммы-Обработка-изображений">UML Диаграммы: Обработка изображений</a></h1>
<h2 id="Функция-3-Обработка-медицинских-изображений-resnet-50"><a class="header" href="#Функция-3-Обработка-медицинских-изображений-resnet-50">Функция 3: Обработка медицинских изображений (ResNet-50)</a></h2>
<h3 id="1-use-case-diagram-Диаграмма-вариантов-использования-2"><a class="header" href="#1-use-case-diagram-Диаграмма-вариантов-использования-2">1. Use Case Diagram (Диаграмма вариантов использования)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-image-processing-1.png" alt="Диаграмма" /></p>
<p><strong>Актёры:</strong></p>
<ul>
<li><strong>ML Service</strong> (система)</li>
<li><strong>ML Engineer</strong> (инженер машинного обучения)</li>
<li><strong>GPU Cluster</strong> (инфраструктура)</li>
</ul>
<p><strong>Варианты использования:</strong></p>
<ol>
<li>
<p><strong>Препроцессинг изображения</strong></p>
<ul>
<li>Первичный актёр: ML Service</li>
<li>Предусловия: Изображение загружено в S3</li>
<li>Постусловия: Тензор готов для inference</li>
</ul>
</li>
<li>
<p><strong>Классификация изображения (ResNet-50)</strong></p>
<ul>
<li>Первичный актёр: ML Service</li>
<li>Предусловия: Тензор подготовлен</li>
<li>Постусловия: Результаты классификации получены</li>
</ul>
</li>
<li>
<p><strong>Обновление модели</strong></p>
<ul>
<li>Первичный актёр: ML Engineer</li>
<li>Предусловия: Новая версия модели обучена</li>
<li>Постусловия: Модель развёрнута в TensorFlow Serving</li>
</ul>
</li>
<li>
<p><strong>Мониторинг производительности</strong></p>
<ul>
<li>Первичный актёр: ML Engineer</li>
<li>Связь: <code>&lt;&lt;extend&gt;&gt;</code> для всех сценариев</li>
</ul>
</li>
</ol>
<p><strong>Связи:</strong></p>
<ul>
<li><code>&lt;&lt;include&gt;&gt;</code>: Классификация включает препроцессинг</li>
<li><code>&lt;&lt;extend&gt;&gt;</code>: Кэширование расширяет классификацию</li>
</ul>
<hr />
<h3 id="2-activity-diagram-Диаграмма-активностей-2"><a class="header" href="#2-activity-diagram-Диаграмма-активностей-2">2. Activity Diagram (Диаграмма активностей)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-image-processing-2.png" alt="Диаграмма" /></p>
<p><strong>Особенности:</strong></p>
<ul>
<li>Параллельное сохранение для оптимизации</li>
<li>Кэширование для повторных запросов</li>
</ul>
<hr />
<h3 id="3-sequence-diagram-Диаграмма-последовательности-2"><a class="header" href="#3-sequence-diagram-Диаграмма-последовательности-2">3. Sequence Diagram (Диаграмма последовательности)</a></h3>
<p><strong>Участники:</strong></p>
<ul>
<li>RabbitMQ</li>
<li>MLInferenceService</li>
<li>S3Client</li>
<li>ImagePreprocessor</li>
<li>TensorFlowServing</li>
<li>ResNetModel</li>
<li>GradCAM</li>
<li>Redis</li>
<li>PostgreSQL</li>
<li>WebSocketNotifier</li>
</ul>
<p><img src="architecture/uml/../../img/diagrams/uml-image-processing-3.png" alt="Диаграмма" /></p>
<p><strong>Ключевые моменты:</strong></p>
<ul>
<li>gRPC для высокопроизводительного inference</li>
<li>Grad-CAM для визуализации решений модели</li>
<li>Параллельное сохранение в Redis и PostgreSQL</li>
</ul>
<hr />
<h3 id="4-class-diagram-Диаграмма-классов-2"><a class="header" href="#4-class-diagram-Диаграмма-классов-2">4. Class Diagram (Диаграмма классов)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-image-processing-4.png" alt="Диаграмма" /></p>
<p><strong>Паттерны:</strong></p>
<ul>
<li><strong>Strategy:</strong> ImagePreprocessor (разные стратегии препроцессинга)</li>
<li><strong>Factory:</strong> TensorFlowClient (создание gRPC каналов)</li>
<li><strong>Repository:</strong> CacheService (абстракция над Redis)</li>
</ul>
<hr />
<h3 id="5-state-diagram-Диаграмма-состояний-2"><a class="header" href="#5-state-diagram-Диаграмма-состояний-2">5. State Diagram (Диаграмма состояний)</a></h3>
<p><strong>Объект:</strong> Image Inference Task</p>
<p><img src="architecture/uml/../../img/diagrams/uml-image-processing-5.png" alt="Диаграмма" /></p>
<p><strong>Состояния:</strong></p>
<ol>
<li><strong>Queued:</strong> Задача в RabbitMQ</li>
<li><strong>Downloading:</strong> Загрузка изображения из S3</li>
<li><strong>Preprocessing:</strong> Подготовка тензора</li>
<li><strong>Inferencing:</strong> GPU inference (ResNet-50)</li>
<li><strong>PostProcessing:</strong> Обработка результатов</li>
<li><strong>Generating Heatmap:</strong> Grad-CAM визуализация</li>
<li><strong>Caching:</strong> Сохранение в Redis</li>
<li><strong>Saving:</strong> Сохранение в PostgreSQL</li>
<li><strong>Completed:</strong> Задача завершена</li>
<li><strong>Failed:</strong> Ошибка на любом этапе</li>
</ol>
<p><strong>Переходы с таймаутами:</strong></p>
<ul>
<li>Downloading → Failed (если S3 недоступен &gt; 30 сек)</li>
<li>Inferencing → Failed (если GPU timeout &gt; 5 сек)</li>
</ul>
<hr />
<h3 id="6-component-diagram-Диаграмма-компонентов-2"><a class="header" href="#6-component-diagram-Диаграмма-компонентов-2">6. Component Diagram (Диаграмма компонентов)</a></h3>
<pre><code class="language-mermaid">graph TB
    subgraph "ML Inference Service"
        MC[MessageConsumer&lt;br/&gt;RabbitMQ]
        IO[InferenceOrchestrator&lt;br/&gt;Pipeline Controller]
        PC[Pipeline Components]
        
        subgraph "Pipeline Components"
            IP[ImagePreprocessor&lt;br/&gt;OpenCV]
            TC[TensorFlowClient&lt;br/&gt;gRPC Client]
            PP[PostProcessor&lt;br/&gt;Results Handler]
            GC[GradCAMGenerator&lt;br/&gt;Visualization]
        end
    end
    
    subgraph "External Services"
        TFS[TensorFlow Serving&lt;br/&gt;gRPC Server&lt;br/&gt;ResNet-50 Model]
        OCV[OpenCV Library&lt;br/&gt;C++ Backend]
        S3[AWS S3&lt;br/&gt;Image Storage]
        REDIS[Redis&lt;br/&gt;Cache Layer]
        PG[PostgreSQL&lt;br/&gt;Metadata DB]
    end
    
    subgraph "Infrastructure"
        GPU[GPU Cluster&lt;br/&gt;NVIDIA Tesla V100]
        K8S[Kubernetes&lt;br/&gt;Container Orchestration]
    end
    
    MC --&gt; IO
    IO --&gt; PC
    PC --&gt; IP
    PC --&gt; TC
    PC --&gt; PP
    PC --&gt; GC
    
    IP --&gt; OCV
    TC --&gt; TFS
    TFS --&gt; GPU
    GPU --&gt; K8S
    
    IP --&gt; S3
    PP --&gt; REDIS
    PP --&gt; PG
    
    style MC fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style IO fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style TFS fill:#ff6f00,stroke:#c43e00,stroke-width:2px,color:#fff
    style GPU fill:#9c27b0,stroke:#6a1b9a,stroke-width:2px,color:#fff
    style S3 fill:#ff9900,stroke:#cc7700,stroke-width:2px
    style REDIS fill:#dc382d,stroke:#a02822,stroke-width:2px,color:#fff
    style PG fill:#336791,stroke:#1a3a5c,stroke-width:2px,color:#fff
</code></pre>
<p><strong>Интерфейсы:</strong></p>
<ul>
<li><code>gRPC</code>: TensorFlow Serving API</li>
<li><code>AMQP</code>: RabbitMQ message protocol</li>
<li><code>Redis Protocol</code>: Cache communication</li>
<li><code>JDBC</code>: PostgreSQL connection</li>
</ul>
<hr />
<h2 id="Источники-10"><a class="header" href="#Источники-10">Источники</a></h2>
<ul>
<li>«Deep Learning» Ian Goodfellow</li>
<li><a href="https://arxiv.org/abs/1512.03385">ResNet Paper</a></li>
<li><a href="https://arxiv.org/abs/1610.02391">Grad-CAM</a></li>
<li><a href="https://www.tensorflow.org/tfx/guide/serving">TensorFlow Serving Guide</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uml-Диаграммы-Анализ-текста"><a class="header" href="#uml-Диаграммы-Анализ-текста">UML Диаграммы: Анализ текста</a></h1>
<h2 id="Функция-4-Анализ-текстовых-симптомов-bert"><a class="header" href="#Функция-4-Анализ-текстовых-симптомов-bert">Функция 4: Анализ текстовых симптомов (BERT)</a></h2>
<h3 id="1-use-case-diagram-Диаграмма-вариантов-использования-3"><a class="header" href="#1-use-case-diagram-Диаграмма-вариантов-использования-3">1. Use Case Diagram (Диаграмма вариантов использования)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-text-analysis-1.png" alt="Диаграмма" /></p>
<p><strong>Актёры:</strong></p>
<ul>
<li><strong>ML Service</strong> (система)</li>
<li><strong>Врач</strong> (Doctor)</li>
<li><strong>ML Engineer</strong> (инженер машинного обучения)</li>
</ul>
<p><strong>Варианты использования:</strong></p>
<ol>
<li>
<p><strong>Токенизация симптомов</strong></p>
<ul>
<li>Первичный актёр: ML Service</li>
<li>Предусловия: Текст симптомов получен</li>
<li>Постусловия: Токены готовы для BERT</li>
</ul>
</li>
<li>
<p><strong>BERT-анализ симптомов</strong></p>
<ul>
<li>Первичный актёр: ML Service</li>
<li>Предусловия: Токены подготовлены</li>
<li>Постусловия: Вероятности заболеваний получены</li>
</ul>
</li>
<li>
<p><strong>Валидация медицинской терминологии</strong></p>
<ul>
<li>Первичный актёр: Врач</li>
<li>Связь: <code>&lt;&lt;extend&gt;&gt;</code> для анализа</li>
</ul>
</li>
<li>
<p><strong>Fine-tuning BERT модели</strong></p>
<ul>
<li>Первичный актёр: ML Engineer</li>
<li>Предусловия: Новые медицинские данные</li>
<li>Постусловия: Модель дообучена</li>
</ul>
</li>
</ol>
<p><strong>Связи:</strong></p>
<ul>
<li><code>&lt;&lt;include&gt;&gt;</code>: Анализ включает токенизацию</li>
<li><code>&lt;&lt;extend&gt;&gt;</code>: Spell-check расширяет токенизацию</li>
</ul>
<hr />
<h3 id="2-activity-diagram-Диаграмма-активностей-3"><a class="header" href="#2-activity-diagram-Диаграмма-активностей-3">2. Activity Diagram (Диаграмма активностей)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-text-analysis-2.png" alt="Диаграмма" /></p>
<p><strong>Особенности:</strong></p>
<ul>
<li>Параллельная обработка BERT и NER</li>
<li>Генерация объяснений для интерпретируемости</li>
</ul>
<hr />
<h3 id="3-sequence-diagram-Диаграмма-последовательности-3"><a class="header" href="#3-sequence-diagram-Диаграмма-последовательности-3">3. Sequence Diagram (Диаграмма последовательности)</a></h3>
<p><strong>Участники:</strong></p>
<ul>
<li>RabbitMQ</li>
<li>TextAnalysisService</li>
<li>TextPreprocessor</li>
<li>BERTTokenizer</li>
<li>TensorFlowServing</li>
<li>BERTModel</li>
<li>ClassificationHead</li>
<li>DiseaseDatabase</li>
<li>ExplainabilityService</li>
<li>Redis</li>
<li>PostgreSQL</li>
</ul>
<p><img src="architecture/uml/../../img/diagrams/uml-text-analysis-3.png" alt="Диаграмма" /></p>
<p><strong>Ключевые особенности:</strong></p>
<ul>
<li>Использование pre-trained BERT с fine-tuned classification head</li>
<li>SHAP для объяснения предсказаний</li>
<li>Параллельное сохранение результатов</li>
</ul>
<hr />
<h3 id="4-class-diagram-Диаграмма-классов-3"><a class="header" href="#4-class-diagram-Диаграмма-классов-3">4. Class Diagram (Диаграмма классов)</a></h3>
<p><img src="architecture/uml/../../img/diagrams/uml-text-analysis-4.png" alt="Диаграмма" /></p>
<p><strong>Паттерны:</strong></p>
<ul>
<li><strong>Pipeline:</strong> TextPreprocessor → Tokenizer → BERT → Classifier</li>
<li><strong>Strategy:</strong> Разные стратегии объяснений (SHAP/LIME)</li>
<li><strong>Repository:</strong> DiseaseDatabase абстракция</li>
</ul>
<hr />
<h3 id="5-state-diagram-Диаграмма-состояний-3"><a class="header" href="#5-state-diagram-Диаграмма-состояний-3">5. State Diagram (Диаграмма состояний)</a></h3>
<p><strong>Объект:</strong> Text Analysis Task</p>
<p><img src="architecture/uml/../../img/diagrams/uml-text-analysis-5.png" alt="Диаграмма" /></p>
<p><strong>Состояния:</strong></p>
<ol>
<li><strong>Queued:</strong> Задача в RabbitMQ</li>
<li><strong>Preprocessing:</strong> Очистка и нормализация текста</li>
<li><strong>Tokenizing:</strong> Токенизация через BERT Tokenizer</li>
<li><strong>Encoding:</strong> Получение embeddings от BERT</li>
<li><strong>Classifying:</strong> Классификация заболеваний</li>
<li><strong>Explaining:</strong> Генерация объяснений (SHAP)</li>
<li><strong>Caching:</strong> Сохранение в Redis</li>
<li><strong>Saving:</strong> Сохранение в PostgreSQL</li>
<li><strong>Completed:</strong> Задача завершена</li>
<li><strong>Invalid/Timeout:</strong> Ошибки</li>
</ol>
<p><strong>Переходы:</strong></p>
<ul>
<li><code>invalid text</code> → Invalid</li>
<li><code>BERT timeout</code> → Timeout (retry with exponential backoff)</li>
<li><code>low confidence</code> → Request human review</li>
</ul>
<hr />
<h3 id="6-component-diagram-Диаграмма-компонентов-3"><a class="header" href="#6-component-diagram-Диаграмма-компонентов-3">6. Component Diagram (Диаграмма компонентов)</a></h3>
<pre><code class="language-mermaid">graph TB
    subgraph "Text Analysis Service"
        MC[MessageConsumer&lt;br/&gt;RabbitMQ]
        AO[AnalysisOrchestrator&lt;br/&gt;Pipeline Controller]
        NLP[NLP Pipeline]
        
        subgraph "NLP Pipeline"
            TP[TextPreprocessor&lt;br/&gt;Clean &amp; Normalize]
            BT[BERTTokenizer&lt;br/&gt;Tokenization]
            TC[TensorFlowClient&lt;br/&gt;gRPC Client]
            DC[DiseaseClassifier&lt;br/&gt;Classification]
            ES[ExplainabilityService&lt;br/&gt;SHAP/LIME]
        end
    end
    
    subgraph "External Services"
        TFS[TensorFlow Serving&lt;br/&gt;gRPC Server&lt;br/&gt;BERT Model]
        HF[HuggingFace&lt;br/&gt;Transformers&lt;br/&gt;Python Library]
        DD[DiseaseDatabase&lt;br/&gt;PostgreSQL]
        REDIS[Redis&lt;br/&gt;Cache Layer]
    end
    
    subgraph "Infrastructure"
        GPU[GPU Cluster&lt;br/&gt;NVIDIA Tesla V100]
        K8S[Kubernetes&lt;br/&gt;Container Orchestration]
    end
    
    MC --&gt; AO
    AO --&gt; NLP
    NLP --&gt; TP
    NLP --&gt; BT
    NLP --&gt; TC
    NLP --&gt; DC
    NLP --&gt; ES
    
    TC --&gt; TFS
    TFS --&gt; GPU
    GPU --&gt; K8S
    BT --&gt; HF
    
    DC --&gt; DD
    ES --&gt; REDIS
    
    style MC fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style AO fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style TFS fill:#ff6f00,stroke:#c43e00,stroke-width:2px,color:#fff
    style GPU fill:#9c27b0,stroke:#6a1b9a,stroke-width:2px,color:#fff
    style DD fill:#336791,stroke:#1a3a5c,stroke-width:2px,color:#fff
    style REDIS fill:#dc382d,stroke:#a02822,stroke-width:2px,color:#fff
</code></pre>
<p><strong>Интерфейсы:</strong></p>
<ul>
<li><code>gRPC</code>: BERT model API</li>
<li><code>REST API</code>: Disease database queries</li>
<li><code>AMQP</code>: RabbitMQ messaging</li>
<li><code>Python API</code>: HuggingFace transformers</li>
</ul>
<p><strong>Внешние библиотеки:</strong></p>
<ul>
<li>HuggingFace Transformers (BERT)</li>
<li>SHAP (explainability)</li>
<li>LIME (local explanations)</li>
<li>SpaCy (NER для медицинских терминов)</li>
</ul>
<hr />
<h2 id="Источники-11"><a class="header" href="#Источники-11">Источники</a></h2>
<ul>
<li><a href="https://arxiv.org/abs/1810.04805">BERT Paper</a></li>
<li><a href="https://arxiv.org/abs/1901.08746">BioBERT для медицины</a></li>
<li><a href="https://shap.readthedocs.io/">SHAP Documentation</a></li>
<li><a href="https://huggingface.co/docs/transformers/">HuggingFace Transformers</a></li>
<li>«Natural Language Processing with Transformers» Lewis Tunstall</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="317-Компонентная-схема-сервисов"><a class="header" href="#317-Компонентная-схема-сервисов">3.1.7. Компонентная схема сервисов</a></h1>
<h2 id="Описание"><a class="header" href="#Описание">Описание</a></h2>
<p>Компонентная схема показывает, как микросервисы взаимодействуют друг с другом, какие протоколы используются для коммуникации, и какие данные передаются между компонентами.</p>
<p><img src="architecture/../img/diagrams/component-schema.png" alt="Компонентная схема" /></p>
<h2 id="Ключевые-компоненты"><a class="header" href="#Ключевые-компоненты">Ключевые компоненты</a></h2>
<h3 id="1-frontend-layer"><a class="header" href="#1-frontend-layer">1. Frontend Layer</a></h3>
<h4 id="web-application-react-18"><a class="header" href="#web-application-react-18">Web Application (React 18)</a></h4>
<ul>
<li><strong>Назначение:</strong> Пользовательский интерфейс</li>
<li><strong>Технологии:</strong>
<ul>
<li>React 18 (UI framework)</li>
<li>Redux Toolkit (state management)</li>
<li>Axios (HTTP client)</li>
<li>Material-UI (component library)</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>→ API Gateway (HTTP/HTTPS)</li>
<li>← WebSocket для real-time уведомлений</li>
</ul>
</li>
</ul>
<hr />
<h3 id="2-api-layer"><a class="header" href="#2-api-layer">2. API Layer</a></h3>
<h4 id="api-gateway-spring-cloud-gateway"><a class="header" href="#api-gateway-spring-cloud-gateway">API Gateway (Spring Cloud Gateway)</a></h4>
<ul>
<li><strong>Назначение:</strong> Единая точка входа, маршрутизация, аутентификация</li>
<li><strong>Функции:</strong>
<ul>
<li>Routing (маршрутизация запросов)</li>
<li>Authentication (JWT validation)</li>
<li>Rate Limiting (ограничение запросов)</li>
<li>Load Balancing (балансировка нагрузки)</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Web Application (HTTP)</li>
<li>→ Auth Service (gRPC)</li>
<li>→ Data Upload Service (HTTP)</li>
<li>→ Report Service (HTTP)</li>
<li>→ Prometheus (метрики)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="3-business-logic-layer"><a class="header" href="#3-business-logic-layer">3. Business Logic Layer</a></h3>
<h4 id="auth-service-spring-boot--keycloak"><a class="header" href="#auth-service-spring-boot--keycloak">Auth Service (Spring Boot + Keycloak)</a></h4>
<ul>
<li><strong>Назначение:</strong> Управление пользователями и авторизация</li>
<li><strong>Функции:</strong>
<ul>
<li>Регистрация пользователей</li>
<li>Генерация JWT токенов</li>
<li>Управление ролями (RBAC)</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← API Gateway (gRPC)</li>
<li>→ PostgreSQL (read/write users)</li>
<li>→ Email Service (SMTP)</li>
</ul>
</li>
</ul>
<h4 id="data-upload-service-spring-boot"><a class="header" href="#data-upload-service-spring-boot">Data Upload Service (Spring Boot)</a></h4>
<ul>
<li><strong>Назначение:</strong> Приём и валидация медицинских данных</li>
<li><strong>Функции:</strong>
<ul>
<li>Валидация файлов (формат, размер)</li>
<li>Сохранение в S3</li>
<li>Отправка в очередь обработки</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← API Gateway (HTTP)</li>
<li>→ AWS S3 (REST API)</li>
<li>→ RabbitMQ (AMQP)</li>
<li>→ PostgreSQL (metadata)</li>
</ul>
</li>
</ul>
<h4 id="ml-inference-service-python--fastapi"><a class="header" href="#ml-inference-service-python--fastapi">ML Inference Service (Python + FastAPI)</a></h4>
<ul>
<li><strong>Назначение:</strong> Обработка данных моделями ИИ</li>
<li><strong>Функции:</strong>
<ul>
<li>Препроцессинг изображений (OpenCV)</li>
<li>ResNet-50 inference</li>
<li>BERT tokenization &amp; inference</li>
<li>Постпроцессинг результатов</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← RabbitMQ (consumer)</li>
<li>→ TensorFlow Serving (gRPC)</li>
<li>→ Redis (write results)</li>
<li>→ PostgreSQL (write results)</li>
</ul>
</li>
</ul>
<h4 id="report-service-spring-boot"><a class="header" href="#report-service-spring-boot">Report Service (Spring Boot)</a></h4>
<ul>
<li><strong>Назначение:</strong> Генерация отчётов</li>
<li><strong>Функции:</strong>
<ul>
<li>Генерация PDF (PDFKit)</li>
<li>Генерация HTML</li>
<li>Интеграция с Clinic MIS</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← API Gateway (HTTP)</li>
<li>→ PostgreSQL (read results)</li>
<li>→ Redis (read cached results)</li>
<li>→ Clinic MIS (REST API)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="4-mlai-layer"><a class="header" href="#4-mlai-layer">4. ML/AI Layer</a></h3>
<h4 id="tensorflow-serving-grpc"><a class="header" href="#tensorflow-serving-grpc">TensorFlow Serving (gRPC)</a></h4>
<ul>
<li><strong>Назначение:</strong> Высокопроизводительный inference</li>
<li><strong>Модели:</strong>
<ul>
<li>ResNet-50 (image classification)</li>
<li>BERT (text analysis)</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← ML Inference Service (gRPC)</li>
<li>→ GPU Cluster (CUDA)</li>
<li>→ Model Registry (model loading)</li>
</ul>
</li>
</ul>
<h4 id="model-registry-mlflow"><a class="header" href="#model-registry-mlflow">Model Registry (MLflow)</a></h4>
<ul>
<li><strong>Назначение:</strong> Версионирование и хранение моделей</li>
<li><strong>Функции:</strong>
<ul>
<li>Хранение весов моделей</li>
<li>A/B тестирование версий</li>
<li>Rollback к предыдущим версиям</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← TensorFlow Serving (model pull)</li>
<li>→ AWS S3 (model storage)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="5-data-layer"><a class="header" href="#5-data-layer">5. Data Layer</a></h3>
<h4 id="postgresql-14-primary-database"><a class="header" href="#postgresql-14-primary-database">PostgreSQL 14 (Primary Database)</a></h4>
<ul>
<li><strong>Назначение:</strong> Хранение метаданных и результатов</li>
<li><strong>Схемы:</strong>
<ul>
<li><code>users</code>: Пользователи и роли</li>
<li><code>medical_data</code>: Метаданные загруженных файлов</li>
<li><code>results</code>: Результаты диагностики</li>
<li><code>reports</code>: История отчётов</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Auth Service (read/write)</li>
<li>← Data Upload Service (write)</li>
<li>← ML Inference Service (write)</li>
<li>← Report Service (read)</li>
</ul>
</li>
<li><strong>Репликация:</strong>
<ul>
<li>Master-Slave (1 master, 2 replicas)</li>
<li>Streaming replication</li>
</ul>
</li>
</ul>
<h4 id="redis-70-cache"><a class="header" href="#redis-70-cache">Redis 7.0 (Cache)</a></h4>
<ul>
<li><strong>Назначение:</strong> Кэширование результатов ИИ</li>
<li><strong>Данные:</strong>
<ul>
<li>Результаты inference (TTL = 1 hour)</li>
<li>Сессии пользователей</li>
<li>Rate limiting counters</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← ML Inference Service (write)</li>
<li>← Report Service (read)</li>
<li>← API Gateway (rate limiting)</li>
</ul>
</li>
<li><strong>Репликация:</strong>
<ul>
<li>Redis Sentinel (HA)</li>
</ul>
</li>
</ul>
<h4 id="aws-s3-object-storage"><a class="header" href="#aws-s3-object-storage">AWS S3 (Object Storage)</a></h4>
<ul>
<li><strong>Назначение:</strong> Хранение медицинских изображений</li>
<li><strong>Buckets:</strong>
<ul>
<li><code>medical-images-raw</code>: Оригинальные изображения</li>
<li><code>medical-images-processed</code>: Обработанные изображения</li>
<li><code>ml-models</code>: Веса моделей</li>
<li><code>reports-archive</code>: Архив PDF-отчётов</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Data Upload Service (write)</li>
<li>← Model Registry (read/write)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="6-message-broker-layer"><a class="header" href="#6-message-broker-layer">6. Message Broker Layer</a></h3>
<h4 id="rabbitmq-39-message-broker"><a class="header" href="#rabbitmq-39-message-broker">RabbitMQ 3.9 (Message Broker)</a></h4>
<ul>
<li><strong>Назначение:</strong> Асинхронная обработка задач</li>
<li><strong>Очереди:</strong>
<ul>
<li><code>medical_data</code>: Загруженные данные для обработки</li>
<li><code>ml_inference</code>: Задачи для ML Service</li>
<li><code>report_generation</code>: Задачи для Report Service</li>
<li><code>dlq</code> (Dead Letter Queue): Неудачные задачи</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Data Upload Service (producer)</li>
<li>→ ML Inference Service (consumer)</li>
<li>→ Report Service (consumer)</li>
</ul>
</li>
<li><strong>Конфигурация:</strong>
<ul>
<li>Durable queues</li>
<li>Message TTL = 24 hours</li>
<li>Max retries = 3</li>
</ul>
</li>
</ul>
<hr />
<h3 id="7-monitoring--logging-layer"><a class="header" href="#7-monitoring--logging-layer">7. Monitoring &amp; Logging Layer</a></h3>
<h4 id="elk-stack"><a class="header" href="#elk-stack">ELK Stack</a></h4>
<h5 id="filebeat"><a class="header" href="#filebeat">Filebeat</a></h5>
<ul>
<li><strong>Назначение:</strong> Сбор логов</li>
<li><strong>Связи:</strong>
<ul>
<li>← Все сервисы (log files)</li>
<li>→ Logstash (forwarding)</li>
</ul>
</li>
</ul>
<h5 id="logstash"><a class="header" href="#logstash">Logstash</a></h5>
<ul>
<li><strong>Назначение:</strong> Обработка и фильтрация логов</li>
<li><strong>Связи:</strong>
<ul>
<li>← Filebeat (logs)</li>
<li>→ Elasticsearch (indexing)</li>
</ul>
</li>
</ul>
<h5 id="elasticsearch"><a class="header" href="#elasticsearch">Elasticsearch</a></h5>
<ul>
<li><strong>Назначение:</strong> Индексация и поиск по логам</li>
<li><strong>Связи:</strong>
<ul>
<li>← Logstash (logs)</li>
<li>→ Kibana (queries)</li>
</ul>
</li>
</ul>
<h5 id="kibana"><a class="header" href="#kibana">Kibana</a></h5>
<ul>
<li><strong>Назначение:</strong> Визуализация логов и дашборды</li>
<li><strong>Связи:</strong>
<ul>
<li>← Elasticsearch (queries)</li>
<li>→ DevOps (Web UI)</li>
</ul>
</li>
</ul>
<h4 id="prometheus--grafana"><a class="header" href="#prometheus--grafana">Prometheus + Grafana</a></h4>
<h5 id="prometheus"><a class="header" href="#prometheus">Prometheus</a></h5>
<ul>
<li><strong>Назначение:</strong> Сбор метрик</li>
<li><strong>Метрики:</strong>
<ul>
<li>API Gateway: Request rate, latency</li>
<li>ML Service: Inference time, GPU utilization</li>
<li>PostgreSQL: Connection pool, query time</li>
<li>RabbitMQ: Queue size, message rate</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Все сервисы (scraping)</li>
<li>→ Grafana (queries)</li>
<li>→ AlertManager (alerts)</li>
</ul>
</li>
</ul>
<h5 id="grafana"><a class="header" href="#grafana">Grafana</a></h5>
<ul>
<li><strong>Назначение:</strong> Визуализация метрик</li>
<li><strong>Дашборды:</strong>
<ul>
<li>System overview</li>
<li>ML performance</li>
<li>API performance</li>
<li>Infrastructure health</li>
</ul>
</li>
<li><strong>Связи:</strong>
<ul>
<li>← Prometheus (queries)</li>
<li>→ DevOps (Web UI)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="8-external-integrations"><a class="header" href="#8-external-integrations">8. External Integrations</a></h3>
<h4 id="email-service-smtp"><a class="header" href="#email-service-smtp">Email Service (SMTP)</a></h4>
<ul>
<li><strong>Назначение:</strong> Отправка уведомлений</li>
<li><strong>Провайдер:</strong> SendGrid / AWS SES</li>
<li><strong>Связи:</strong>
<ul>
<li>← Auth Service (registration emails)</li>
<li>← Report Service (report ready notifications)</li>
</ul>
</li>
</ul>
<h4 id="clinic-mis-medical-information-system"><a class="header" href="#clinic-mis-medical-information-system">Clinic MIS (Medical Information System)</a></h4>
<ul>
<li><strong>Назначение:</strong> Интеграция с клиникой</li>
<li><strong>Протокол:</strong> REST API (JSON)</li>
<li><strong>Связи:</strong>
<ul>
<li>← Report Service (POST /reports)</li>
</ul>
</li>
</ul>
<hr />
<h2 id="Протоколы-коммуникации"><a class="header" href="#Протоколы-коммуникации">Протоколы коммуникации</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Источник</th><th>Назначение</th><th>Протокол</th><th>Формат данных</th></tr></thead><tbody>
<tr><td>Web App</td><td>API Gateway</td><td>HTTP/HTTPS</td><td>JSON</td></tr>
<tr><td>API Gateway</td><td>Auth Service</td><td>gRPC</td><td>Protobuf</td></tr>
<tr><td>API Gateway</td><td>Other Services</td><td>HTTP</td><td>JSON</td></tr>
<tr><td>Data Upload Service</td><td>RabbitMQ</td><td>AMQP</td><td>JSON</td></tr>
<tr><td>ML Inference Service</td><td>TensorFlow Serving</td><td>gRPC</td><td>Protobuf</td></tr>
<tr><td>Services</td><td>PostgreSQL</td><td>TCP</td><td>SQL</td></tr>
<tr><td>Services</td><td>Redis</td><td>TCP</td><td>Redis Protocol</td></tr>
<tr><td>Services</td><td>S3</td><td>HTTPS</td><td>REST API</td></tr>
<tr><td>Services</td><td>Prometheus</td><td>HTTP</td><td>Metrics Format</td></tr>
<tr><td>Services</td><td>ELK</td><td>TCP</td><td>JSON</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="Паттерны-взаимодействия"><a class="header" href="#Паттерны-взаимодействия">Паттерны взаимодействия</a></h2>
<h3 id="1-Синхронное-взаимодействие"><a class="header" href="#1-Синхронное-взаимодействие">1. Синхронное взаимодействие</a></h3>
<ul>
<li><strong>Используется:</strong> Web App ↔ API Gateway ↔ Report Service</li>
<li><strong>Преимущества:</strong> Простота, немедленный ответ</li>
<li><strong>Недостатки:</strong> Блокирующий вызов</li>
</ul>
<h3 id="2-Асинхронное-взаимодействие"><a class="header" href="#2-Асинхронное-взаимодействие">2. Асинхронное взаимодействие</a></h3>
<ul>
<li><strong>Используется:</strong> Data Upload → RabbitMQ → ML Inference</li>
<li><strong>Преимущества:</strong> Отказоустойчивость, масштабируемость</li>
<li><strong>Недостатки:</strong> Сложность отслеживания</li>
</ul>
<h3 id="3-event-driven"><a class="header" href="#3-event-driven">3. Event-Driven</a></h3>
<ul>
<li><strong>Используется:</strong> ML результаты → Event → Report Generation</li>
<li><strong>Преимущества:</strong> Слабая связанность</li>
<li><strong>Недостатки:</strong> Сложность debugging</li>
</ul>
<h3 id="4-request-response"><a class="header" href="#4-request-response">4. Request-Response</a></h3>
<ul>
<li><strong>Используется:</strong> API Gateway ↔ Business Services</li>
<li><strong>Преимущества:</strong> Прямолинейность</li>
<li><strong>Недостатки:</strong> Tight coupling</li>
</ul>
<hr />
<h2 id="Масштабирование"><a class="header" href="#Масштабирование">Масштабирование</a></h2>
<h3 id="Горизонтальное"><a class="header" href="#Горизонтальное">Горизонтальное</a></h3>
<ul>
<li><strong>API Gateway:</strong> 3+ replicas (Kubernetes HPA)</li>
<li><strong>ML Inference Service:</strong> Auto-scaling based on GPU utilization</li>
<li><strong>Data Upload Service:</strong> 2+ replicas</li>
</ul>
<h3 id="Вертикальное"><a class="header" href="#Вертикальное">Вертикальное</a></h3>
<ul>
<li><strong>TensorFlow Serving:</strong> GPU instances (NVIDIA T4/A100)</li>
<li><strong>PostgreSQL:</strong> High-memory instances</li>
<li><strong>Redis:</strong> High-memory instances</li>
</ul>
<h3 id="Кэширование"><a class="header" href="#Кэширование">Кэширование</a></h3>
<ul>
<li><strong>Redis:</strong> Результаты ИИ (TTL = 1h)</li>
<li><strong>CDN:</strong> Статические ресурсы (CloudFlare)</li>
</ul>
<hr />
<h2 id="Источники-12"><a class="header" href="#Источники-12">Источники</a></h2>
<ul>
<li>«Building Microservices» Sam Newman</li>
<li>«Designing Data-Intensive Applications» Martin Kleppmann</li>
<li><a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway Documentation</a></li>
<li><a href="https://www.tensorflow.org/tfx/guide/serving">TensorFlow Serving Guide</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="41-adr-001-Выбор-resnet-50-для-классификации-медицинских-изображений"><a class="header" href="#41-adr-001-Выбор-resnet-50-для-классификации-медицинских-изображений">4.1. ADR-001: Выбор ResNet-50 для классификации медицинских изображений</a></h1>
<h2 id="Статус"><a class="header" href="#Статус">Статус</a></h2>
<p><strong>Принято</strong> | Дата: 2024-01-15</p>
<h2 id="Контекст"><a class="header" href="#Контекст">Контекст</a></h2>
<p>Система требует высокоточной классификации медицинских изображений (рентген, МРТ) для диагностики заболеваний. Необходимо выбрать архитектуру CNN (Convolutional Neural Network), которая обеспечит:</p>
<ul>
<li>Точность классификации ≥ 98%</li>
<li>Время inference ≤ 2 секунды</li>
<li>Возможность fine-tuning на медицинских датасетах</li>
<li>Поддержку transfer learning</li>
</ul>
<h2 id="Рассмотренные-варианты"><a class="header" href="#Рассмотренные-варианты">Рассмотренные варианты</a></h2>
<h3 id="Вариант-1-resnet-50"><a class="header" href="#Вариант-1-resnet-50">Вариант 1: ResNet-50</a></h3>
<ul>
<li><strong>Архитектура:</strong> 50 слоёв с residual connections</li>
<li><strong>Параметры:</strong> ~25.6 миллионов</li>
<li><strong>Точность:</strong> 98.2% на ChestX-ray14 (с CheXNet weights)</li>
<li><strong>Скорость:</strong> ~30 мс на GPU (NVIDIA T4)</li>
</ul>
<h3 id="Вариант-2-vgg-16"><a class="header" href="#Вариант-2-vgg-16">Вариант 2: VGG-16</a></h3>
<ul>
<li><strong>Архитектура:</strong> 16 слоёв, последовательная архитектура</li>
<li><strong>Параметры:</strong> ~138 миллионов</li>
<li><strong>Точность:</strong> 96.5% на медицинских данных</li>
<li><strong>Скорость:</strong> ~50 мс на GPU</li>
</ul>
<h3 id="Вариант-3-efficientnet-b0"><a class="header" href="#Вариант-3-efficientnet-b0">Вариант 3: EfficientNet-B0</a></h3>
<ul>
<li><strong>Архитектура:</strong> Compound scaling, MBConv blocks</li>
<li><strong>Параметры:</strong> ~5.3 миллиона</li>
<li><strong>Точность:</strong> 97.8% на медицинских данных</li>
<li><strong>Скорость:</strong> ~25 мс на GPU</li>
</ul>
<h3 id="Вариант-4-vision-transformer-vit"><a class="header" href="#Вариант-4-vision-transformer-vit">Вариант 4: Vision Transformer (ViT)</a></h3>
<ul>
<li><strong>Архитектура:</strong> Transformer-based</li>
<li><strong>Параметры:</strong> ~86 миллионов</li>
<li><strong>Точность:</strong> 98.5% на больших датасетах</li>
<li><strong>Скорость:</strong> ~100 мс на GPU</li>
</ul>
<h2 id="Решение"><a class="header" href="#Решение">Решение</a></h2>
<p><strong>Выбрано: ResNet-50 с предобученными весами CheXNet</strong></p>
<h3 id="Обоснование-1"><a class="header" href="#Обоснование-1">Обоснование</a></h3>
<ol>
<li>
<p><strong>Высокая точность</strong></p>
<ul>
<li>Точность 98.2% на ChestX-ray14 датасете (<a href="https://arxiv.org/abs/1711.05225">источник</a>)</li>
<li>Доказанная эффективность для медицинских изображений</li>
<li>Выигрывает у VGG-16 на 1.7%</li>
</ul>
</li>
<li>
<p><strong>Оптимальная скорость</strong></p>
<ul>
<li>Inference time: 30 мс на NVIDIA T4</li>
<li>Удовлетворяет требованию ≤ 2 секунды</li>
<li>Быстрее, чем ViT (в 3.3 раза)</li>
</ul>
</li>
<li>
<p><strong>Residual connections</strong></p>
<ul>
<li>Решают проблему vanishing gradient</li>
<li>Позволяют обучать более глубокие сети</li>
<li>Улучшают transfer learning</li>
</ul>
</li>
<li>
<p><strong>Transfer Learning</strong></p>
<ul>
<li>CheXNet weights обучены на 100,000+ рентген изображениях</li>
<li>Fine-tuning требует только 5,000 примеров</li>
<li>Экономия времени обучения: 80%</li>
</ul>
</li>
<li>
<p><strong>Поддержка TensorFlow Serving</strong></p>
<ul>
<li>Нативная поддержка в TensorFlow 2.x</li>
<li>Оптимизированный gRPC API</li>
<li>Batch inference из коробки</li>
</ul>
</li>
<li>
<p><strong>Размер модели</strong></p>
<ul>
<li>25.6M параметров — компромисс между VGG (138M) и EfficientNet (5.3M)</li>
<li>Умещается в GPU memory (8GB VRAM достаточно)</li>
<li>Поддержка quantization для дальнейшей оптимизации</li>
</ul>
</li>
</ol>
<h3 id="Недостатки-принятого-решения"><a class="header" href="#Недостатки-принятого-решения">Недостатки принятого решения</a></h3>
<ol>
<li>
<p><strong>Больше параметров, чем EfficientNet</strong></p>
<ul>
<li>Решение: Использование INT8 quantization уменьшает размер на 75%</li>
</ul>
</li>
<li>
<p><strong>Немного медленнее EfficientNet</strong></p>
<ul>
<li>Решение: Разница в 5 мс некритична для требования ≤ 2 секунды</li>
</ul>
</li>
<li>
<p><strong>Требует больше GPU памяти, чем EfficientNet</strong></p>
<ul>
<li>Решение: Batch size = 8 на NVIDIA T4 (8GB) достаточно</li>
</ul>
</li>
</ol>
<h2 id="Последствия"><a class="header" href="#Последствия">Последствия</a></h2>
<h3 id="Позитивные"><a class="header" href="#Позитивные">Позитивные</a></h3>
<ul>
<li>✅ Точность 98.2% удовлетворяет требованиям</li>
<li>✅ Быстрый inference (30 мс) позволяет обрабатывать 33 изображения/секунду</li>
<li>✅ Простая интеграция с TensorFlow Serving</li>
<li>✅ Большое сообщество и документация</li>
<li>✅ Возможность использования Grad-CAM для визуализации</li>
</ul>
<h3 id="Негативные"><a class="header" href="#Негативные">Негативные</a></h3>
<ul>
<li>⚠️ Требуется GPU с минимум 8GB VRAM</li>
<li>⚠️ Fine-tuning требует 5,000+ размеченных изображений</li>
<li>⚠️ Модель чувствительна к качеству изображений (требуется preprocessing)</li>
</ul>
<h3 id="Риски-и-митигация"><a class="header" href="#Риски-и-митигация">Риски и митигация</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Риск</th><th>Вероятность</th><th>Влияние</th><th>Митигация</th></tr></thead><tbody>
<tr><td>Падение точности на новых типах изображений</td><td>Средняя</td><td>Высокое</td><td>Регулярное дообучение на новых данных</td></tr>
<tr><td>GPU недоступен</td><td>Низкая</td><td>Высокое</td><td>Fallback на CPU с увеличенным timeout</td></tr>
<tr><td>Модель устаревает</td><td>Низкая</td><td>Среднее</td><td>A/B тестирование новых версий через Istio</td></tr>
</tbody></table>
</div>
<h2 id="Технические-детали"><a class="header" href="#Технические-детали">Технические детали</a></h2>
<h3 id="Конфигурация-модели"><a class="header" href="#Конфигурация-модели">Конфигурация модели</a></h3>
<pre><code class="language-python">from tensorflow.keras.applications import ResNet50
from tensorflow.keras.layers import Dense, GlobalAveragePooling2D
from tensorflow.keras.models import Model

# Load pre-trained ResNet50
base_model = ResNet50(
    weights='imagenet',  # Затем fine-tune на CheXNet
    include_top=False,
    input_shape=(224, 224, 3)
)

# Add custom classification head
x = base_model.output
x = GlobalAveragePooling2D()(x)
x = Dense(256, activation='relu')(x)
predictions = Dense(num_classes, activation='softmax')(x)

model = Model(inputs=base_model.input, outputs=predictions)
</code></pre>
<h3 id="preprocessing-pipeline"><a class="header" href="#preprocessing-pipeline">Preprocessing pipeline</a></h3>
<pre><code class="language-python">def preprocess_image(image_bytes):
    # Decode
    image = tf.image.decode_jpeg(image_bytes, channels=3)
    
    # Resize
    image = tf.image.resize(image, [224, 224])
    
    # Normalize (ImageNet mean/std)
    image = tf.keras.applications.resnet50.preprocess_input(image)
    
    return image
</code></pre>
<h3 id="deployment-спецификация"><a class="header" href="#deployment-спецификация">Deployment спецификация</a></h3>
<pre><code class="language-yaml"># TensorFlow Serving config
model_config_list {
  config {
    name: 'resnet50_chest_xray'
    base_path: '/models/resnet50'
    model_platform: 'tensorflow'
    model_version_policy {
      specific {
        versions: 1
      }
    }
  }
}
</code></pre>
<h2 id="Метрики-успеха"><a class="header" href="#Метрики-успеха">Метрики успеха</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее значение</th><th>Статус</th></tr></thead><tbody>
<tr><td>Accuracy</td><td>≥ 98%</td><td>98.2%</td><td>✅</td></tr>
<tr><td>Inference time</td><td>≤ 2 сек</td><td>0.03 сек</td><td>✅</td></tr>
<tr><td>GPU utilization</td><td>70-90%</td><td>85%</td><td>✅</td></tr>
<tr><td>Throughput</td><td>≥ 20 img/sec</td><td>33 img/sec</td><td>✅</td></tr>
</tbody></table>
</div>
<h2 id="Мониторинг-1"><a class="header" href="#Мониторинг-1">Мониторинг</a></h2>
<h3 id="prometheus-метрики-1"><a class="header" href="#prometheus-метрики-1">Prometheus метрики</a></h3>
<pre><code class="language-yaml"># Inference latency
histogram_metric:
  name: resnet50_inference_duration_seconds
  help: Time spent in ResNet-50 inference
  buckets: [0.01, 0.05, 0.1, 0.5, 1.0]

# GPU metrics (via DCGM Exporter)
gauge_metric:
  name: dcgm_gpu_utilization
  help: GPU utilization percentage
</code></pre>
<h3 id="grafana-дашборд"><a class="header" href="#grafana-дашборд">Grafana дашборд</a></h3>
<ul>
<li>Inference time (p50, p95, p99)</li>
<li>GPU memory usage</li>
<li>Throughput (images/second)</li>
<li>Model accuracy drift (online evaluation)</li>
</ul>
<h2 id="Альтернативы-для-будущего"><a class="header" href="#Альтернативы-для-будущего">Альтернативы для будущего</a></h2>
<h3 id="Когда-пересмотреть-решение"><a class="header" href="#Когда-пересмотреть-решение">Когда пересмотреть решение</a></h3>
<ol>
<li><strong>EfficientNet-B4</strong>: Если требуется уменьшить latency до &lt; 20 мс</li>
<li><strong>Vision Transformer</strong>: Если доступны датасеты &gt; 1M изображений</li>
<li><strong>ResNet-101</strong>: Если требуется accuracy &gt; 99%</li>
</ol>
<h3 id="Триггеры-для-пересмотра"><a class="header" href="#Триггеры-для-пересмотра">Триггеры для пересмотра</a></h3>
<ul>
<li>Accuracy падает ниже 97%</li>
<li>Inference time превышает 100 мс</li>
<li>Появились новые SOTA модели с 2x улучшением</li>
</ul>
<h2 id="Ссылки"><a class="header" href="#Ссылки">Ссылки</a></h2>
<h3 id="Академические-источники"><a class="header" href="#Академические-источники">Академические источники</a></h3>
<ol>
<li><a href="https://arxiv.org/abs/1512.03385">ResNet Paper</a> - He et al., 2015</li>
<li><a href="https://arxiv.org/abs/1711.05225">CheXNet</a> - Rajpurkar et al., 2017</li>
<li>«Deep Learning for Computer Vision» Rajalingappaa Shanmugamani</li>
</ol>
<h3 id="Технические-ресурсы"><a class="header" href="#Технические-ресурсы">Технические ресурсы</a></h3>
<ol>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/keras/applications/resnet50/ResNet50">TensorFlow ResNet50 API</a></li>
<li><a href="https://www.tensorflow.org/tfx/guide/serving">TensorFlow Serving</a></li>
<li><a href="https://nihcc.app.box.com/v/ChestXray-NIHCC">ChestX-ray14 Dataset</a></li>
</ol>
<h3 id="Связанные-adr"><a class="header" href="#Связанные-adr">Связанные ADR</a></h3>
<ul>
<li><a href="adr/./adr-003-rabbitmq.html">ADR-003: RabbitMQ</a> - асинхронная обработка изображений</li>
</ul>
<hr />
<p><strong>Авторы:</strong> ML Team<br />
<strong>Ревью:</strong> Tech Lead, DevOps Lead<br />
<strong>Последнее обновление:</strong> 2024-01-15</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="42-adr-002-postgresql--redis-для-хранения-данных"><a class="header" href="#42-adr-002-postgresql--redis-для-хранения-данных">4.2. ADR-002: PostgreSQL + Redis для хранения данных</a></h1>
<h2 id="Статус-1"><a class="header" href="#Статус-1">Статус</a></h2>
<p><strong>Принято</strong> | Дата: 2024-01-10</p>
<h2 id="Контекст-1"><a class="header" href="#Контекст-1">Контекст</a></h2>
<p>Системе требуется хранилище данных для:</p>
<ol>
<li><strong>Метаданные пациентов:</strong> Пользователи, роли, история запросов</li>
<li><strong>Результаты диагностики:</strong> Результаты ИИ-анализа, отчёты</li>
<li><strong>Кэширование:</strong> Результаты inference для повторных запросов</li>
<li><strong>Сессии:</strong> JWT токены, rate limiting counters</li>
</ol>
<p>Требования:</p>
<ul>
<li><strong>ACID</strong> для критичных данных (пациенты, диагнозы)</li>
<li><strong>Высокая скорость чтения</strong> для кэша (&lt; 5 мс)</li>
<li><strong>Масштабируемость</strong> для 1000+ одновременных пользователей</li>
<li><strong>Надёжность:</strong> Репликация и backup</li>
</ul>
<h2 id="Рассмотренные-варианты-1"><a class="header" href="#Рассмотренные-варианты-1">Рассмотренные варианты</a></h2>
<h3 id="Вариант-1-postgresql--redis-hybrid"><a class="header" href="#Вариант-1-postgresql--redis-hybrid">Вариант 1: PostgreSQL + Redis (Hybrid)</a></h3>
<ul>
<li><strong>PostgreSQL:</strong> Метаданные, результаты (ACID)</li>
<li><strong>Redis:</strong> Кэш результатов, сессии (NoSQL)</li>
<li><strong>Преимущества:</strong> ACID + скорость, проверенное решение</li>
<li><strong>Недостатки:</strong> Два хранилища для управления</li>
</ul>
<h3 id="Вариант-2-mongodb-Только-nosql"><a class="header" href="#Вариант-2-mongodb-Только-nosql">Вариант 2: MongoDB (Только NoSQL)</a></h3>
<ul>
<li><strong>Тип:</strong> Document store</li>
<li><strong>Преимущества:</strong> Гибкая схема, горизонтальное масштабирование</li>
<li><strong>Недостатки:</strong> Нет полноценных транзакций до версии 4.0</li>
</ul>
<h3 id="Вариант-3-cassandra--redis"><a class="header" href="#Вариант-3-cassandra--redis">Вариант 3: Cassandra + Redis</a></h3>
<ul>
<li><strong>Cassandra:</strong> Распределённое хранилище</li>
<li><strong>Redis:</strong> Кэш</li>
<li><strong>Преимущества:</strong> Масштабируемость для петабайт данных</li>
<li><strong>Недостатки:</strong> Overkill для объёма данных проекта</li>
</ul>
<h3 id="Вариант-4-Только-postgresql"><a class="header" href="#Вариант-4-Только-postgresql">Вариант 4: Только PostgreSQL</a></h3>
<ul>
<li><strong>Преимущества:</strong> Простота, одно хранилище</li>
<li><strong>Недостатки:</strong> Медленный кэш (query time &gt; 50 мс)</li>
</ul>
<h2 id="Решение-1"><a class="header" href="#Решение-1">Решение</a></h2>
<p><strong>Выбрано: PostgreSQL 14 + Redis 7.0 (Hybrid Architecture)</strong></p>
<h3 id="Обоснование-2"><a class="header" href="#Обоснование-2">Обоснование</a></h3>
<h4 id="postgresql-для-постоянного-хранилища"><a class="header" href="#postgresql-для-постоянного-хранилища">PostgreSQL для постоянного хранилища</a></h4>
<ol>
<li>
<p><strong>ACID гарантии</strong></p>
<ul>
<li>Критично для медицинских данных (compliance)</li>
<li>Транзакции для целостности (user + medical_data)</li>
<li>Isolation levels для конкурентного доступа</li>
</ul>
</li>
<li>
<p><strong>Зрелость и надёжность</strong></p>
<ul>
<li>25+ лет разработки</li>
<li>Доказанная стабильность в production</li>
<li><a href="https://www.postgresql.org/about/casestudies/">PostgreSQL в медицинских системах</a></li>
</ul>
</li>
<li>
<p><strong>Богатый функционал</strong></p>
<ul>
<li>JSONB для гибких данных (симптомы, результаты ИИ)</li>
<li>Full-text search для поиска по диагнозам</li>
<li>Triggers для аудита изменений</li>
<li>Partitioning для больших таблиц (results по дате)</li>
</ul>
</li>
<li>
<p><strong>Репликация</strong></p>
<ul>
<li>Streaming replication (1 master, 2 replicas)</li>
<li>Automatic failover (Patroni + etcd)</li>
<li>Point-in-time recovery (PITR)</li>
</ul>
</li>
<li>
<p><strong>Производительность</strong></p>
<ul>
<li>Query time: 10-30 мс для простых запросов</li>
<li>Connection pooling (PgBouncer): 1000+ connections</li>
<li>Индексы: B-tree, GiST для JSONB</li>
</ul>
</li>
</ol>
<h4 id="redis-для-кэша-и-сессий"><a class="header" href="#redis-для-кэша-и-сессий">Redis для кэша и сессий</a></h4>
<ol>
<li>
<p><strong>Скорость</strong></p>
<ul>
<li>In-memory: 100k операций/сек на 1 ядро</li>
<li>Latency: &lt; 1 мс для GET/SET</li>
<li><a href="https://redis.io/topics/benchmarks">Redis Benchmarks</a></li>
</ul>
</li>
<li>
<p><strong>TTL из коробки</strong></p>
<ul>
<li>Автоматическое удаление устаревших результатов</li>
<li>Экономия места (результаты inference TTL = 1 час)</li>
</ul>
</li>
<li>
<p><strong>Data structures</strong></p>
<ul>
<li>Strings: Кэш результатов JSON</li>
<li>Hashes: Сессии пользователей</li>
<li>Sorted Sets: Rate limiting (INCR + EXPIRE)</li>
</ul>
</li>
<li>
<p><strong>Persistence опции</strong></p>
<ul>
<li>RDB snapshots: Backup каждый час</li>
<li>AOF (Append-Only File): Для durability</li>
<li>Hybrid: RDB + AOF для баланса</li>
</ul>
</li>
<li>
<p><strong>High Availability</strong></p>
<ul>
<li>Redis Sentinel: Автоматический failover</li>
<li>Репликация: 1 master + 2 replicas</li>
</ul>
</li>
</ol>
<h3 id="Разделение-ответственности"><a class="header" href="#Разделение-ответственности">Разделение ответственности</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Данные</th><th>PostgreSQL</th><th>Redis</th><th>Обоснование</th></tr></thead><tbody>
<tr><td>Пользователи</td><td>✅</td><td>❌</td><td>ACID, критичность</td></tr>
<tr><td>Медицинские файлы (metadata)</td><td>✅</td><td>❌</td><td>Audit trail</td></tr>
<tr><td>Результаты ИИ</td><td>✅</td><td>✅ (кэш)</td><td>PostgreSQL - постоянное, Redis - быстрый доступ</td></tr>
<tr><td>Сессии</td><td>❌</td><td>✅</td><td>Временные данные, TTL</td></tr>
<tr><td>Rate limiting</td><td>❌</td><td>✅</td><td>Высокая скорость INCR</td></tr>
<tr><td>Отчёты</td><td>✅</td><td>❌</td><td>Архивирование, поиск</td></tr>
</tbody></table>
</div>
<h2 id="Последствия-1"><a class="header" href="#Последствия-1">Последствия</a></h2>
<h3 id="Позитивные-1"><a class="header" href="#Позитивные-1">Позитивные</a></h3>
<ul>
<li>✅ <strong>ACID</strong> для критичных данных (compliance с HIPAA/GDPR)</li>
<li>✅ <strong>Скорость:</strong> Кэш уменьшает latency на 95% (30 мс → 1 мс)</li>
<li>✅ <strong>Масштабируемость:</strong> PostgreSQL read replicas + Redis cluster</li>
<li>✅ <strong>Гибкость:</strong> JSONB для меняющихся структур данных</li>
<li>✅ <strong>Надёжность:</strong> Репликация обоих хранилищ</li>
</ul>
<h3 id="Негативные-1"><a class="header" href="#Негативные-1">Негативные</a></h3>
<ul>
<li>⚠️ <strong>Сложность:</strong> Два хранилища для мониторинга</li>
<li>⚠️ <strong>Синхронизация:</strong> Cache invalidation при обновлении PostgreSQL</li>
<li>⚠️ <strong>Стоимость:</strong> Больше инфраструктуры (Redis Sentinel)</li>
</ul>
<h3 id="Риски-и-митигация-1"><a class="header" href="#Риски-и-митигация-1">Риски и митигация</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Риск</th><th>Вероятность</th><th>Влияние</th><th>Митигация</th></tr></thead><tbody>
<tr><td>Cache invalidation bugs</td><td>Средняя</td><td>Среднее</td><td>TTL + явные invalidation hooks</td></tr>
<tr><td>PostgreSQL перегружен</td><td>Низкая</td><td>Высокое</td><td>Connection pooling + read replicas</td></tr>
<tr><td>Redis out of memory</td><td>Средняя</td><td>Среднее</td><td>Eviction policy (LRU) + мониторинг</td></tr>
<tr><td>Рассинхронизация кэша и БД</td><td>Высокая</td><td>Низкое</td><td>TTL = 1 час, периодическая проверка</td></tr>
</tbody></table>
</div>
<h2 id="Технические-детали-1"><a class="header" href="#Технические-детали-1">Технические детали</a></h2>
<h3 id="postgresql-schema"><a class="header" href="#postgresql-schema">PostgreSQL Schema</a></h3>
<pre><code class="language-sql">-- Users table
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    is_activated BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- Medical data metadata
CREATE TABLE medical_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT REFERENCES users(id),
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    s3_url TEXT NOT NULL,
    file_size BIGINT NOT NULL,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'uploaded'
);

CREATE INDEX idx_medical_data_user ON medical_data(user_id);
CREATE INDEX idx_medical_data_status ON medical_data(status);
CREATE INDEX idx_medical_data_uploaded ON medical_data(uploaded_at);

-- Results table with JSONB
CREATE TABLE results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    medical_data_id UUID REFERENCES medical_data(id),
    predictions JSONB NOT NULL,
    confidence_scores JSONB NOT NULL,
    heatmap_url TEXT,
    inference_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_results_medical_data ON results(medical_data_id);
CREATE INDEX idx_results_predictions ON results USING GIN(predictions);

-- Partitioning results by month
CREATE TABLE results_2024_01 PARTITION OF results
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
</code></pre>
<h3 id="redis-schema"><a class="header" href="#redis-schema">Redis Schema</a></h3>
<pre><code class="language-python"># Cache key patterns
CACHE_RESULT_KEY = "result:{medical_data_id}"
SESSION_KEY = "session:{user_id}"
RATE_LIMIT_KEY = "rate_limit:{user_id}:{minute}"

# Example: Cache result
redis_client.setex(
    name=f"result:{medical_data_id}",
    time=3600,  # TTL = 1 hour
    value=json.dumps(result_dict)
)

# Example: Rate limiting (10 requests/minute)
pipe = redis_client.pipeline()
pipe.incr(f"rate_limit:{user_id}:{current_minute}")
pipe.expire(f"rate_limit:{user_id}:{current_minute}", 60)
count, _ = pipe.execute()

if count &gt; 10:
    raise RateLimitExceeded()
</code></pre>
<h3 id="connection-configuration"><a class="header" href="#connection-configuration">Connection Configuration</a></h3>
<pre><code class="language-yaml"># PostgreSQL (Spring Boot application.yml)
spring:
  datasource:
    url: jdbc:postgresql://postgres-primary:5432/medical_db
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20

# Redis (Spring Data Redis)
spring:
  redis:
    host: redis-sentinel
    port: 26379
    sentinel:
      master: mymaster
      nodes: redis-sentinel-0:26379,redis-sentinel-1:26379
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
</code></pre>
<h3 id="cache-strategy-cache-aside-pattern"><a class="header" href="#cache-strategy-cache-aside-pattern">Cache Strategy (Cache-Aside Pattern)</a></h3>
<pre><code class="language-java">@Service
public class ResultService {
    @Autowired
    private RedisTemplate&lt;String, String&gt; redisTemplate;
    
    @Autowired
    private ResultRepository resultRepository;
    
    public Result getResult(UUID medicalDataId) {
        String cacheKey = "result:" + medicalDataId;
        
        // Try cache first
        String cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return objectMapper.readValue(cached, Result.class);
        }
        
        // Cache miss: load from PostgreSQL
        Result result = resultRepository.findByMedicalDataId(medicalDataId)
            .orElseThrow(() -&gt; new NotFoundException());
        
        // Update cache
        redisTemplate.opsForValue().set(
            cacheKey, 
            objectMapper.writeValueAsString(result),
            Duration.ofHours(1)
        );
        
        return result;
    }
}
</code></pre>
<h2 id="Метрики-успеха-1"><a class="header" href="#Метрики-успеха-1">Метрики успеха</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее значение</th><th>Статус</th></tr></thead><tbody>
<tr><td>PostgreSQL query time (p95)</td><td>&lt; 50 мс</td><td>28 мс</td><td>✅</td></tr>
<tr><td>Redis latency (p99)</td><td>&lt; 5 мс</td><td>1.2 мс</td><td>✅</td></tr>
<tr><td>Cache hit rate</td><td>&gt; 70%</td><td>85%</td><td>✅</td></tr>
<tr><td>PostgreSQL connections</td><td>&lt; 80% pool</td><td>65%</td><td>✅</td></tr>
<tr><td>Redis memory usage</td><td>&lt; 80% max</td><td>52%</td><td>✅</td></tr>
</tbody></table>
</div>
<h2 id="Мониторинг-2"><a class="header" href="#Мониторинг-2">Мониторинг</a></h2>
<h3 id="prometheus-метрики-2"><a class="header" href="#prometheus-метрики-2">Prometheus метрики</a></h3>
<pre><code class="language-yaml"># PostgreSQL (via postgres_exporter)
- pg_stat_database_tup_fetched
- pg_stat_database_tup_returned
- pg_stat_activity_count
- pg_replication_lag_seconds

# Redis (via redis_exporter)
- redis_connected_clients
- redis_used_memory_bytes
- redis_commands_processed_total
- redis_keyspace_hits_total
- redis_keyspace_misses_total
</code></pre>
<h3 id="grafana-дашборд-1"><a class="header" href="#grafana-дашборд-1">Grafana дашборд</a></h3>
<ul>
<li>PostgreSQL: Query time, connections, replication lag</li>
<li>Redis: Hit rate, memory usage, evictions</li>
<li>Кэш эффективность: Hit ratio, eviction rate</li>
</ul>
<h2 id="backup--recovery"><a class="header" href="#backup--recovery">Backup &amp; Recovery</a></h2>
<h3 id="postgresql"><a class="header" href="#postgresql">PostgreSQL</a></h3>
<ul>
<li><strong>Continuous archiving:</strong> WAL archiving в S3</li>
<li><strong>Daily backups:</strong> pg_dump каждый день в 2:00 UTC</li>
<li><strong>PITR:</strong> Восстановление на любую точку времени (последние 30 дней)</li>
<li><strong>Retention:</strong> 30 дней полных бэкапов</li>
</ul>
<h3 id="redis"><a class="header" href="#redis">Redis</a></h3>
<ul>
<li><strong>RDB snapshots:</strong> Каждый час</li>
<li><strong>AOF:</strong> fsync каждую секунду</li>
<li><strong>Retention:</strong> 7 дней snapshots</li>
</ul>
<h2 id="Альтернативы-для-будущего-1"><a class="header" href="#Альтернативы-для-будущего-1">Альтернативы для будущего</a></h2>
<h3 id="Когда-пересмотреть-решение-1"><a class="header" href="#Когда-пересмотреть-решение-1">Когда пересмотреть решение</a></h3>
<ol>
<li><strong>Sharding PostgreSQL:</strong> Если размер БД &gt; 1 TB</li>
<li><strong>Redis Cluster:</strong> Если кэш &gt; 100 GB</li>
<li><strong>TimescaleDB:</strong> Если требуется time-series анализ результатов</li>
<li><strong>Добавить Elasticsearch:</strong> Для full-text search по отчётам</li>
</ol>
<h3 id="Триггеры-для-пересмотра-1"><a class="header" href="#Триггеры-для-пересмотра-1">Триггеры для пересмотра</a></h3>
<ul>
<li>PostgreSQL query time &gt; 100 мс (p95)</li>
<li>Redis memory &gt; 90% регулярно</li>
<li>Необходимость шардирования (&gt; 10M пользователей)</li>
</ul>
<h2 id="Ссылки-1"><a class="header" href="#Ссылки-1">Ссылки</a></h2>
<h3 id="Академические-источники-1"><a class="header" href="#Академические-источники-1">Академические источники</a></h3>
<ol>
<li>«Designing Data-Intensive Applications» Martin Kleppmann (Глава 3: Storage)</li>
<li><a href="https://www.postgresql.org/docs/14/">PostgreSQL Documentation</a></li>
<li><a href="https://redis.io/documentation">Redis Documentation</a></li>
</ol>
<h3 id="Технические-ресурсы-1"><a class="header" href="#Технические-ресурсы-1">Технические ресурсы</a></h3>
<ol>
<li><a href="https://wiki.postgresql.org/wiki/Performance_Optimization">PostgreSQL Performance Tuning</a></li>
<li><a href="https://redis.io/topics/optimization">Redis Best Practices</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cache-aside">Cache-Aside Pattern</a></li>
</ol>
<h3 id="Связанные-adr-1"><a class="header" href="#Связанные-adr-1">Связанные ADR</a></h3>
<ul>
<li><a href="adr/./adr-001-resnet50.html">ADR-001: ResNet-50</a> - хранение результатов inference</li>
<li><a href="adr/./adr-003-rabbitmq.html">ADR-003: RabbitMQ</a> - очередь задач обработки</li>
</ul>
<hr />
<p><strong>Авторы:</strong> Backend Team, DBA<br />
<strong>Ревью:</strong> Tech Lead, DevOps Lead<br />
<strong>Последнее обновление:</strong> 2024-01-10</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="43-adr-003-rabbitmq-для-асинхронной-обработки"><a class="header" href="#43-adr-003-rabbitmq-для-асинхронной-обработки">4.3. ADR-003: RabbitMQ для асинхронной обработки</a></h1>
<h2 id="Статус-2"><a class="header" href="#Статус-2">Статус</a></h2>
<p><strong>Принято</strong> | Дата: 2024-01-12</p>
<h2 id="Контекст-2"><a class="header" href="#Контекст-2">Контекст</a></h2>
<p>Система требует асинхронной обработки медицинских данных для:</p>
<ol>
<li><strong>Долгие операции:</strong> ИИ-анализ изображений (2 секунды)</li>
<li><strong>Отказоустойчивость:</strong> Повторная обработка при сбоях</li>
<li><strong>Масштабируемость:</strong> Обработка 1000+ одновременных запросов</li>
<li><strong>Разделение ответственности:</strong> Data Upload Service ≠ ML Inference Service</li>
</ol>
<p>Требования:</p>
<ul>
<li><strong>Гарантия доставки:</strong> At-least-once delivery</li>
<li><strong>Retry механизм:</strong> Повторная обработка неудачных задач</li>
<li><strong>Dead Letter Queue:</strong> Изоляция проблемных сообщений</li>
<li><strong>Throughput:</strong> ≥ 100 сообщений/секунду</li>
</ul>
<h2 id="Рассмотренные-варианты-2"><a class="header" href="#Рассмотренные-варианты-2">Рассмотренные варианты</a></h2>
<h3 id="Вариант-1-rabbitmq"><a class="header" href="#Вариант-1-rabbitmq">Вариант 1: RabbitMQ</a></h3>
<ul>
<li><strong>Тип:</strong> Message broker (AMQP 0.9.1)</li>
<li><strong>Преимущества:</strong> Гарантии доставки, DLQ, простота</li>
<li><strong>Недостатки:</strong> Меньший throughput, чем Kafka</li>
</ul>
<h3 id="Вариант-2-apache-kafka"><a class="header" href="#Вариант-2-apache-kafka">Вариант 2: Apache Kafka</a></h3>
<ul>
<li><strong>Тип:</strong> Distributed streaming platform</li>
<li><strong>Преимущества:</strong> Высокий throughput (1M msg/sec), persistence</li>
<li><strong>Недостатки:</strong> Сложность, overkill для проекта</li>
</ul>
<h3 id="Вариант-3-aws-sqs"><a class="header" href="#Вариант-3-aws-sqs">Вариант 3: AWS SQS</a></h3>
<ul>
<li><strong>Тип:</strong> Managed queue service</li>
<li><strong>Преимущества:</strong> Serverless, автомасштабирование</li>
<li><strong>Недостатки:</strong> Vendor lock-in, задержки (visibility timeout)</li>
</ul>
<h3 id="Вариант-4-redis-pubsub"><a class="header" href="#Вариант-4-redis-pubsub">Вариант 4: Redis Pub/Sub</a></h3>
<ul>
<li><strong>Тип:</strong> In-memory messaging</li>
<li><strong>Преимущества:</strong> Скорость, простота</li>
<li><strong>Недостатки:</strong> Нет гарантий доставки, нет persistence</li>
</ul>
<h2 id="Решение-2"><a class="header" href="#Решение-2">Решение</a></h2>
<p><strong>Выбрано: RabbitMQ 3.9</strong></p>
<h3 id="Обоснование-3"><a class="header" href="#Обоснование-3">Обоснование</a></h3>
<ol>
<li>
<p><strong>AMQP протокол</strong></p>
<ul>
<li>Стандартизированный протокол (ISO/IEC 19464)</li>
<li>Гарантии доставки: At-least-once (acknowledgments)</li>
<li>Publisher confirms для надёжности</li>
</ul>
</li>
<li>
<p><strong>Гибкие паттерны маршрутизации</strong></p>
<ul>
<li><strong>Direct exchange:</strong> Для специфичных задач (medical_data)</li>
<li><strong>Topic exchange:</strong> Для разных типов данных (image.xray, text.symptoms)</li>
<li><strong>Dead Letter Exchange:</strong> Автоматическая изоляция проблемных сообщений</li>
</ul>
</li>
<li>
<p><strong>Зрелость и надёжность</strong></p>
<ul>
<li>13+ лет в production</li>
<li>Используется Uber, Reddit, NASA</li>
<li><a href="https://www.rabbitmq.com/case-studies.html">RabbitMQ Case Studies</a></li>
</ul>
</li>
<li>
<p><strong>Throughput достаточен</strong></p>
<ul>
<li>10k-50k msg/sec на стандартном сервере</li>
<li>Наше требование: ~100-200 msg/sec</li>
<li>Запас производительности: 50x</li>
</ul>
</li>
<li>
<p><strong>Retry механизм из коробки</strong></p>
<ul>
<li>TTL (Time-To-Live) для сообщений</li>
<li>Dead Letter Queue для неудачных попыток</li>
<li>Exponential backoff через TTL</li>
</ul>
</li>
<li>
<p><strong>Management UI</strong></p>
<ul>
<li>Встроенный веб-интерфейс для мониторинга</li>
<li>Метрики: queue size, publish rate, ack rate</li>
<li>Визуализация топологии exchanges/queues</li>
</ul>
</li>
<li>
<p><strong>Простота vs Kafka</strong></p>
<ul>
<li>Не требуется Zookeeper/KRaft</li>
<li>Меньше ресурсов (CPU, RAM)</li>
<li>Быстрее setup и maintenance</li>
</ul>
</li>
</ol>
<h3 id="Почему-не-kafka"><a class="header" href="#Почему-не-kafka">Почему не Kafka?</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Критерий</th><th>RabbitMQ</th><th>Kafka</th><th>Победитель</th></tr></thead><tbody>
<tr><td>Throughput</td><td>50k msg/sec</td><td>1M msg/sec</td><td>Kafka</td></tr>
<tr><td>Latency</td><td>1-5 мс</td><td>5-10 мс</td><td>RabbitMQ</td></tr>
<tr><td>Гарантии доставки</td><td>At-least-once</td><td>At-least-once</td><td>Ничья</td></tr>
<tr><td>Complexity</td><td>Низкая</td><td>Высокая</td><td>RabbitMQ</td></tr>
<tr><td>Retention</td><td>Не нужен</td><td>Долгосрочное хранение</td><td>Kafka</td></tr>
<tr><td><strong>Наши требования</strong></td><td>✅ Достаточно</td><td>❌ Overkill</td><td><strong>RabbitMQ</strong></td></tr>
</tbody></table>
</div>
<p><strong>Вывод:</strong> Kafka избыточен для throughput 100-200 msg/sec и не требуется event sourcing.</p>
<h2 id="Последствия-2"><a class="header" href="#Последствия-2">Последствия</a></h2>
<h3 id="Позитивные-2"><a class="header" href="#Позитивные-2">Позитивные</a></h3>
<ul>
<li>✅ <strong>Отказоустойчивость:</strong> Сообщения не теряются при сбое consumer</li>
<li>✅ <strong>Масштабируемость:</strong> Multiple consumers для параллельной обработки</li>
<li>✅ <strong>Разделение:</strong> Data Upload Service не ждёт ML Inference</li>
<li>✅ <strong>Retry:</strong> Автоматическая повторная обработка неудачных задач</li>
<li>✅ <strong>Monitoring:</strong> Prometheus exporter для метрик</li>
</ul>
<h3 id="Негативные-2"><a class="header" href="#Негативные-2">Негативные</a></h3>
<ul>
<li>⚠️ <strong>Single point of failure:</strong> Без HA кластера</li>
<li>⚠️ <strong>Ordering:</strong> Не гарантирует порядок при multiple consumers</li>
<li>⚠️ <strong>Memory:</strong> In-memory queue может заполниться при высокой нагрузке</li>
</ul>
<h3 id="Риски-и-митигация-2"><a class="header" href="#Риски-и-митигация-2">Риски и митигация</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Риск</th><th>Вероятность</th><th>Влияние</th><th>Митигация</th></tr></thead><tbody>
<tr><td>RabbitMQ падает</td><td>Низкая</td><td>Высокое</td><td>Кластер (3 ноды), Quorum queues</td></tr>
<tr><td>Queue переполнена</td><td>Средняя</td><td>Среднее</td><td>Max-length + TTL, dead letter queue</td></tr>
<tr><td>Consumer медленный</td><td>Средняя</td><td>Среднее</td><td>Autoscaling consumers (KEDA)</td></tr>
<tr><td>Сообщение застревает</td><td>Низкая</td><td>Низкое</td><td>Message TTL = 24 часа</td></tr>
</tbody></table>
</div>
<h2 id="Технические-детали-2"><a class="header" href="#Технические-детали-2">Технические детали</a></h2>
<h3 id="Архитектура-очередей"><a class="header" href="#Архитектура-очередей">Архитектура очередей</a></h3>
<pre><code>┌──────────────────────────────────────────────────────┐
│           RabbitMQ Cluster (3 nodes)                 │
│                                                      │
│  ┌─────────────────┐         ┌─────────────────┐   │
│  │  medical_exchange│────────&gt;│ medical_data    │   │
│  │   (Direct)      │         │   (Queue)       │   │
│  └─────────────────┘         └─────────────────┘   │
│         │                            │              │
│         │ routing_key:               │ consumers    │
│         │ "medical.data"             ↓              │
│         │                    ┌─────────────────┐   │
│         │                    │  ML Inference   │   │
│         │                    │   Service       │   │
│         │                    │  (3 replicas)   │   │
│         │                    └─────────────────┘   │
│         │                                           │
│         │ DLX                                       │
│         ↓                                           │
│  ┌─────────────────┐         ┌─────────────────┐   │
│  │  dlx_exchange   │────────&gt;│    dlq          │   │
│  │   (Fanout)      │         │ (Dead Letter)   │   │
│  └─────────────────┘         └─────────────────┘   │
│                                      │              │
│                                      │ manual review│
│                                      ↓              │
│                              ┌─────────────────┐   │
│                              │  Alert Service  │   │
│                              └─────────────────┘   │
└──────────────────────────────────────────────────────┘
</code></pre>
<h3 id="queue-configuration"><a class="header" href="#queue-configuration">Queue Configuration</a></h3>
<pre><code class="language-python"># Connection
connection = pika.BlockingConnection(
    pika.ConnectionParameters(
        host='rabbitmq-cluster',
        port=5672,
        virtual_host='/',
        credentials=pika.PlainCredentials('user', 'password'),
        heartbeat=600,
        blocked_connection_timeout=300
    )
)
channel = connection.channel()

# Main exchange
channel.exchange_declare(
    exchange='medical_exchange',
    exchange_type='direct',
    durable=True
)

# Dead Letter Exchange
channel.exchange_declare(
    exchange='dlx_exchange',
    exchange_type='fanout',
    durable=True
)

# Main queue with DLX
channel.queue_declare(
    queue='medical_data',
    durable=True,
    arguments={
        'x-dead-letter-exchange': 'dlx_exchange',
        'x-message-ttl': 86400000,  # 24 hours
        'x-max-length': 10000,       # Max 10k messages
        'x-max-priority': 10,        # Priority queue
        'x-queue-type': 'quorum'     # Quorum queue (HA)
    }
)

# Dead Letter Queue
channel.queue_declare(
    queue='dlq',
    durable=True
)

# Bindings
channel.queue_bind(
    exchange='medical_exchange',
    queue='medical_data',
    routing_key='medical.data'
)

channel.queue_bind(
    exchange='dlx_exchange',
    queue='dlq'
)
</code></pre>
<h3 id="producer-data-upload-service"><a class="header" href="#producer-data-upload-service">Producer (Data Upload Service)</a></h3>
<pre><code class="language-java">@Service
public class MessageProducer {
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendToMLService(MedicalData data) {
        MessageProperties props = new MessageProperties();
        props.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
        props.setPriority(data.isUrgent() ? 10 : 5);
        props.setExpiration("86400000"); // 24h TTL
        
        Message message = new Message(
            objectMapper.writeValueAsBytes(data),
            props
        );
        
        // Publisher confirms enabled
        rabbitTemplate.convertAndSend(
            "medical_exchange",
            "medical.data",
            message
        );
    }
}
</code></pre>
<h3 id="consumer-ml-inference-service"><a class="header" href="#consumer-ml-inference-service">Consumer (ML Inference Service)</a></h3>
<pre><code class="language-python">def callback(ch, method, properties, body):
    try:
        # Parse message
        data = json.loads(body)
        medical_data_id = data['medical_data_id']
        
        # Process (ML inference)
        result = ml_service.process(medical_data_id)
        
        # Save result
        result_repository.save(result)
        
        # Acknowledge
        ch.basic_ack(delivery_tag=method.delivery_tag)
        
    except Exception as e:
        logger.error(f"Processing failed: {e}")
        
        # Retry logic
        retry_count = properties.headers.get('x-retry-count', 0)
        
        if retry_count &lt; 3:
            # Requeue with delay (exponential backoff)
            delay = 2 ** retry_count * 1000  # 1s, 2s, 4s
            
            ch.basic_publish(
                exchange='medical_exchange',
                routing_key='medical.data',
                body=body,
                properties=pika.BasicProperties(
                    delivery_mode=2,
                    headers={'x-retry-count': retry_count + 1},
                    expiration=str(delay)
                )
            )
            ch.basic_ack(delivery_tag=method.delivery_tag)
        else:
            # Max retries reached -&gt; DLQ
            ch.basic_nack(
                delivery_tag=method.delivery_tag,
                requeue=False  # Send to DLX
            )

# Consumer setup
channel.basic_qos(prefetch_count=1)  # Fair dispatch
channel.basic_consume(
    queue='medical_data',
    on_message_callback=callback,
    auto_ack=False  # Manual ack
)

channel.start_consuming()
</code></pre>
<h3 id="kubernetes-deployment"><a class="header" href="#kubernetes-deployment">Kubernetes Deployment</a></h3>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
spec:
  serviceName: rabbitmq
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3.9-management
        ports:
        - containerPort: 5672
          name: amqp
        - containerPort: 15672
          name: management
        env:
        - name: RABBITMQ_DEFAULT_USER
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: username
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: password
        - name: RABBITMQ_ERLANG_COOKIE
          value: "secret-cookie"
        volumeMounts:
        - name: data
          mountPath: /var/lib/rabbitmq
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
</code></pre>
<h2 id="Метрики-успеха-2"><a class="header" href="#Метрики-успеха-2">Метрики успеха</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Целевое значение</th><th>Текущее значение</th><th>Статус</th></tr></thead><tbody>
<tr><td>Message throughput</td><td>≥ 100 msg/sec</td><td>150 msg/sec</td><td>✅</td></tr>
<tr><td>Publish latency (p95)</td><td>&lt; 10 мс</td><td>3 мс</td><td>✅</td></tr>
<tr><td>Consumer latency</td><td>&lt; 5 секунд</td><td>2.1 секунды</td><td>✅</td></tr>
<tr><td>Message loss rate</td><td>0%</td><td>0%</td><td>✅</td></tr>
<tr><td>DLQ rate</td><td>&lt; 1%</td><td>0.2%</td><td>✅</td></tr>
</tbody></table>
</div>
<h2 id="Мониторинг-3"><a class="header" href="#Мониторинг-3">Мониторинг</a></h2>
<h3 id="prometheus-метрики-rabbitmq_exporter"><a class="header" href="#prometheus-метрики-rabbitmq_exporter">Prometheus метрики (rabbitmq_exporter)</a></h3>
<pre><code class="language-yaml"># Queue metrics
- rabbitmq_queue_messages_ready
- rabbitmq_queue_messages_unacknowledged
- rabbitmq_queue_consumers

# Message rates
- rabbitmq_queue_messages_published_total
- rabbitmq_queue_messages_delivered_total
- rabbitmq_queue_messages_redelivered_total

# Cluster health
- rabbitmq_up
- rabbitmq_node_disk_free_bytes
- rabbitmq_node_mem_used_bytes
</code></pre>
<h3 id="grafana-дашборд-2"><a class="header" href="#grafana-дашборд-2">Grafana дашборд</a></h3>
<ul>
<li>Queue size (ready, unacked)</li>
<li>Publish/consume rate</li>
<li>Consumer lag</li>
<li>DLQ size (alarm if &gt; 10)</li>
</ul>
<h3 id="alerting"><a class="header" href="#alerting">Alerting</a></h3>
<pre><code class="language-yaml"># AlertManager rules
groups:
- name: rabbitmq
  rules:
  - alert: RabbitMQDown
    expr: rabbitmq_up == 0
    for: 1m
    annotations:
      summary: "RabbitMQ is down"
      
  - alert: RabbitMQQueueOverflow
    expr: rabbitmq_queue_messages_ready &gt; 5000
    for: 5m
    annotations:
      summary: "Queue overflow: {{ $value }} messages"
      
  - alert: RabbitMQHighDLQ
    expr: rabbitmq_queue_messages{queue="dlq"} &gt; 50
    for: 10m
    annotations:
      summary: "High DLQ rate: {{ $value }} failed messages"
</code></pre>
<h2 id="disaster-recovery"><a class="header" href="#disaster-recovery">Disaster Recovery</a></h2>
<h3 id="backup"><a class="header" href="#backup">Backup</a></h3>
<ul>
<li><strong>Queue definitions:</strong> Export via management API (daily)</li>
<li><strong>Messages:</strong> Persistence на диске (durable queues)</li>
<li><strong>Cluster state:</strong> Etcd backup (hourly)</li>
</ul>
<h3 id="recovery"><a class="header" href="#recovery">Recovery</a></h3>
<ol>
<li><strong>Single node failure:</strong> Автоматический failover (quorum queues)</li>
<li><strong>Cluster failure:</strong> Restore от последнего backup</li>
<li><strong>Data loss:</strong> Reprocess от последнего checkpoint в PostgreSQL</li>
</ol>
<h2 id="Альтернативы-для-будущего-2"><a class="header" href="#Альтернативы-для-будущего-2">Альтернативы для будущего</a></h2>
<h3 id="Когда-пересмотреть-решение-2"><a class="header" href="#Когда-пересмотреть-решение-2">Когда пересмотреть решение</a></h3>
<ol>
<li><strong>Apache Kafka</strong>: Если throughput &gt; 10k msg/sec</li>
<li><strong>AWS SQS</strong>: Если миграция в AWS и не требуется on-premise</li>
<li><strong>NATS</strong>: Если требуется ultra-low latency (&lt; 1 мс)</li>
</ol>
<h3 id="Триггеры-для-пересмотра-2"><a class="header" href="#Триггеры-для-пересмотра-2">Триггеры для пересмотра</a></h3>
<ul>
<li>Throughput требование &gt; 50k msg/sec</li>
<li>Требуется event sourcing (long retention)</li>
<li>Требуется exactly-once delivery semantics</li>
</ul>
<h2 id="Ссылки-2"><a class="header" href="#Ссылки-2">Ссылки</a></h2>
<h3 id="Академические-источники-2"><a class="header" href="#Академические-источники-2">Академические источники</a></h3>
<ol>
<li><a href="https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf">AMQP 0.9.1 Specification</a></li>
<li>«Enterprise Integration Patterns» Gregor Hohpe</li>
</ol>
<h3 id="Технические-ресурсы-2"><a class="header" href="#Технические-ресурсы-2">Технические ресурсы</a></h3>
<ol>
<li><a href="https://www.rabbitmq.com/documentation.html">RabbitMQ Documentation</a></li>
<li><a href="https://www.cloudamqp.com/blog/part1-rabbitmq-best-practice.html">RabbitMQ Best Practices</a></li>
<li><a href="https://www.rabbitmq.com/quorum-queues.html">Quorum Queues</a></li>
</ol>
<h3 id="Связанные-adr-2"><a class="header" href="#Связанные-adr-2">Связанные ADR</a></h3>
<ul>
<li><a href="adr/./adr-001-resnet50.html">ADR-001: ResNet-50</a> - асинхронная обработка изображений</li>
<li><a href="adr/./adr-002-postgresql-redis.html">ADR-002: PostgreSQL + Redis</a> - хранение результатов</li>
</ul>
<hr />
<p><strong>Авторы:</strong> Backend Team, DevOps<br />
<strong>Ревью:</strong> Tech Lead, Solutions Architect<br />
<strong>Последнее обновление:</strong> 2024-01-12</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="Публичный-api-swagger-documentation"><a class="header" href="#Публичный-api-swagger-documentation">Публичный API (Swagger Documentation)</a></h1>
<h2 id="Обзор"><a class="header" href="#Обзор">Обзор</a></h2>
<p>Medical Diagnosis Platform предоставляет RESTful API для интеграции с внешними системами и клиентскими приложениями.</p>
<h3 id="Базовый-url"><a class="header" href="#Базовый-url">Базовый URL</a></h3>
<ul>
<li><strong>Production:</strong> <code>https://api.med-diagnosis.com/v1</code></li>
<li><strong>Staging:</strong> <code>https://staging-api.med-diagnosis.com/v1</code></li>
<li><strong>Development:</strong> <code>http://localhost:8080/api/v1</code></li>
</ul>
<h3 id="Аутентификация"><a class="header" href="#Аутентификация">Аутентификация</a></h3>
<p>API использует <strong>JWT (JSON Web Tokens)</strong> для аутентификации:</p>
<pre><code class="language-http">Authorization: Bearer {your_jwt_token}
</code></pre>
<p>Получить токен можно через эндпоинт <code>/auth/login</code>.</p>
<h3 id="rate-limiting"><a class="header" href="#rate-limiting">Rate Limiting</a></h3>
<ul>
<li><strong>Аутентифицированные пользователи:</strong> 100 запросов/минуту</li>
<li><strong>Неаутентифицированные:</strong> 10 запросов/минуту</li>
</ul>
<p>Информация о лимитах возвращается в заголовках ответа:</p>
<pre><code class="language-http">X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1642512000
</code></pre>
<h2 id="Интерактивная-документация"><a class="header" href="#Интерактивная-документация">Интерактивная документация</a></h2>
<iframe src="swagger/swagger.html" width="100%" height="1500px" style="border:0;" allowfullscreen="allowfullscreen"></iframe>
<hr />
<h2 id="Основные-эндпоинты"><a class="header" href="#Основные-эндпоинты">Основные эндпоинты</a></h2>
<h3 id="1-Регистрация-пользователя"><a class="header" href="#1-Регистрация-пользователя">1. Регистрация пользователя</a></h3>
<pre><code class="language-http">POST /auth/register
Content-Type: application/json

{
  "email": "patient@example.com",
  "password": "SecurePass123!",
  "firstName": "Иван",
  "lastName": "Петров"
}
</code></pre>
<p><strong>Ответ (201 Created):</strong></p>
<pre><code class="language-json">{
  "message": "Регистрация успешна. Проверьте email для активации.",
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}
</code></pre>
<hr />
<h3 id="2-Вход-в-систему"><a class="header" href="#2-Вход-в-систему">2. Вход в систему</a></h3>
<pre><code class="language-http">POST /auth/login
Content-Type: application/json

{
  "email": "patient@example.com",
  "password": "SecurePass123!"
}
</code></pre>
<p><strong>Ответ (200 OK):</strong></p>
<pre><code class="language-json">{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tokenType": "Bearer",
  "expiresIn": 3600,
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
</code></pre>
<hr />
<h3 id="3-Загрузка-медицинских-данных"><a class="header" href="#3-Загрузка-медицинских-данных">3. Загрузка медицинских данных</a></h3>
<pre><code class="language-http">POST /upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

image: &lt;binary file&gt;
symptoms: {"symptoms": ["головная боль", "температура 38.5"], "duration": "3 дня"}
</code></pre>
<p><strong>Ответ (202 Accepted):</strong></p>
<pre><code class="language-json">{
  "taskId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "message": "Данные загружены и отправлены на обработку",
  "estimatedTime": 5
}
</code></pre>
<hr />
<h3 id="4-Проверка-статуса-обработки"><a class="header" href="#4-Проверка-статуса-обработки">4. Проверка статуса обработки</a></h3>
<pre><code class="language-http">GET /analysis/{taskId}/status
Authorization: Bearer {token}
</code></pre>
<p><strong>Ответ (200 OK) - Обработка:</strong></p>
<pre><code class="language-json">{
  "taskId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "processing",
  "progress": 65,
  "message": "Анализ изображения ResNet-50"
}
</code></pre>
<hr />
<h3 id="5-Получение-результатов-анализа"><a class="header" href="#5-Получение-результатов-анализа">5. Получение результатов анализа</a></h3>
<pre><code class="language-http">GET /analysis/{taskId}/result
Authorization: Bearer {token}
</code></pre>
<p><strong>Ответ (200 OK):</strong></p>
<pre><code class="language-json">{
  "taskId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "imagePredictions": [
    {
      "disease": "Пневмония",
      "probability": 0.952,
      "confidence": "высокая"
    }
  ],
  "textPredictions": [
    {
      "disease": "Грипп",
      "probability": 0.782,
      "symptoms": ["температура", "головная боль"]
    }
  ],
  "heatmapUrl": "https://cdn.med-diagnosis.com/heatmaps/a1b2c3d4.png",
  "combinedDiagnosis": [
    {
      "disease": "Пневмония",
      "overallProbability": 0.867,
      "recommendation": "Требуется консультация пульмонолога"
    }
  ],
  "processingTime": 2.3
}
</code></pre>
<hr />
<h3 id="6-Скачивание-pdf-отчёта"><a class="header" href="#6-Скачивание-pdf-отчёта">6. Скачивание PDF отчёта</a></h3>
<pre><code class="language-http">GET /reports/{taskId}?format=pdf
Authorization: Bearer {token}
</code></pre>
<p><strong>Ответ (200 OK):</strong></p>
<ul>
<li>Content-Type: <code>application/pdf</code></li>
<li>Binary PDF file</li>
</ul>
<hr />
<h2 id="Коды-ошибок"><a class="header" href="#Коды-ошибок">Коды ошибок</a></h2>
<div class="table-wrapper"><table><thead><tr><th>HTTP Code</th><th>Код ошибки</th><th>Описание</th></tr></thead><tbody>
<tr><td>400</td><td><code>INVALID_REQUEST</code></td><td>Невалидные данные в запросе</td></tr>
<tr><td>401</td><td><code>UNAUTHORIZED</code></td><td>Требуется аутентификация</td></tr>
<tr><td>403</td><td><code>FORBIDDEN</code></td><td>Недостаточно прав доступа</td></tr>
<tr><td>404</td><td><code>NOT_FOUND</code></td><td>Ресурс не найден</td></tr>
<tr><td>409</td><td><code>EMAIL_EXISTS</code></td><td>Email уже зарегистрирован</td></tr>
<tr><td>413</td><td><code>FILE_TOO_LARGE</code></td><td>Файл превышает 10 МБ</td></tr>
<tr><td>425</td><td><code>PROCESSING_NOT_COMPLETE</code></td><td>Обработка ещё не завершена</td></tr>
<tr><td>429</td><td><code>RATE_LIMIT_EXCEEDED</code></td><td>Превышен лимит запросов</td></tr>
<tr><td>500</td><td><code>INTERNAL_ERROR</code></td><td>Внутренняя ошибка сервера</td></tr>
<tr><td>502</td><td><code>MIS_UNAVAILABLE</code></td><td>MIS система недоступна</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="Примеры-интеграции"><a class="header" href="#Примеры-интеграции">Примеры интеграции</a></h2>
<h3 id="python-requests"><a class="header" href="#python-requests">Python (requests)</a></h3>
<pre><code class="language-python">import requests

BASE_URL = "https://api.med-diagnosis.com/v1"

# Вход
response = requests.post(
    f"{BASE_URL}/auth/login",
    json={"email": "patient@example.com", "password": "SecurePass123!"}
)
token = response.json()["accessToken"]

# Загрузка данных
files = {"image": open("xray.jpg", "rb")}
data = {"symptoms": '{"symptoms": ["головная боль"]}'}
headers = {"Authorization": f"Bearer {token}"}

response = requests.post(
    f"{BASE_URL}/upload",
    files=files,
    data=data,
    headers=headers
)
task_id = response.json()["taskId"]
</code></pre>
<h3 id="javascript-fetch"><a class="header" href="#javascript-fetch">JavaScript (fetch)</a></h3>
<pre><code class="language-javascript">const BASE_URL = "https://api.med-diagnosis.com/v1";

async function login(email, password) {
  const response = await fetch(`${BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  return (await response.json()).accessToken;
}

async function uploadData(token, imageFile, symptoms) {
  const formData = new FormData();
  formData.append('image', imageFile);
  formData.append('symptoms', JSON.stringify(symptoms));
  
  const response = await fetch(`${BASE_URL}/upload`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  });
  
  return await response.json();
}
</code></pre>
<hr />
<h2 id="Источники-13"><a class="header" href="#Источники-13">Источники</a></h2>
<ol>
<li><a href="https://swagger.io/specification/">OpenAPI 3.0 Specification</a></li>
<li><a href="https://swagger.io/tools/swagger-ui/">Swagger UI Documentation</a></li>
<li>«RESTful API Design» Leonard Richardson</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="61-Инфраструктура-и-деплой"><a class="header" href="#61-Инфраструктура-и-деплой">6.1. Инфраструктура и деплой</a></h1>
<h2 id="1-Инфраструктурные-компоненты"><a class="header" href="#1-Инфраструктурные-компоненты">1. Инфраструктурные компоненты</a></h2>
<h3 id="Обзор-архитектуры"><a class="header" href="#Обзор-архитектуры">Обзор архитектуры</a></h3>
<p><img src="img/img5.png" alt="Компонентная схема" /></p>
<div class="table-wrapper"><table><thead><tr><th>Компонент</th><th>Технология</th><th>Роль</th><th>Масштабирование</th></tr></thead><tbody>
<tr><td>API Gateway</td><td>Spring Cloud Gateway</td><td>Маршрутизация, JWT auth</td><td>Horizontal (3+ replicas)</td></tr>
<tr><td>ML Inference</td><td>TensorFlow Serving 2.10</td><td>GPU inference</td><td>Auto-scaling (GPU)</td></tr>
<tr><td>Database</td><td>PostgreSQL 14</td><td>Метаданные, ACID</td><td>Master-Slave replication</td></tr>
<tr><td>Cache</td><td>Redis 7.0</td><td>Результаты, сессии</td><td>Redis Sentinel (HA)</td></tr>
<tr><td>Message Broker</td><td>RabbitMQ 3.9</td><td>Асинхронная обработка</td><td>Cluster (3 nodes)</td></tr>
<tr><td>Logging</td><td>ELK Stack</td><td>Мониторинг, аудит</td><td>Elastic cluster</td></tr>
<tr><td>Orchestration</td><td>Kubernetes 1.27</td><td>Контейнеризация</td><td>Multi-node cluster</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="2-Процесс-деплоя"><a class="header" href="#2-Процесс-деплоя">2. Процесс деплоя</a></h2>
<h3 id="cicd-pipeline-gitlab-ci"><a class="header" href="#cicd-pipeline-gitlab-ci">CI/CD Pipeline (GitLab CI)</a></h3>
<pre><code class="language-mermaid">graph LR
    Start([📝 Git Push])
    
    Build[🔨 Build&lt;br/&gt;Maven/Gradle]
    UnitTest[🧪 Unit Tests&lt;br/&gt;JUnit/Pytest]
    IntegTest[🔗 Integration&lt;br/&gt;Tests]
    DockerBuild[🐳 Docker Build&lt;br/&gt;Multi-stage]
    Registry[📦 Push to&lt;br/&gt;Registry]
    
    Decision{🌍 Environment?}
    
    Staging[🔧 Deploy&lt;br/&gt;Staging]
    Approval[✋ Manual&lt;br/&gt;Approval]
    Production[🚀 Deploy&lt;br/&gt;Production]
    Smoke[💨 Smoke&lt;br/&gt;Tests]
    Monitor[📊 Monitoring&lt;br/&gt;Prometheus]
    
    Start --&gt; Build
    Build --&gt; UnitTest
    UnitTest --&gt; IntegTest
    IntegTest --&gt; DockerBuild
    DockerBuild --&gt; Registry
    Registry --&gt; Decision
    
    Decision --&gt;|Staging| Staging
    Decision --&gt;|Production| Approval
    Approval --&gt; Production
    
    Staging --&gt; Monitor
    Production --&gt; Smoke
    Smoke --&gt; Monitor
    
    style Start fill:#67c23a,stroke:#4a9428,stroke-width:2px
    style Build fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px,color:#fff
    style UnitTest fill:#9966ff,stroke:#7744cc,stroke-width:2px,color:#fff
    style IntegTest fill:#9966ff,stroke:#7744cc,stroke-width:2px,color:#fff
    style DockerBuild fill:#2496ed,stroke:#1a6db8,stroke-width:2px,color:#fff
    style Registry fill:#2496ed,stroke:#1a6db8,stroke-width:2px,color:#fff
    style Decision fill:#e6a23c,stroke:#b8821e,stroke-width:2px
    style Staging fill:#67c23a,stroke:#4a9428,stroke-width:2px
    style Production fill:#f56c6c,stroke:#c94545,stroke-width:2px,color:#fff
    style Approval fill:#ff9900,stroke:#cc7700,stroke-width:2px
    style Monitor fill:#e6522c,stroke:#b84123,stroke-width:2px,color:#fff
</code></pre>
<h3 id="Этапы-деплоя"><a class="header" href="#Этапы-деплоя">Этапы деплоя</a></h3>
<h4 id="1-Сборка-образов"><a class="header" href="#1-Сборка-образов">1. Сборка образов</a></h4>
<pre><code class="language-yaml"># .gitlab-ci.yml
build:
  stage: build
  script:
    - docker build -t api-gateway:$CI_COMMIT_SHA .
    - docker build -t ml-service:$CI_COMMIT_SHA ./ml-service
    - docker build -t data-upload:$CI_COMMIT_SHA ./data-upload
  artifacts:
    paths:
      - build/
</code></pre>
<h4 id="2-Тестирование"><a class="header" href="#2-Тестирование">2. Тестирование</a></h4>
<pre><code class="language-yaml">test:
  stage: test
  script:
    # Unit tests
    - mvn test
    - pytest tests/
    
    # Integration tests
    - docker-compose -f docker-compose.test.yml up -d
    - newman run postman_collection.json
    
    # Load tests
    - jmeter -n -t load-test.jmx -l results.jtl
</code></pre>
<h4 id="3-Разворачивание-в-kubernetes"><a class="header" href="#3-Разворачивание-в-kubernetes">3. Разворачивание в Kubernetes</a></h4>
<pre><code class="language-yaml">deploy:
  stage: deploy
  script:
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/configmap.yaml
    - kubectl apply -f k8s/secrets.yaml
    - helm upgrade --install medical-platform ./charts/medical-platform
  only:
    - main
</code></pre>
<hr />
<h2 id="3-kubernetes-configuration"><a class="header" href="#3-kubernetes-configuration">3. Kubernetes Configuration</a></h2>
<h3 id="api-gateway-deployment"><a class="header" href="#api-gateway-deployment">API Gateway Deployment</a></h3>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: medical-platform
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: api-gateway
        image: registry.med-diagnosis.com/api-gateway:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
</code></pre>
<h3 id="ml-inference-service-gpu"><a class="header" href="#ml-inference-service-gpu">ML Inference Service (GPU)</a></h3>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-inference
  namespace: medical-platform
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ml-inference
  template:
    metadata:
      labels:
        app: ml-inference
    spec:
      containers:
      - name: tensorflow-serving
        image: tensorflow/serving:2.10.0-gpu
        ports:
        - containerPort: 8500  # gRPC
        - containerPort: 8501  # REST
        env:
        - name: MODEL_NAME
          value: "resnet50_chest_xray"
        - name: MODEL_BASE_PATH
          value: "/models"
        volumeMounts:
        - name: models
          mountPath: /models
        resources:
          limits:
            nvidia.com/gpu: 1  # Request 1 GPU
      volumes:
      - name: models
        persistentVolumeClaim:
          claimName: ml-models-pvc
      nodeSelector:
        cloud.google.com/gke-accelerator: nvidia-tesla-t4
</code></pre>
<h3 id="horizontalpodautoscaler"><a class="header" href="#horizontalpodautoscaler">HorizontalPodAutoscaler</a></h3>
<pre><code class="language-yaml">apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway-hpa
  namespace: medical-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
</code></pre>
<h3 id="keda-для-rabbitmq"><a class="header" href="#keda-для-rabbitmq">KEDA для RabbitMQ</a></h3>
<pre><code class="language-yaml">apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ml-inference-scaler
  namespace: medical-platform
spec:
  scaleTargetRef:
    name: ml-inference
  minReplicaCount: 1
  maxReplicaCount: 5
  triggers:
  - type: rabbitmq
    metadata:
      queueName: medical_data
      queueLength: "10"  # Scale if queue &gt; 10 messages
      host: "amqp://rabbitmq:5672"
</code></pre>
<hr />
<h2 id="4-Мониторинг"><a class="header" href="#4-Мониторинг">4. Мониторинг</a></h2>
<h3 id="prometheus-1"><a class="header" href="#prometheus-1">Prometheus</a></h3>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      # API Gateway
      - job_name: 'api-gateway'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: api-gateway
      
      # ML Inference
      - job_name: 'ml-inference'
        static_configs:
          - targets: ['ml-inference:8501']
      
      # PostgreSQL
      - job_name: 'postgresql'
        static_configs:
          - targets: ['postgres-exporter:9187']
      
      # RabbitMQ
      - job_name: 'rabbitmq'
        static_configs:
          - targets: ['rabbitmq-exporter:9419']
      
      # GPU Metrics
      - job_name: 'dcgm'
        static_configs:
          - targets: ['dcgm-exporter:9400']
</code></pre>
<h3 id="grafana-дашборды-1"><a class="header" href="#grafana-дашборды-1">Grafana дашборды</a></h3>
<h4 id="system-overview-dashboard"><a class="header" href="#system-overview-dashboard">System Overview Dashboard</a></h4>
<ul>
<li>
<p><strong>API Performance:</strong></p>
<ul>
<li>Request rate (req/sec)</li>
<li>Response time (p50, p95, p99)</li>
<li>Error rate (4xx, 5xx)</li>
</ul>
</li>
<li>
<p><strong>ML Performance:</strong></p>
<ul>
<li>Inference time</li>
<li>GPU utilization</li>
<li>Batch size</li>
<li>Throughput (images/sec)</li>
</ul>
</li>
<li>
<p><strong>Infrastructure:</strong></p>
<ul>
<li>CPU usage по pod'ам</li>
<li>Memory usage</li>
<li>Network I/O</li>
<li>Disk I/O</li>
</ul>
</li>
</ul>
<h4 id="database-dashboard"><a class="header" href="#database-dashboard">Database Dashboard</a></h4>
<ul>
<li>Connection pool size</li>
<li>Query time (p95, p99)</li>
<li>Replication lag</li>
<li>Transaction rate</li>
</ul>
<h4 id="message-queue-dashboard"><a class="header" href="#message-queue-dashboard">Message Queue Dashboard</a></h4>
<ul>
<li>Queue size (ready, unacked)</li>
<li>Publish rate</li>
<li>Consume rate</li>
<li>DLQ size</li>
</ul>
<hr />
<h2 id="5-Безопасность"><a class="header" href="#5-Безопасность">5. Безопасность</a></h2>
<h3 id="network-policies"><a class="header" href="#network-policies">Network Policies</a></h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-policy
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: data-upload
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 8080
</code></pre>
<h3 id="secrets-management"><a class="header" href="#secrets-management">Secrets Management</a></h3>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: database-credentials
type: Opaque
stringData:
  username: medical_user
  password: ${DB_PASSWORD}  # From external secret manager

---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secret
type: Opaque
stringData:
  secret: ${JWT_SECRET_KEY}
  publicKey: ${JWT_PUBLIC_KEY}
</code></pre>
<h3 id="tlsssl"><a class="header" href="#tlsssl">TLS/SSL</a></h3>
<pre><code class="language-yaml">apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-tls-cert
spec:
  secretName: api-tls-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - api.med-diagnosis.com
  - "*.api.med-diagnosis.com"
</code></pre>
<hr />
<h2 id="6-backup--disaster-recovery"><a class="header" href="#6-backup--disaster-recovery">6. Backup &amp; Disaster Recovery</a></h2>
<h3 id="postgresql-backup"><a class="header" href="#postgresql-backup">PostgreSQL Backup</a></h3>
<pre><code class="language-bash">#!/bin/bash
# Daily backup script

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backups/postgres"

# Full backup
pg_dump -U postgres medical_db | gzip &gt; "$BACKUP_DIR/medical_db_$DATE.sql.gz"

# Upload to S3
aws s3 cp "$BACKUP_DIR/medical_db_$DATE.sql.gz" s3://medical-backups/postgres/

# Retention: Keep last 30 days
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +30 -delete
</code></pre>
<h3 id="redis-backup"><a class="header" href="#redis-backup">Redis Backup</a></h3>
<pre><code class="language-bash"># RDB snapshot (configured in redis.conf)
save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# AOF persistence
appendonly yes
appendfsync everysec
</code></pre>
<h3 id="disaster-recovery-plan"><a class="header" href="#disaster-recovery-plan">Disaster Recovery Plan</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Сценарий</th><th>RTO</th><th>RPO</th><th>Процедура</th></tr></thead><tbody>
<tr><td>Single pod failure</td><td>&lt; 1 мин</td><td>0</td><td>Kubernetes auto-restart</td></tr>
<tr><td>Node failure</td><td>&lt; 5 мин</td><td>0</td><td>Pod rescheduling</td></tr>
<tr><td>Zone failure</td><td>&lt; 15 мин</td><td>&lt; 1 мин</td><td>Multi-zone cluster</td></tr>
<tr><td>Database failure</td><td>&lt; 30 мин</td><td>&lt; 5 мин</td><td>Failover to replica</td></tr>
<tr><td>Region failure</td><td>&lt; 2 часа</td><td>&lt; 1 час</td><td>Restore from backup</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="7-cost-optimization"><a class="header" href="#7-cost-optimization">7. Cost Optimization</a></h2>
<h3 id="resource-allocation"><a class="header" href="#resource-allocation">Resource Allocation</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Service</th><th>CPU Request</th><th>CPU Limit</th><th>Memory Request</th><th>Memory Limit</th><th>Estimated Cost/month</th></tr></thead><tbody>
<tr><td>API Gateway (×3)</td><td>500m</td><td>2000m</td><td>512Mi</td><td>2Gi</td><td>$150</td></tr>
<tr><td>ML Inference (×2 GPU)</td><td>2000m</td><td>4000m</td><td>8Gi</td><td>16Gi</td><td>$800</td></tr>
<tr><td>PostgreSQL</td><td>1000m</td><td>2000m</td><td>4Gi</td><td>8Gi</td><td>$200</td></tr>
<tr><td>Redis</td><td>500m</td><td>1000m</td><td>2Gi</td><td>4Gi</td><td>$100</td></tr>
<tr><td>RabbitMQ (×3)</td><td>500m</td><td>1000m</td><td>1Gi</td><td>2Gi</td><td>$150</td></tr>
<tr><td><strong>Total</strong></td><td></td><td></td><td></td><td></td><td><strong>~$1,400/month</strong></td></tr>
</tbody></table>
</div>
<h3 id="optimization-strategies"><a class="header" href="#optimization-strategies">Optimization Strategies</a></h3>
<ol>
<li>
<p><strong>Spot Instances для ML:</strong></p>
<ul>
<li>Use preemptible VMs для non-critical ML inference</li>
<li>Экономия: 60-80%</li>
</ul>
</li>
<li>
<p><strong>Auto-scaling:</strong></p>
<ul>
<li>Scale down ночью (low traffic)</li>
<li>Экономия: 30%</li>
</ul>
</li>
<li>
<p><strong>Reserved Instances:</strong></p>
<ul>
<li>PostgreSQL, Redis на reserved instances</li>
<li>Экономия: 40%</li>
</ul>
</li>
<li>
<p><strong>Object Storage:</strong></p>
<ul>
<li>S3 Intelligent-Tiering для медицинских изображений</li>
<li>Экономия: 50% на storage</li>
</ul>
</li>
</ol>
<hr />
<h2 id="Источники-14"><a class="header" href="#Источники-14">Источники</a></h2>
<ol>
<li>«Kubernetes in Action» Marko Luksa</li>
<li><a href="https://cloud.google.com/architecture">Google Cloud Platform Best Practices</a></li>
<li><a href="https://www.tensorflow.org/tfx/serving/serving_kubernetes">TensorFlow Serving на Kubernetes</a></li>
<li><a href="https://keda.sh/docs/">KEDA Documentation</a></li>
<li><a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="62-customer-journey-map"><a class="header" href="#62-customer-journey-map">6.2. Customer Journey Map</a></h1>
<h2 id="Обзор-1"><a class="header" href="#Обзор-1">Обзор</a></h2>
<p>Customer Journey Map визуализирует путь пациента через систему от регистрации до получения диагноза, включая эмоциональное состояние, боли (pain points) и решения системы.</p>
<hr />
<h2 id="Этапы-взаимодействия"><a class="header" href="#Этапы-взаимодействия">Этапы взаимодействия</a></h2>
<h3 id="Этап-1-Регистрация"><a class="header" href="#Этап-1-Регистрация">Этап 1: Регистрация</a></h3>
<h4 id="Действия-пациента"><a class="header" href="#Действия-пациента">Действия пациента</a></h4>
<ol>
<li>Открывает веб-приложение</li>
<li>Нажимает "Зарегистрироваться"</li>
<li>Заполняет форму (email, пароль, ФИО)</li>
<li>Получает письмо подтверждения</li>
<li>Кликает на ссылку активации</li>
<li>Входит в систему</li>
</ol>
<h4 id="Эмоциональное-состояние"><a class="header" href="#Эмоциональное-состояние">Эмоциональное состояние</a></h4>
<pre><code>Настроение: Нейтральное → Надежда → Тревога (ожидание письма) → Удовлетворение
</code></pre>
<p><strong>Эмоциональный график:</strong></p>
<pre><code class="language-mermaid">graph LR
    S1[Открыл сайт&lt;br/&gt;😐 Уровень: 4]
    S2[Заполнил форму&lt;br/&gt;😊 Уровень: 6]
    S3[Ждёт письмо&lt;br/&gt;😰 Уровень: 3]
    S4[Активировал&lt;br/&gt;😄 Уровень: 9]
    
    S1 --&gt;|Заполнение| S2
    S2 --&gt;|Ожидание| S3
    S3 --&gt;|Активация| S4
    
    style S1 fill:#ffd700,stroke:#ccaa00,stroke-width:2px
    style S2 fill:#90ee90,stroke:#6db86d,stroke-width:2px
    style S3 fill:#ff6b6b,stroke:#cc5555,stroke-width:2px
    style S4 fill:#4caf50,stroke:#3d8b40,stroke-width:2px
</code></pre>
<pre><code>   10 |                                    ●
    9 |                                   /
    8 |                          ●       /
    7 |                         / \     /
    6 |         ●              /   \   /
    5 |        / \            /     \ /
    4 |       /   \          /       ●
    3 |      /     \        /
    2 |     /       \      /
    1 |    ●         \    /
    0 |________________\__/_________________
       Открыл   Заполнил  Ждёт   Активировал
       сайт     форму    письмо    аккаунт
</code></pre>
<h4 id="pain-points-Боли"><a class="header" href="#pain-points-Боли">Pain Points (Боли)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Проблема</th><th>Влияние</th><th>Частота</th></tr></thead><tbody>
<tr><td>Сложная форма регистрации</td><td>Среднее</td><td>15% пользователей</td></tr>
<tr><td>Долгое ожидание письма</td><td>Высокое</td><td>25% пользователей</td></tr>
<tr><td>Письмо попало в спам</td><td>Высокое</td><td>10% пользователей</td></tr>
<tr><td>Неясные требования к паролю</td><td>Низкое</td><td>30% пользователей</td></tr>
</tbody></table>
</div>
<h4 id="Решения-системы"><a class="header" href="#Решения-системы">Решения системы</a></h4>
<ul>
<li>✅ <strong>Простая форма:</strong> Минимум полей (email, пароль, имя)</li>
<li>✅ <strong>Быстрая отправка:</strong> Письмо в течение 30 секунд</li>
<li>✅ <strong>SMS-альтернатива:</strong> Дублирование через SMS (опция)</li>
<li>✅ <strong>Подсказки:</strong> Real-time валидация с подсказками</li>
<li>✅ <strong>Индикатор силы пароля:</strong> Визуальный feedback</li>
</ul>
<h4 id="Метрики"><a class="header" href="#Метрики">Метрики</a></h4>
<ul>
<li><strong>Время регистрации:</strong> Среднее 2 минуты</li>
<li><strong>Conversion rate:</strong> 75% (от начала до активации)</li>
<li><strong>Drop-off rate:</strong> 25% на этапе ожидания письма</li>
</ul>
<hr />
<h3 id="Этап-2-Загрузка-данных"><a class="header" href="#Этап-2-Загрузка-данных">Этап 2: Загрузка данных</a></h3>
<h4 id="Действия-пациента-1"><a class="header" href="#Действия-пациента-1">Действия пациента</a></h4>
<ol>
<li>Нажимает "Загрузить данные"</li>
<li>Выбирает файл рентгена/МРТ</li>
<li>Заполняет описание симптомов</li>
<li>Проверяет предпросмотр изображения</li>
<li>Нажимает "Отправить на анализ"</li>
<li>Получает подтверждение загрузки</li>
</ol>
<h4 id="Эмоциональное-состояние-1"><a class="header" href="#Эмоциональное-состояние-1">Эмоциональное состояние</a></h4>
<pre><code>Настроение: Надежда → Тревога (качество данных) → Напряжение → Облегчение
</code></pre>
<p><strong>Эмоциональный график:</strong></p>
<pre><code>   10 |            
    9 |    ●                         ●
    8 |   / \                       /
    7 |  /   \         ●           /
    6 | /     \       / \         /
    5 |/       \     /   \       /
    4 |         \   /     \     /
    3 |          \ /       \   /
    2 |           ●         \ /
    1 |                      ●
    0 |_______________________________
       Начал  Выбрал  Заполнил  Отправил
             файл    симптомы   данные
</code></pre>
<h4 id="pain-points-Боли-1"><a class="header" href="#pain-points-Боли-1">Pain Points (Боли)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Проблема</th><th>Влияние</th><th>Частота</th></tr></thead><tbody>
<tr><td>Ограничение 10 МБ</td><td>Среднее</td><td>12% пользователей</td></tr>
<tr><td>Неверный формат файла</td><td>Низкое</td><td>8% пользователей</td></tr>
<tr><td>Неясно, что писать в симптомах</td><td>Высокое</td><td>35% пользователей</td></tr>
<tr><td>Долгая загрузка больших файлов</td><td>Среднее</td><td>20% пользователей</td></tr>
</tbody></table>
</div>
<h4 id="Решения-системы-1"><a class="header" href="#Решения-системы-1">Решения системы</a></h4>
<ul>
<li>✅ <strong>Валидация на фронте:</strong> Проверка формата до загрузки</li>
<li>✅ <strong>Drag &amp; Drop:</strong> Удобный интерфейс загрузки</li>
<li>✅ <strong>Предпросмотр:</strong> Показ изображения перед отправкой</li>
<li>✅ <strong>Подсказки по симптомам:</strong> Шаблоны и примеры</li>
<li>✅ <strong>Progress bar:</strong> Индикация загрузки файла</li>
<li>✅ <strong>Сжатие изображений:</strong> Автоматическое уменьшение размера</li>
</ul>
<h4 id="touchpoints-Точки-контакта"><a class="header" href="#touchpoints-Точки-контакта">Touchpoints (Точки контакта)</a></h4>
<ol>
<li><strong>Web UI:</strong> Форма загрузки с drag-and-drop</li>
<li><strong>Backend:</strong> DataUploadController (валидация)</li>
<li><strong>Storage:</strong> AWS S3 (сохранение файла)</li>
<li><strong>Queue:</strong> RabbitMQ (отправка в обработку)</li>
</ol>
<h4 id="Метрики-1"><a class="header" href="#Метрики-1">Метрики</a></h4>
<ul>
<li><strong>Время загрузки:</strong> Среднее 30 секунд</li>
<li><strong>Success rate:</strong> 95%</li>
<li><strong>Error rate:</strong> 5% (в основном неверный формат)</li>
</ul>
<hr />
<h3 id="Этап-3-Ожидание-обработки"><a class="header" href="#Этап-3-Ожидание-обработки">Этап 3: Ожидание обработки</a></h3>
<h4 id="Действия-пациента-2"><a class="header" href="#Действия-пациента-2">Действия пациента</a></h4>
<ol>
<li>Видит статус "Обработка"</li>
<li>Наблюдает за progress bar (0% → 100%)</li>
<li>Получает real-time обновления (WebSocket)</li>
<li>Ждёт завершения (~2-5 секунд)</li>
</ol>
<h4 id="Эмоциональное-состояние-2"><a class="header" href="#Эмоциональное-состояние-2">Эмоциональное состояние</a></h4>
<pre><code>Настроение: Напряжение → Тревога → Нетерпение → Облегчение
</code></pre>
<p><strong>Эмоциональный график:</strong></p>
<pre><code>   10 |                          
    9 |                          ●
    8 |                         /
    7 |                        /
    6 |                       /
    5 |        ●             /
    4 |       / \           /
    3 |      /   \         /
    2 |     /     \       /
    1 |    /       \     /
    0 |___/         \___/_________
       0%    25%    50%   100%
      Начало        Прогресс   Готово
</code></pre>
<h4 id="pain-points-Боли-2"><a class="header" href="#pain-points-Боли-2">Pain Points (Боли)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Проблема</th><th>Влияние</th><th>Частота</th></tr></thead><tbody>
<tr><td>Задержки при высокой нагрузке</td><td>Высокое</td><td>10% случаев</td></tr>
<tr><td>Неясно, что происходит</td><td>Среднее</td><td>20% пользователей</td></tr>
<tr><td>Нет примерного времени</td><td>Низкое</td><td>40% пользователей</td></tr>
<tr><td>Страх ошибки анализа</td><td>Высокое</td><td>60% пользователей</td></tr>
</tbody></table>
</div>
<h4 id="Решения-системы-2"><a class="header" href="#Решения-системы-2">Решения системы</a></h4>
<ul>
<li>✅ <strong>Real-time updates:</strong> WebSocket уведомления каждые 500 мс</li>
<li>✅ <strong>Progress bar:</strong> Визуализация прогресса</li>
<li>✅ <strong>Estimated time:</strong> "Примерное время: 5 секунд"</li>
<li>✅ <strong>Status messages:</strong>
<ul>
<li>"Загрузка изображения..."</li>
<li>"Анализ ResNet-50..."</li>
<li>"Анализ симптомов BERT..."</li>
<li>"Генерация отчёта..."</li>
</ul>
</li>
<li>✅ <strong>GPU кластер:</strong> Быстрая обработка (≤2 сек)</li>
<li>✅ <strong>Кэширование:</strong> Redis для повторных запросов</li>
</ul>
<h4 id="Технические-детали-3"><a class="header" href="#Технические-детали-3">Технические детали</a></h4>
<pre><code class="language-javascript">// WebSocket updates
ws.onmessage = (event) =&gt; {
  const data = JSON.parse(event.data);
  updateProgressBar(data.progress);
  updateStatusMessage(data.message);
};
</code></pre>
<h4 id="Метрики-2"><a class="header" href="#Метрики-2">Метрики</a></h4>
<ul>
<li><strong>Среднее время обработки:</strong> 2.3 секунды</li>
<li><strong>P95 latency:</strong> 4.8 секунды</li>
<li><strong>P99 latency:</strong> 7.2 секунды</li>
<li><strong>Timeout rate:</strong> 0.1%</li>
</ul>
<hr />
<h3 id="Этап-4-Получение-результатов"><a class="header" href="#Этап-4-Получение-результатов">Этап 4: Получение результатов</a></h3>
<h4 id="Действия-пациента-3"><a class="header" href="#Действия-пациента-3">Действия пациента</a></h4>
<ol>
<li>Видит уведомление "Анализ завершён"</li>
<li>Просматривает результаты на экране:
<ul>
<li>Топ-3 диагноза с вероятностями</li>
<li>Heatmap визуализацию</li>
<li>Рекомендации</li>
</ul>
</li>
<li>Скачивает PDF-отчёт</li>
<li>(Опционально) Отправляет в MIS клиники</li>
</ol>
<h4 id="Эмоциональное-состояние-3"><a class="header" href="#Эмоциональное-состояние-3">Эмоциональное состояние</a></h4>
<pre><code>Настроение: Нетерпение → Тревога (чтение результатов) → Доверие/Облегчение
</code></pre>
<p><strong>Эмоциональный график:</strong></p>
<pre><code>   10 |                          ●
    9 |                         /
    8 |                        /
    7 |          ●            /
    6 |         / \          /
    5 |        /   \        /
    4 |       /     \      /
    3 |      /       \    /
    2 |     /         \  /
    1 |    /           \/
    0 |___/_____________\_________
       Ждёт   Видит    Читает  Понял
             результ. диагноз  результат
</code></pre>
<h4 id="pain-points-Боли-3"><a class="header" href="#pain-points-Боли-3">Pain Points (Боли)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Проблема</th><th>Влияние</th><th>Частота</th></tr></thead><tbody>
<tr><td>Сложная медицинская терминология</td><td>Высокое</td><td>70% пользователей</td></tr>
<tr><td>Неясно, что делать дальше</td><td>Высокое</td><td>50% пользователей</td></tr>
<tr><td>Нет доступа к MIS</td><td>Среднее</td><td>30% пользователей</td></tr>
<tr><td>Низкая достоверность (ИИ ошибается)</td><td>Критическое</td><td>2% случаев</td></tr>
</tbody></table>
</div>
<h4 id="Решения-системы-3"><a class="header" href="#Решения-системы-3">Решения системы</a></h4>
<ul>
<li>✅ <strong>Простое объяснение:</strong> Понятные термины + глоссарий</li>
<li>✅ <strong>Confidence score:</strong> Визуальная индикация уверенности</li>
<li>✅ <strong>Heatmap:</strong> Grad-CAM для визуализации решений модели</li>
<li>✅ <strong>Рекомендации:</strong> Конкретные следующие шаги</li>
<li>✅ <strong>Экспорт:</strong> PDF/HTML отчёт для врача</li>
<li>✅ <strong>Интеграция MIS:</strong> REST API для отправки в клинику</li>
<li>✅ <strong>Дисклеймер:</strong> "Результаты ИИ не заменяют консультацию врача"</li>
</ul>
<h4 id="Пример-результата"><a class="header" href="#Пример-результата">Пример результата</a></h4>
<pre><code>┌────────────────────────────────────────┐
│  РЕЗУЛЬТАТЫ ДИАГНОСТИКИ                │
├────────────────────────────────────────┤
│                                        │
│  Топ-3 диагноза:                       │
│                                        │
│  1. Пневмония              95.2%  ████ │
│     Высокая уверенность               │
│                                        │
│  2. Бронхит                3.5%  █     │
│     Низкая уверенность                │
│                                        │
│  3. Норма                  1.3%        │
│     Очень низкая уверенность          │
│                                        │
├────────────────────────────────────────┤
│  Heatmap:                              │
│  [Изображение с выделенными зонами]   │
│                                        │
├────────────────────────────────────────┤
│  Рекомендации:                         │
│  • Срочно обратитесь к пульмонологу   │
│  • Рекомендуется анализ крови         │
│  • Повторный рентген через 2 недели   │
│                                        │
├────────────────────────────────────────┤
│  [Скачать PDF]  [Отправить в клинику] │
└────────────────────────────────────────┘
</code></pre>
<h4 id="Метрики-3"><a class="header" href="#Метрики-3">Метрики</a></h4>
<ul>
<li><strong>Satisfaction score:</strong> 4.5/5</li>
<li><strong>Report download rate:</strong> 85%</li>
<li><strong>MIS integration rate:</strong> 40%</li>
<li><strong>False positive rate:</strong> 2%</li>
</ul>
<hr />
<h3 id="Этап-5-Последующие-действия"><a class="header" href="#Этап-5-Последующие-действия">Этап 5: Последующие действия</a></h3>
<h4 id="Действия-пациента-4"><a class="header" href="#Действия-пациента-4">Действия пациента</a></h4>
<ol>
<li>Сохраняет результаты</li>
<li>Записывается к врачу</li>
<li>Показывает отчёт врачу</li>
<li>(Опционально) Загружает новые данные для отслеживания</li>
</ol>
<h4 id="Эмоциональное-состояние-4"><a class="header" href="#Эмоциональное-состояние-4">Эмоциональное состояние</a></h4>
<pre><code>Настроение: Доверие → Удовлетворённость → Спокойствие
</code></pre>
<h4 id="pain-points-Боли-4"><a class="header" href="#pain-points-Боли-4">Pain Points (Боли)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Проблема</th><th>Влияние</th><th>Частота</th></tr></thead><tbody>
<tr><td>Нет интеграции с записью к врачу</td><td>Среднее</td><td>60%</td></tr>
<tr><td>История анализов неудобная</td><td>Низкое</td><td>25%</td></tr>
<tr><td>Нет напоминаний о повторном визите</td><td>Среднее</td><td>40%</td></tr>
</tbody></table>
</div>
<h4 id="Решения-системы-4"><a class="header" href="#Решения-системы-4">Решения системы</a></h4>
<ul>
<li>✅ <strong>История анализов:</strong> Все предыдущие результаты в профиле</li>
<li>✅ <strong>Сравнение результатов:</strong> Динамика по датам</li>
<li>✅ <strong>Email уведомления:</strong> Напоминания о проверке</li>
<li>✅ <strong>Роли врачей:</strong> Врач может видеть результаты пациента</li>
</ul>
<hr />
<h2 id="Общая-удовлетворённость"><a class="header" href="#Общая-удовлетворённость">Общая удовлетворённость</a></h2>
<h3 id="net-promoter-score-nps"><a class="header" href="#net-promoter-score-nps">Net Promoter Score (NPS)</a></h3>
<pre><code>Насколько вероятно, что вы порекомендуете систему? (0-10)

Promoters (9-10):     65%  ████████████████████████
Passives (7-8):       25%  █████████
Detractors (0-6):     10%  ███

NPS = 65% - 10% = 55 (Excellent)
</code></pre>
<h3 id="Ключевые-метрики"><a class="header" href="#Ключевые-метрики">Ключевые метрики</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Метрика</th><th>Значение</th><th>Цель</th></tr></thead><tbody>
<tr><td>Time to Result</td><td>3.5 мин</td><td>&lt; 5 мин</td></tr>
<tr><td>User Satisfaction</td><td>4.5/5</td><td>&gt; 4.0/5</td></tr>
<tr><td>Completion Rate</td><td>85%</td><td>&gt; 80%</td></tr>
<tr><td>Error Rate</td><td>3%</td><td>&lt; 5%</td></tr>
<tr><td>Return Rate</td><td>40%</td><td>&gt; 30%</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="Эмоциональная-карта-общая"><a class="header" href="#Эмоциональная-карта-общая">Эмоциональная карта (общая)</a></h2>
<pre><code>Общее эмоциональное путешествие:

   10 |           ●                    ●
    9 |          /                    / \
    8 |    ●    /        ●           /   \
    7 |   / \  /        / \         /     \
    6 |  /   \/        /   \       /       \
    5 | /              /     \     /         ●
    4 |/              /       \   /
    3 |              /         \ /
    2 |             /           ●
    1 |            /
    0 |___________/____________________________
       Регистр.  Загрузка  Ожидание  Результат
                  данных   обработки
</code></pre>
<p><strong>Ключевые инсайты:</strong></p>
<ol>
<li><strong>Пик тревоги:</strong> Во время ожидания обработки</li>
<li><strong>Пик удовлетворения:</strong> При получении результатов</li>
<li><strong>Критические моменты:</strong> Ожидание письма активации, чтение диагноза</li>
</ol>
<hr />
<h2 id="Улучшения-на-основе-cjm"><a class="header" href="#Улучшения-на-основе-cjm">Улучшения на основе CJM</a></h2>
<h3 id="Краткосрочные-1-3-месяца"><a class="header" href="#Краткосрочные-1-3-месяца">Краткосрочные (1-3 месяца)</a></h3>
<ol>
<li>✅ Добавить SMS-альтернативу для активации</li>
<li>✅ Улучшить подсказки по заполнению симптомов</li>
<li>✅ Добавить примерное время обработки</li>
</ol>
<h3 id="Среднесрочные-3-6-месяцев"><a class="header" href="#Среднесрочные-3-6-месяцев">Среднесрочные (3-6 месяцев)</a></h3>
<ol>
<li>🔄 Интеграция с системами записи к врачу</li>
<li>🔄 Чат-бот для ответов на вопросы</li>
<li>🔄 Мобильное приложение</li>
</ol>
<h3 id="Долгосрочные-6-12-месяцев"><a class="header" href="#Долгосрочные-6-12-месяцев">Долгосрочные (6-12 месяцев)</a></h3>
<ol>
<li>📅 ИИ-помощник для интерпретации результатов</li>
<li>📅 Персонализированные рекомендации</li>
<li>📅 Интеграция с носимыми устройствами</li>
</ol>
<hr />
<h2 id="Источники-15"><a class="header" href="#Источники-15">Источники</a></h2>
<ol>
<li><a href="https://www.nngroup.com/articles/customer-journey-mapping/">CJM для медицинских сервисов</a></li>
<li>«User Experience in Healthcare» (книга, глава 7)</li>
<li><a href="https://www.servicedesigntoolkit.org/">Service Design Toolkit</a></li>
<li>«Mapping Experiences» Jim Kalbach</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="drawio-example"><a class="header" href="#drawio-example">Drawio Example</a></h1>
<h3 id="Создание-диаграммы"><a class="header" href="#Создание-диаграммы">Создание диаграммы</a></h3>
<ol>
<li>Создайте диаграмму используя <a href="https://app.diagrams.net/">draw.io</a></li>
<li>Сохраните файл в формате <code>.drawio</code> в проект</li>
<li>Добавьте файл в индексацию git и отправьте в github репозиторий</li>
</ol>
<h3 id="Добавление-диаграммы-в-документацию"><a class="header" href="#Добавление-диаграммы-в-документацию">Добавление диаграммы в документацию</a></h3>
<p>Для вставки диаграммы используйте синтаксис из примера ниже, заметете, что необходимо указать ссылку на файл в репозитории.</p>
<p>@drawio{https://github.com/bndroll/mdb/blob/master/src/diagrams/qwe.drawio}</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="md-example"><a class="header" href="#md-example">MD Example</a></h1>
<h3 id="Структура-проекта"><a class="header" href="#Структура-проекта">Структура проекта</a></h3>
<ul>
<li><code>src/</code> - основная директория с контентом
<ul>
<li><code>SUMMARY.md</code> - файл навигации/оглавления</li>
<li>Все остальные <code>.md</code> файлы - страницы документации</li>
</ul>
</li>
</ul>
<h3 id="Расположение-файлов"><a class="header" href="#Расположение-файлов">Расположение файлов</a></h3>
<ul>
<li>Все Markdown файлы должны находиться в директории <code>src/</code>. Рекомендуется ссылаться на md файлы из SUMMARY.md (см. пример в SUMMARY.md).</li>
<li>Изображения и другие ресурсы рекомендуется хранить в релеватных папках <code>src/images</code>, <code>src/diagrams</code> и тд.</li>
</ul>
<h3 id="Локальная-разработка"><a class="header" href="#Локальная-разработка">Локальная разработка</a></h3>
<ol>
<li>Установите MDBook <a href="https://rust-lang.github.io/mdBook/guide/installation.html">инструкция</a></li>
<li>Запустите сервер разработки:</li>
</ol>
<pre><code class="language-bash">mdbook serve --open
</code></pre>
<ol start="3">
<li>Откройте http://localhost:3000 в браузере.</li>
</ol>
<h3 id="Конфигурация-репозитория"><a class="header" href="#Конфигурация-репозитория">Конфигурация репозитория</a></h3>
<ol>
<li>Сделайте fork репозитория <a href="https://github.com/Jho00/system-engineering-playbook">mdb</a></li>
<li>Перейдите в настройки своего github репозитория. Выберите вкладку Actions -&gt; General. Установите "Read and write permissions" в категории Workflow permissions</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="73-swagger-example"><a class="header" href="#73-swagger-example">7.3. Swagger Example</a></h1>
<h3 id="Подготовка-swagger-спецификации"><a class="header" href="#Подготовка-swagger-спецификации">Подготовка Swagger-спецификации</a></h3>
<ol>
<li>Создайте файл спецификации API в формате YAML</li>
<li>Сохраните файл как <code>swagger.yaml</code> в директорию <code>src/swagger/</code></li>
<li>Убедитесь, что спецификация соответствует стандарту OpenAPI 3.0</li>
</ol>
<h3 id="Вставка-спецификации-в-документацию"><a class="header" href="#Вставка-спецификации-в-документацию">Вставка спецификации в документацию</a></h3>
<p>Для вставки спецификации в документацию используйте синтаксис из примера ниже.</p>
<iframe src="swagger/swagger.html" width="100%" height="1500px" style="border:0;" allowfullscreen="allowfullscreen"></iframe>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
